<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†™çœŸä»˜ããƒ¡ãƒ¢å¸³ | PocketPortal</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9V96DZHTH1');</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .outer-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        #map { height: 250px; width: 100%; flex-shrink: 0; border-bottom: 1px solid #ccc; z-index: 10; }
        #timeline { padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .post-card { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 4px; }
        .post-card.highlight { border: 2px solid #2196F3; background: #e3f2fd; }
        .thumb { width: 120px; height: auto; cursor: pointer; border: 1px solid #eee; display: block; margin-bottom: 8px; border-radius: 2px; }
        .memo-text { font-size: 14px; color: #1e293b; font-weight: 500; line-height: 1.5; white-space: pre-wrap; margin-bottom: 10px; }
        .btn-group { display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f1f5f9; }
        .card-btn { font-size: 13px; font-weight: bold; background: none; border: none; cursor: pointer; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 1px solid #ccc;
            display: flex; justify-content: space-around;
            padding: 10px; padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }
        .nav-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; flex: 1; color: #555; }
        .nav-btn span { font-size: 0.6rem; margin-top: 2px; font-weight: bold; }
    </style>
</head>
<body>

<nav class="bg-white border-b border-slate-200 py-3 px-4 flex-shrink-0 flex justify-between items-center">
    <a href="./index.html" class="flex items-center gap-1 font-bold text-blue-700 text-sm">ğŸ  PocketPortal</a>
    <h1 class="text-sm font-bold text-slate-700">å†™çœŸä»˜ããƒ¡ãƒ¢å¸³</h1>
    <a href="./index.html" class="text-[10px] text-slate-400 font-bold hover:text-blue-500">ãƒ„ãƒ¼ãƒ«é›†ã¸</a>
</nav>

<div class="outer-scroll">
    <div id="map"></div>
    <div class="bg-white p-2 border-b border-slate-200 flex gap-2 sticky top-0 z-40">
        <input type="text" id="search-text" oninput="filter()" placeholder="æ¤œç´¢..." class="flex-1 p-2 text-sm border rounded outline-none">
        <select id="tag-list" onchange="filter()" class="p-2 text-sm border rounded bg-slate-50 w-24">
            <option value="">ã‚¿ã‚°</option>
        </select>
    </div>
    <div id="timeline"></div>
</div>

<div class="bottom-nav">
    <button class="nav-btn" onclick="triggerInput('camera')">ğŸ“·<span>ã‚«ãƒ¡ãƒ©</span></button>
    <button class="nav-btn" onclick="triggerInput('folder')">ğŸ“<span>å†™çœŸ</span></button>
    <button class="nav-btn" onclick="addTextMemo()">âœï¸<span>ãƒ†ã‚­ã‚¹ãƒˆ</span></button>
    <button class="nav-btn" onclick="getGPSOnly()">ğŸ“<span>GPS</span></button>
    <button class="nav-btn" onclick="openHelp()">â“<span>ãƒ˜ãƒ«ãƒ—</span></button>
</div>

<div id="help-modal" class="hidden fixed inset-0 bg-black/60 z-[7000] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
        <h3 class="text-xl font-black mb-6 border-b pb-2 text-slate-800">ãƒ˜ãƒ«ãƒ—ãƒ»è¨­å®š</h3>
        
        <section class="mb-8">
            <h4 class="font-bold text-blue-600 mb-2 flex items-center gap-1">ğŸ“– ä½¿ã„æ–¹</h4>
            <ul class="text-xs text-slate-600 space-y-2 list-disc pl-4">
                <li>ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å†™çœŸã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ•ç¨¿ã§ãã¾ã™ã€‚</li>
                <li>æŠ•ç¨¿ã«ã¯è‡ªå‹•ã§ç¾åœ¨ã®ä½æ‰€ã¨ç·¯åº¦çµŒåº¦ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</li>
                <li>åœ°å›³ä¸Šã®ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©²å½“ã®ãƒ¡ãƒ¢ã¸ç§»å‹•ã—ã¾ã™ã€‚</li>
                <li>ãƒ¡ãƒ¢å†…ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆ#æ•£æ­© ãªã©ï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯èƒ½ã§ã™ã€‚</li>
            </ul>
        </section>

        <section class="mb-8">
            <h4 class="font-bold text-blue-600 mb-2 flex items-center gap-1">ğŸ›¡ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿</h4>
            <div class="text-[11px] text-slate-500 bg-slate-50 p-3 rounded-lg leading-relaxed">
                æœ¬ã‚¢ãƒ—ãƒªã§ä¿å­˜ã—ãŸå†™çœŸã‚„ä½ç½®æƒ…å ±ã¯ã€ã™ã¹ã¦<b>ãŠå®¢æ§˜ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆIndexedDBï¼‰</b>ã®ã¿ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚é–²è¦§å¯èƒ½ã§ã™ã€‚
            </div>
        </section>

        <section class="mb-8">
            <h4 class="font-bold text-blue-600 mb-2 flex items-center gap-1">ğŸ“² æ©Ÿç¨®å¤‰æ›´æ™‚ã®æ‰‹é †</h4>
            <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">
                ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ã®ãŸã‚ã€ç«¯æœ«ã‚’å¤‰ãˆã‚‹ã¨æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚æ–°ã—ã„ç«¯æœ«ã¸å¼•ãç¶™ãã«ã¯ä»¥ä¸‹ã®æ‰‹é †ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            </p>
            <ol class="text-[11px] text-slate-600 space-y-2 list-decimal pl-4 mb-4">
                <li>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰<b>ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨HTMLã€</b>ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li>
                <li>ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ç«¯æœ«ã¸é€ã‚Šã¾ã™ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰çµŒç”±ãªã©ï¼‰ã€‚</li>
                <li>æ–°ã—ã„ç«¯æœ«ã§ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚ŒãŸçŠ¶æ…‹ã§é–²è¦§ãƒ»åˆ©ç”¨ã§ãã¾ã™ã€‚</li>
            </ol>
            <button onclick="exportAll()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-md active:scale-95 transition-transform">
                å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ©Ÿç¨®å¤‰ç”¨ï¼‰
            </button>
        </section>

        <button onclick="closeHelp()" class="w-full py-3 border border-slate-200 text-slate-400 font-bold rounded-xl text-sm mt-2">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="input-modal" class="hidden fixed inset-0 bg-black/60 z-[4000] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
        <h3 class="text-lg font-bold mb-4 text-slate-800">ãƒ¡ãƒ¢ã‚’å…¥åŠ›</h3>
        <textarea id="memo-textarea" rows="5" class="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="å†…å®¹ã‚’å…¥åŠ›ï¼ˆæ”¹è¡ŒOKï¼‰ #ã‚¿ã‚°"></textarea>
        <div class="flex gap-3 mt-6">
            <button onclick="closeInputModal()" class="flex-1 py-3 text-slate-400 font-bold text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="submit-memo-btn" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<input type="file" id="file-camera" accept="image/*" capture="camera" onchange="processFile(event)" class="hidden">
<input type="file" id="file-folder" accept="image/*" onchange="processFile(event)" class="hidden">
<div id="loading" class="hidden fixed inset-0 bg-black/50 z-[5000] flex items-center justify-center text-white font-bold text-sm">å‡¦ç†ä¸­...</div>
<div id="overlay" class="hidden fixed inset-0 bg-black/90 z-[6000] flex items-center justify-center" onclick="this.classList.add('hidden')">
    <img id="full-img" class="max-w-[95%] max-h-[95%] shadow-2xl rounded">
</div>

<script>
    let db, map, markers = {}, tempImgData = null;
    const request = indexedDB.open("PocketMemo_vFinal", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("memos", { keyPath: "id" });
    request.onsuccess = e => { db = e.target.result; initMap(); load(); };

    function initMap() {
        map = L.map('map', { zoomControl: true }).setView([35.68, 139.76], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    function triggerInput(type) { document.getElementById(type === 'camera' ? 'file-camera' : 'file-folder').click(); }
    async function processFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('loading').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = e => openInputModal(e.target.result, 'image');
        reader.readAsDataURL(file);
    }
    function addTextMemo() { openInputModal(null, 'text'); }
    function getGPSOnly() { openInputModal(null, 'gps'); }

    function openInputModal(imgData, type) {
        tempImgData = imgData;
        document.getElementById('memo-textarea').value = (type === 'gps') ? "ğŸ“ GPSãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³" : "";
        document.getElementById('input-modal').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('memo-textarea').focus();
    }
    function closeInputModal() { document.getElementById('input-modal').classList.add('hidden'); }
    function openHelp() { document.getElementById('help-modal').classList.remove('hidden'); }
    function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }

    document.getElementById('submit-memo-btn').onclick = async function() {
        const memoText = document.getElementById('memo-textarea').value;
        closeInputModal();
        document.getElementById('loading').classList.remove('hidden');
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            let addr = "ä½æ‰€å–å¾—ä¸­...";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ja`);
                const json = await res.json();
                addr = json.display_name.replace("æ—¥æœ¬, ", "");
            } catch(e) {}
            const entry = { id: Date.now(), img: tempImgData, text: memoText, date: new Date().toLocaleString(), address: addr, lat: latitude, lng: longitude };
            db.transaction("memos", "readwrite").objectStore("memos").add(entry);
            render(entry);
            updateTags();
            map.setView([latitude, longitude], 16);
            document.getElementById('loading').classList.add('hidden');
        }, () => { alert("GPSã‚’ç¢ºèªã—ã¦ãã ã•ã„"); document.getElementById('loading').classList.add('hidden'); }, {enableHighAccuracy: true});
    };

    function load() { 
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => { 
            const memos = e.target.result;
            memos.forEach(render); 
            updateTags();
            if(memos.length > 0) map.setView([memos[memos.length-1].lat, memos[memos.length-1].lng], 15);
        }; 
    }

    function render(entry) {
        const container = document.getElementById('timeline');
        const card = document.createElement('div');
        card.className = 'post-card';
        card.id = `post-${entry.id}`;
        const media = entry.img ? `<img src="${entry.img}" class="thumb" onclick="zoom('${entry.img}')">` : "";
        const saveBtn = entry.img ? `<button onclick="downloadOne(${entry.id})" class="card-btn text-blue-500">ä¿å­˜</button>` : "";
        card.innerHTML = `${media}<div class="info"><div class="flex justify-between items-start mb-1"><span class="text-[10px] text-slate-400 font-bold uppercase">${entry.date}</span><span class="text-[8px] text-blue-400 font-mono">LAT:${entry.lat.toFixed(4)} LNG:${entry.lng.toFixed(4)}</span></div><span class="text-[10px] text-slate-600 block mb-1">ğŸ“ ${entry.address}</span><div class="memo-text">${entry.text}</div></div><div class="btn-group"><button onclick="shareMemo(${entry.id})" class="card-btn text-slate-400">å…±æœ‰</button>${saveBtn}<button onclick="del(${entry.id})" class="card-btn text-red-400">å‰Šé™¤</button></div>`;
        container.insertBefore(card, container.firstChild);
        markers[entry.id] = L.marker([entry.lat, entry.lng]).addTo(map).on('click', () => {
            document.getElementById(`post-${entry.id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.querySelectorAll('.post-card').forEach(c => c.classList.remove('highlight'));
            document.getElementById(`post-${entry.id}`).classList.add('highlight');
        });
    }

    function zoom(src) { document.getElementById('full-img').src = src; document.getElementById('overlay').classList.remove('hidden'); }
    function del(id) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ db.transaction("memos","readwrite").objectStore("memos").delete(id); document.getElementById(`post-${id}`).remove(); if(markers[id]) map.removeLayer(markers[id]); updateTags(); } }
    function downloadOne(id) { db.transaction("memos", "readonly").objectStore("memos").get(id).onsuccess = e => { const a = document.createElement('a'); a.href = e.target.result.img; a.download = `memo_${id}.jpg`; a.click(); }; }
    
    function exportAll() {
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => {
            const data = JSON.stringify(e.target.result);
            const blob = new Blob([document.documentElement.outerHTML.replace('load()', `(function(){let d=${data}; d.forEach(render);})()`) ], {type: 'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "pocket_memo_backup.html"; a.click();
            alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚’æ–°ã—ã„ç«¯æœ«ã§é–‹ãã¨ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚");
        };
    }

    function filter() {
        const q = document.getElementById('search-text').value.toLowerCase();
        const tag = document.getElementById('tag-list').value;
        document.querySelectorAll('.post-card').forEach(card => {
            const content = card.innerText.toLowerCase();
            card.style.display = (content.includes(q) && (tag === "" || content.includes(tag))) ? 'block' : 'none';
        });
    }
    function updateTags() {
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => {
            const tags = new Set();
            e.target.result.forEach(item => { const found = item.text.match(/#(\S+)/g); if (found) found.forEach(t => tags.add(t)); });
            const select = document.getElementById('tag-list');
            select.innerHTML = '<option value="">ã‚¿ã‚°</option>';
            tags.forEach(t => { 
                const opt = document.createElement('option'); opt.value = t; opt.textContent = t.length > 8 ? t.substring(0, 8) + '..' : t; select.appendChild(opt); 
            });
        };
    }
</script>
</body>
</html>