<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†™çœŸä»˜ããƒ¡ãƒ¢å¸³ | PocketPortal</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9V96DZHTH1');</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ§‹é€  */
        .outer-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        #map { height: 250px; width: 100%; flex-shrink: 0; border-bottom: 1px solid #ccc; z-index: 10; }
        #timeline { padding: 10px; display: flex; flex-direction: column; gap: 12px; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .post-card { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 4px; }
        .post-card.highlight { border: 2px solid #2196F3; background: #e3f2fd; }
        
        /* ç”»åƒã‚µãƒ ãƒã‚¤ãƒ« */
        .thumb { width: 120px; height: auto; cursor: pointer; border: 1px solid #eee; display: block; margin-bottom: 8px; border-radius: 2px; }

        /* ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼ˆæ”¹è¡Œå¯¾å¿œï¼‰ */
        .memo-text { font-size: 14px; color: #1e293b; font-weight: 500; line-height: 1.5; white-space: pre-wrap; margin-bottom: 10px; }

        /* ãƒœã‚¿ãƒ³é…ç½®ï¼ˆå³ä¸‹å¯„ã›ï¼‰ */
        .btn-group { display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f1f5f9; }
        .card-btn { font-size: 13px; font-weight: bold; background: none; border: none; cursor: pointer; }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 1px solid #ccc;
            display: flex; justify-content: space-around;
            padding: 10px; padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }
        .nav-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; flex: 1; color: #555; }
        .nav-btn span { font-size: 0.6rem; margin-top: 2px; font-weight: bold; }
    </style>
</head>
<body>

<nav class="bg-white border-b border-slate-200 py-3 px-4 flex-shrink-0 flex justify-between items-center">
    <a href="./index.html" class="flex items-center gap-1 font-bold text-blue-700 text-sm">ğŸ  PocketPortal</a>
    <h1 class="text-sm font-bold text-slate-700">å†™çœŸä»˜ããƒ¡ãƒ¢å¸³</h1>
    <a href="./index.html" class="text-[10px] text-slate-400 font-bold hover:text-blue-500">ãƒ„ãƒ¼ãƒ«é›†ã¸</a>
</nav>

<div class="outer-scroll">
    <div id="map"></div>

    <div class="bg-white p-2 border-b border-slate-200 flex gap-2 sticky top-0 z-40">
        <input type="text" id="search-text" oninput="filter()" placeholder="æ¤œç´¢..." class="flex-1 p-2 text-sm border rounded outline-none focus:border-blue-400">
        <select id="tag-list" onchange="filter()" class="p-2 text-sm border rounded bg-slate-50 w-24">
            <option value="">ã‚¿ã‚°</option>
        </select>
    </div>

    <div id="timeline"></div>

    <div class="w-full flex flex-col items-center py-6 bg-white border-t border-slate-100">
        <p class="text-[8px] text-slate-400 font-bold mb-1 tracking-widest uppercase">Sponsor Link</p>
        <div class="scale-90">
            <script type="text/javascript">rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="300x160";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";</script>
            <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-btn" onclick="triggerInput('camera')">ğŸ“·<span>ã‚«ãƒ¡ãƒ©</span></button>
    <button class="nav-btn" onclick="triggerInput('folder')">ğŸ“<span>å†™çœŸ</span></button>
    <button class="nav-btn" onclick="addTextMemo()">âœï¸<span>ãƒ†ã‚­ã‚¹ãƒˆ</span></button>
    <button class="nav-btn" onclick="getGPSOnly()">ğŸ“<span>GPS</span></button>
    <button class="nav-btn" onclick="openHelp()">â“<span>ãƒ˜ãƒ«ãƒ—</span></button>
</div>

<div id="input-modal" class="hidden fixed inset-0 bg-black/60 z-[4000] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
        <h3 class="text-lg font-bold mb-4 text-slate-800">ãƒ¡ãƒ¢ã‚’å…¥åŠ›</h3>
        <textarea id="memo-textarea" rows="5" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ”¹è¡Œã§ãã¾ã™ï¼‰ #ã‚¿ã‚°ã‚‚OK"></textarea>
        <div class="flex gap-3 mt-6">
            <button onclick="closeInputModal()" class="flex-1 py-3 text-slate-400 font-bold text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="submit-memo-btn" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-100">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<input type="file" id="file-camera" accept="image/*" capture="camera" onchange="processFile(event)" class="hidden">
<input type="file" id="file-folder" accept="image/*" onchange="processFile(event)" class="hidden">
<div id="loading" class="hidden fixed inset-0 bg-black/50 z-[5000] flex items-center justify-center text-white font-bold text-sm">å‡¦ç†ä¸­...</div>
<div id="overlay" class="hidden fixed inset-0 bg-black/90 z-[6000] flex items-center justify-center" onclick="this.classList.add('hidden')">
    <img id="full-img" class="max-w-[95%] max-h-[95%] shadow-2xl rounded">
</div>

<script>
    let db, map, markers = {};
    let tempImgData = null;

    const request = indexedDB.open("PocketMemo_vFinal", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("memos", { keyPath: "id" });
    request.onsuccess = e => { db = e.target.result; initMap(); load(); };

    function initMap() {
        map = L.map('map', { zoomControl: true }).setView([35.68, 139.76], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OSM'
        }).addTo(map);
    }

    function triggerInput(type) { document.getElementById(type === 'camera' ? 'file-camera' : 'file-folder').click(); }

    async function processFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('loading').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = e => openInputModal(e.target.result, 'image');
        reader.readAsDataURL(file);
    }

    function addTextMemo() { openInputModal(null, 'text'); }
    function getGPSOnly() { openInputModal(null, 'gps'); }

    function openInputModal(imgData, type) {
        tempImgData = imgData;
        document.getElementById('memo-textarea').value = (type === 'gps') ? "ğŸ“ GPSãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³" : "";
        document.getElementById('input-modal').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('memo-textarea').focus();
    }

    function closeInputModal() {
        document.getElementById('input-modal').classList.add('hidden');
    }

    // ä¿å­˜å®Ÿè¡Œå‡¦ç†
    document.getElementById('submit-memo-btn').onclick = async function() {
        const memoText = document.getElementById('memo-textarea').value;
        closeInputModal();
        document.getElementById('loading').classList.remove('hidden');
        
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            let addr = "ä½æ‰€å–å¾—ä¸­...";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ja`);
                const json = await res.json();
                addr = json.display_name.replace("æ—¥æœ¬, ", "");
            } catch(e) {}

            const entry = { 
                id: Date.now(), 
                img: tempImgData, 
                text: memoText, 
                date: new Date().toLocaleString(), 
                address: addr, 
                lat: latitude, 
                lng: longitude 
            };
            
            db.transaction("memos", "readwrite").objectStore("memos").add(entry);
            render(entry);
            updateTags();
            map.setView([latitude, longitude], 16);
            document.getElementById('loading').classList.add('hidden');
        }, () => { 
            alert("GPSã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„"); 
            document.getElementById('loading').classList.add('hidden'); 
        }, {enableHighAccuracy: true});
    };

    function load() { 
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => { 
            const memos = e.target.result;
            memos.forEach(render); 
            updateTags();
            // æœ€æ–°ã®ãƒ”ãƒ³ã®ä½ç½®ã«é·ç§»
            if(memos.length > 0) {
                const latest = memos[memos.length - 1];
                map.setView([latest.lat, latest.lng], 15);
            }
        }; 
    }

    function render(entry) {
        const container = document.getElementById('timeline');
        const card = document.createElement('div');
        card.className = 'post-card';
        card.id = `post-${entry.id}`;
        
        const media = entry.img ? `<img src="${entry.img}" class="thumb" onclick="zoom('${entry.img}')">` : "";
        const saveBtn = entry.img ? `<button onclick="downloadOne(${entry.id})" class="card-btn text-blue-500">ä¿å­˜</button>` : "";

        card.innerHTML = `
            ${media}
            <div class="info">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">${entry.date}</span>
                    <span class="text-[8px] text-blue-400 font-mono">LAT:${entry.lat.toFixed(4)} LNG:${entry.lng.toFixed(4)}</span>
                </div>
                <span class="text-[10px] text-slate-600 block mb-1">ğŸ“ ${entry.address}</span>
                <div class="memo-text">${entry.text}</div>
            </div>
            <div class="btn-group">
                <button onclick="shareMemo(${entry.id})" class="card-btn text-slate-400">å…±æœ‰</button>
                ${saveBtn}
                <button onclick="del(${entry.id})" class="card-btn text-red-400">å‰Šé™¤</button>
            </div>
        `;
        container.insertBefore(card, container.firstChild);

        // å…¨ã¦ã®ãƒ”ãƒ³ã‚’åœ°å›³ã«é…ç½®
        const marker = L.marker([entry.lat, entry.lng]).addTo(map).on('click', () => {
            document.getElementById(`post-${entry.id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.querySelectorAll('.post-card').forEach(c => c.classList.remove('highlight'));
            document.getElementById(`post-${entry.id}`).classList.add('highlight');
        });
        markers[entry.id] = marker;
    }

    function zoom(src) { document.getElementById('full-img').src = src; document.getElementById('overlay').classList.remove('hidden'); }
    function openHelp() { if(confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ")) exportAll(); }

    function del(id) { 
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ 
            db.transaction("memos","readwrite").objectStore("memos").delete(id); 
            document.getElementById(`post-${id}`).remove(); 
            if(markers[id]) map.removeLayer(markers[id]); 
            updateTags(); 
        } 
    }

    async function shareMemo(id) {
        db.transaction("memos", "readonly").objectStore("memos").get(id).onsuccess = async e => {
            const item = e.target.result;
            const text = `${item.text}\nğŸ“ ${item.address}`;
            if (item.img && navigator.share) {
                const blob = await (await fetch(item.img)).blob();
                const file = new File([blob], `memo.jpg`, { type: "image/jpeg" });
                navigator.share({ files: [file], text: text });
            } else { navigator.share({ text: text }); }
        };
    }

    function downloadOne(id) {
        db.transaction("memos", "readonly").objectStore("memos").get(id).onsuccess = e => {
            const a = document.createElement('a'); a.href = e.target.result.img; a.download = `memo_${id}.jpg`; a.click();
        };
    }

    function exportAll() {
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => {
            const data = JSON.stringify(e.target.result);
            const blob = new Blob([document.documentElement.outerHTML.replace('load()', `(function(){let d=${data}; d.forEach(render);})()`) ], {type: 'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "memo_backup.html"; a.click();
        };
    }

    function filter() {
        const q = document.getElementById('search-text').value.toLowerCase();
        const tag = document.getElementById('tag-list').value;
        document.querySelectorAll('.post-card').forEach(card => {
            const content = card.innerText.toLowerCase();
            card.style.display = (content.includes(q) && (tag === "" || content.includes(tag))) ? 'block' : 'none';
        });
    }

    function updateTags() {
        db.transaction("memos", "readonly").objectStore("memos").getAll().onsuccess = e => {
            const tags = new Set();
            e.target.result.forEach(item => { const found = item.text.match(/#(\S+)/g); if (found) found.forEach(t => tags.add(t)); });
            const select = document.getElementById('tag-list');
            select.innerHTML = '<option value="">ã‚¿ã‚°</option>';
            tags.forEach(t => { 
                const opt = document.createElement('option'); opt.value = t; 
                opt.textContent = t.length > 8 ? t.substring(0, 8) + '..' : t; 
                select.appendChild(opt); 
            });
        };
    }
</script>
</body>
</html>