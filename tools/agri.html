<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriHelper Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .glass-header { background: rgba(21, 94, 117, 0.9); backdrop-filter: blur(10px); }
        .task-card { transition: all 0.2s ease; border: 1px solid #e2e8f0; }
        .task-card:active { transform: scale(0.98); }
        .custom-scroll::-webkit-scrollbar { display: none; }
        .tab-shadow { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24">

    <header class="glass-header text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center max-w-xl mx-auto">
            <div>
                <h1 class="text-xl font-bold tracking-tight">AgriHelper <span class="text-emerald-400">Pro</span></h1>
                <p id="currentDate" class="text-[10px] opacity-80 uppercase tracking-widest"></p>
            </div>
            <button onclick="exportData()" class="bg-white/20 p-2 rounded-full h-10 w-10 flex items-center justify-center">
                <i class="bi bi-box-arrow-up"></i>
            </button>
        </div>
    </header>

    <main class="p-4 max-w-xl mx-auto space-y-6">
        
        <section class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-slate-400 text-[10px] font-bold uppercase">進行中</p>
                <p id="statActive" class="text-2xl font-black text-slate-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-slate-400 text-[10px] font-bold uppercase">本日の作業</p>
                <p id="statTasks" class="text-2xl font-black text-emerald-600">0</p>
            </div>
        </section>

        <div id="activeList" class="space-y-4">
            </div>

        <div id="emptyState" class="hidden text-center py-20">
            <i class="bi bi-seedling text-6xl text-slate-200"></i>
            <p class="text-slate-400 mt-4">記録がありません。<br>下の「＋」から追加しましょう。</p>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 tab-shadow z-50 safe-area-bottom">
        <div class="max-w-xl mx-auto flex justify-around items-center h-16">
            <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center text-emerald-600">
                <i class="bi bi-grid-fill text-xl"></i>
                <span class="text-[10px]">ホーム</span>
            </button>
            <button onclick="openModal()" class="bg-emerald-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-8 shadow-lg shadow-emerald-200 border-4 border-white">
                <i class="bi bi-plus-lg text-2xl"></i>
            </button>
            <button onclick="importDataClick()" class="flex flex-col items-center text-slate-400">
                <i class="bi bi-arrow-repeat text-xl"></i>
                <span class="text-[10px]">読込</span>
            </button>
        </div>
    </nav>

    <div id="regModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[32px] p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-bold mb-4">新規作付け登録</h2>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 ml-1">品目選択</label>
                    <select id="cropSelect" class="w-full bg-slate-100 border-none rounded-xl p-4 text-lg appearance-none">
                        <option value="tomato">トマト</option>
                        <option value="nasu">ナス</option>
                        <option value="kyuri">キュウリ</option>
                        <option value="kome">お米</option>
                        <option value="mikan">ミカン</option>
                        <option value="custom">-- 自由入力 --</option>
                    </select>
                </div>

                <div id="customNameArea" class="hidden">
                    <input type="text" id="customName" placeholder="野菜・果物名" class="w-full bg-slate-100 border-none rounded-xl p-4 text-lg">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 ml-1">開始日</label>
                        <input type="date" id="startDate" class="w-full bg-slate-100 border-none rounded-xl p-4">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 ml-1">畑・場所</label>
                        <input type="text" id="fieldName" placeholder="A地点" class="w-full bg-slate-100 border-none rounded-xl p-4">
                    </div>
                </div>

                <button onclick="saveRecord()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-100 mt-4">
                    栽培プランを作成
                </button>
                <button onclick="closeModal()" class="w-full text-slate-400 py-2">キャンセル</button>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" class="hidden" onchange="processFile(event)">

    <script>
        const MASTER = {
            "tomato": { name: "トマト", days: 100, tasks: ["苗植え", "支柱立て", "わき芽かき", "追肥", "収穫"] },
            "nasu": { name: "ナス", days: 110, tasks: ["苗植え", "整枝", "追肥", "収穫"] },
            "kyuri": { name: "キュウリ", days: 60, tasks: ["苗植え", "ネット張り", "収穫開始"] },
            "kome": { name: "お米", days: 155, tasks: ["田起こし", "田植え", "中干し", "稲刈り"] },
            "mikan": { name: "ミカン", days: 210, tasks: ["剪定", "開花", "摘果", "収穫"] }
        };

        let db = JSON.parse(localStorage.getItem('agri_mobile_db') || '[]');

        function updateStats() {
            document.getElementById('statActive').innerText = db.length;
            const today = new Date().toISOString().split('T')[0];
            let todayTasks = 0;
            db.forEach(item => {
                item.tasks.forEach(t => { if(t.date === today && !t.isDone) todayTasks++; });
            });
            document.getElementById('statTasks').innerText = todayTasks;
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'long', day:'numeric', weekday:'short'});
        }

        function openModal() { document.getElementById('regModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('regModal').classList.add('hidden'); }

        document.getElementById('cropSelect').addEventListener('change', (e) => {
            document.getElementById('customNameArea').classList.toggle('hidden', e.target.value !== 'custom');
        });

        function saveRecord() {
            const selectVal = document.getElementById('cropSelect').value;
            const customName = document.getElementById('customName').value;
            const field = document.getElementById('fieldName').value;
            const start = document.getElementById('startDate').value;

            if(!start || !field) return alert("日付と場所を入力してください");

            const preset = MASTER[selectVal] || { name: customName || "不明", days: 90, tasks: ["管理", "収穫"] };
            
            const record = {
                id: Date.now(),
                name: preset.name,
                field: field,
                start: start,
                tasks: preset.tasks.map((t, i) => ({
                    name: t,
                    isDone: false,
                    date: calculateDate(start, (preset.days / (preset.tasks.length || 1)) * i)
                }))
            };

            db.unshift(record);
            localStorage.setItem('agri_mobile_db', JSON.stringify(db));
            closeModal();
            render();
        }

        function calculateDate(base, d) {
            const date = new Date(base);
            date.setDate(date.getDate() + d);
            return date.toISOString().split('T')[0];
        }

        function render() {
            const container = document.getElementById('activeList');
            container.innerHTML = "";
            
            if(db.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                updateStats();
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden";
                card.innerHTML = `
                    <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded uppercase">${item.field}</span>
                            <h3 class="font-black text-lg text-slate-800">${item.name}</h3>
                        </div>
                        <button onclick="deleteItem(${item.id})" class="text-slate-300"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="p-2 space-y-1">
                        ${item.tasks.map((t, idx) => `
                            <div onclick="toggleTask(${item.id}, ${idx})" class="task-card flex items-center justify-between p-3 rounded-xl ${t.isDone ? 'bg-slate-50 text-slate-300' : 'bg-white'}">
                                <div class="flex items-center gap-3">
                                    <i class="bi ${t.isDone ? 'bi-check-circle-fill text-emerald-500' : 'bi-circle text-slate-200'} text-xl"></i>
                                    <span class="text-sm font-bold">${t.name}</span>
                                </div>
                                <span class="text-[10px] font-mono">${t.date.replace(/-/g, '/')}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
            updateStats();
        }

        function toggleTask(pId, tIdx) {
            const p = db.find(x => x.id === pId);
            p.tasks[tIdx].isDone = !p.tasks[tIdx].isDone;
            localStorage.setItem('agri_mobile_db', JSON.stringify(db));
            render();
        }

        function deleteItem(id) {
            if(confirm("削除しますか？")) {
                db = db.filter(x => x.id !== id);
                localStorage.setItem('agri_mobile_db', JSON.stringify(db));
                render();
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AgriData_Backup.json`;
            a.click();
        }

        function importDataClick() { document.getElementById('importFile').click(); }

        function processFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                db = JSON.parse(e.target.result);
                localStorage.setItem('agri_mobile_db', JSON.stringify(db));
                render();
                alert("データを読み込みました");
            };
            reader.readAsText(file);
        }

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            render();
        };
    </script>
</body>
</html>

