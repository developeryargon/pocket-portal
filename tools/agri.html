<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriHelper Pro v25</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: #064e3b; color: white; }
        .task-card { background: white; border-radius: 28px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="pb-40">

    <header class="glass-header p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">AgriHelper <span class="text-emerald-400">Pro</span></h1>
                <p id="addrDisplay" class="text-[10px] font-bold opacity-90 truncate max-w-[200px]">和歌山県和歌山市毛見</p>
                <p id="gpsDisplay" class="text-[8px] font-mono opacity-60 italic text-white/70">LAT:34.1667 LON:135.1858</p>
            </div>
            <button onclick="openHelp()" class="text-2xl p-2"><i class="bi bi-gear-wide-connected"></i></button>
        </div>
    </header>

    <main id="mainList" class="p-4 max-w-xl mx-auto space-y-6"></main>

    <div class="fixed bottom-[100px] right-5 z-90">
        <div id="weatherDisplay" class="bg-white text-emerald-700 w-16 h-16 rounded-full shadow-2xl border-4 border-emerald-50 flex flex-col items-center justify-center">
            <span id="weatherIcon" class="text-xl"><i class="bi bi-cloud-sun"></i></span>
            <span id="weatherTemp" class="text-[10px] font-black">--℃</span>
        </div>
    </div>

    <div id="regModal" class="fixed inset-0 modal-overlay z-[150] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-black mb-4 text-emerald-800 italic">新規登録</h2>
            <div class="space-y-4">
                <select id="cropSelect" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none"></select>
                <input type="text" id="varietyInput" placeholder="品種名" class="w-full bg-slate-100 p-4 rounded-2xl">
                <input type="text" id="fieldInput" placeholder="圃場名" class="w-full bg-slate-100 p-4 rounded-2xl">
                
                <div class="bg-emerald-50 p-4 rounded-2xl space-y-3">
                    <p class="text-[11px] font-bold text-emerald-800">日付設定</p>
                    <div class="flex gap-2">
                        <button id="modeStart" onclick="setRegMode('start')" class="flex-1 py-2 rounded-xl text-[10px] font-black bg-emerald-600 text-white">開始日基準</button>
                        <button id="modeEnd" onclick="setRegMode('end')" class="flex-1 py-2 rounded-xl text-[10px] font-black bg-slate-200 text-slate-500">収穫日から逆算</button>
                    </div>
                    <input type="date" id="baseDateInput" class="w-full bg-white p-3 rounded-xl font-bold border-2 border-emerald-100">
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="closeRegModal()" class="flex-1 py-4 font-bold text-slate-400">閉じる</button>
                    <button onclick="saveNewCrop()" class="flex-1 bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg">登録</button>
                </div>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 modal-overlay z-[160] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-6 shadow-2xl">
            <h2 class="text-xl font-black mb-4 italic">作業・状況を記録</h2>
            <textarea id="memoInput" class="w-full bg-slate-100 p-4 rounded-2xl h-40 text-sm mb-4 outline-none" placeholder="記録内容を入力..."></textarea>
            <button onclick="saveAction()" class="w-full bg-emerald-600 text-white font-black py-5 rounded-3xl">記録を保存</button>
            <button onclick="closeAction()" class="w-full py-3 text-slate-400 font-bold">キャンセル</button>
        </div>
    </div>

    <div id="helpModal" class="fixed inset-0 modal-overlay z-[220] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md max-h-[85vh] overflow-y-auto p-8">
            <h2 class="text-2xl font-black mb-6 text-emerald-800 italic border-b-2 border-emerald-100 pb-2">ヘルプ & 設定</h2>
            
            <div class="space-y-6">
                <section class="bg-slate-50 p-5 rounded-[28px] space-y-3 border border-slate-200">
                    <h3 class="font-black text-slate-800 text-sm italic"><i class="bi bi-shield-lock-fill mr-2"></i>データ管理</h3>
                    <p class="text-[10px] text-slate-500 leading-relaxed mb-4">
                        キャッシュが消えても、保存したファイルがあれば復元可能です。<br>
                        <strong>「保存」して「メール送信」</strong>を推奨します。
                    </p>
                    <button onclick="exportAndShare()" class="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-xs shadow-lg mb-2">
                        <i class="bi bi-share-fill mr-2"></i> データを保存・共有(メール等)
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black text-xs shadow-lg">
                        <i class="bi bi-arrow-counterclockwise mr-2"></i> データ復旧 (読み込み)
                    </button>
                    <input type="file" id="importFile" class="hidden" onchange="importData(event)">
                </section>

                <section class="text-xs text-slate-500 space-y-4 leading-relaxed">
                    <h3 class="font-black text-slate-800 italic underline decoration-emerald-500">操作ガイド</h3>
                    <p>・カテゴリー内は<strong>あいうえお順</strong>で自動整理されます。<br>
                       ・<strong>逆算モード</strong>：収穫予定日を入れると、各工程が遡ってセットされます。<br>
                       ・<strong>引継</strong>：昨年のカードを複製し、日付を1年後にスライドします。</p>
                </section>

                <section class="bg-red-50 p-4 rounded-2xl border border-red-100 text-[9px] text-red-700">
                    <p>免責事項：ブラウザのデータ消去により記録が失われる場合があります。必ず「データの共有保存」で外部（メールやドライブ）へ送ってください。本アプリによるいかなる損害も負いかねます。</p>
                </section>
            </div>
            <button onclick="closeHelp()" class="w-full bg-slate-200 text-slate-600 font-black py-4 rounded-2xl mt-6 shadow-md">閉じる</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 border-t z-[100] pb-8 shadow-2xl">
        <div class="max-w-xl mx-auto flex justify-around items-center h-16">
            <button onclick="render()" class="text-emerald-700"><i class="bi bi-house-door-fill text-2xl"></i></button>
            <button onclick="openRegModal()" class="bg-emerald-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-10 shadow-xl border-4 border-white shadow-emerald-200/50"><i class="bi bi-plus-lg text-2xl"></i></button>
            <div class="w-8"></div>
        </div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('agri_v25_db') || '[]');
        let MASTER = { crops: {} };
        let activeId = null, regMode = 'start';
        let config = JSON.parse(localStorage.getItem('agri_config') || '{"lat":34.1667,"lon":135.1858}');

        async function init() {
            document.getElementById('baseDateInput').value = new Date().toISOString().split('T')[0];
            await loadMaster();
            render();
            getWeather();
        }

        async function loadMaster() {
            try {
                const res = await fetch('agri_master.json');
                MASTER = await res.json();
                const sel = document.getElementById('cropSelect');
                sel.innerHTML = '<option value="">-- 作目を選択 --</option>';
                for (let cat in MASTER.crops) {
                    const group = document.createElement('optgroup'); group.label = cat;
                    // あいうえお順ソート
                    const sortedKeys = Object.keys(MASTER.crops[cat]).sort((a,b) => 
                        MASTER.crops[cat][a].name.localeCompare(MASTER.crops[cat][b].name, 'ja')
                    );
                    sortedKeys.forEach(key => {
                        const opt = document.createElement('option');
                        opt.value = `${cat}|${key}`; opt.innerText = MASTER.crops[cat][key].name;
                        group.appendChild(opt);
                    });
                    sel.appendChild(group);
                }
            } catch(e) { }
        }

        async function getWeather() {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current_weather=true`;
            try {
                const res = await fetch(url); const data = await res.json();
                document.getElementById('weatherTemp').innerText = `${Math.round(data.current_weather.temperature)}℃`;
            } catch(e) { }
        }

        function setRegMode(m) {
            regMode = m;
            document.getElementById('modeStart').className = m === 'start' ? 'flex-1 py-2 rounded-xl text-[10px] font-black bg-emerald-600 text-white shadow-inner' : 'flex-1 py-2 rounded-xl text-[10px] font-black bg-slate-200 text-slate-500';
            document.getElementById('modeEnd').className = m === 'end' ? 'flex-1 py-2 rounded-xl text-[10px] font-black bg-emerald-600 text-white shadow-inner' : 'flex-1 py-2 rounded-xl text-[10px] font-black bg-slate-200 text-slate-500';
        }

        function saveNewCrop() {
            const val = document.getElementById('cropSelect').value; if(!val) return;
            const [cat, key] = val.split('|'); const m = MASTER.crops[cat][key];
            const baseDate = new Date(document.getElementById('baseDateInput').value);
            
            let taskData = [];
            if (regMode === 'start') {
                let current = new Date(baseDate);
                taskData = m.tasks.map((t, i) => {
                    const d = new Date(current); d.setDate(d.getDate() + (i * 10)); // 仮の計算
                    return { name: t, date: d.toISOString().split('T')[0], isDone: false };
                });
            } else {
                let current = new Date(baseDate);
                taskData = [...m.tasks].reverse().map((t, i) => {
                    const d = new Date(current); d.setDate(d.getDate() - (i * 10));
                    return { name: t, date: d.toISOString().split('T')[0], isDone: false };
                }).reverse();
            }

            db.unshift({
                id: Date.now(), name: m.name, variety: document.getElementById('varietyInput').value || "標準",
                field: document.getElementById('fieldInput').value || "未指定", season: baseDate.getFullYear(),
                memo: "", tasks: taskData, stamp: `登録: ${new Date().toLocaleString()}`
            });
            save(); render(); closeRegModal();
        }

        function render() {
            const list = document.getElementById('mainList');
            list.innerHTML = db.length ? "" : '<div class="text-center py-24 text-slate-300 font-black italic">記録がありません</div>';
            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "task-card mb-6 animate-in fade-in slide-in-from-bottom-4 duration-300";
                card.innerHTML = `
                    <div class="p-5 bg-emerald-900 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[9px] font-black bg-emerald-700 px-2 py-1 rounded-md mb-1 inline-block">${item.season}年度</span>
                                <h3 class="font-black text-lg">${item.name}</h3>
                                <p class="text-[10px] opacity-60 italic"><i class="bi bi-geo-alt"></i> ${item.field} (${item.variety})</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openRepeat(${item.id})" class="text-[9px] bg-white/10 px-2 py-1 rounded-lg">引継</button>
                                <button onclick="deleteCard(${item.id})" class="opacity-30"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="space-y-2">
                            ${item.tasks.map((t, idx) => `
                                <div onclick="toggleTask(${item.id}, ${idx})" class="flex justify-between items-center p-3 rounded-xl border-2 ${t.isDone?'bg-emerald-50 border-emerald-300 text-emerald-800 shadow-inner':'bg-white border-slate-100 shadow-sm'}">
                                    <span class="text-xs font-bold"><i class="bi ${t.isDone?'bi-check-circle-fill':'bi-circle'} mr-2"></i>${t.name}</span>
                                    <input type="date" value="${t.date}" onchange="updateTaskDate(${item.id}, ${idx}, this.value)" class="text-[10px] bg-transparent border-none font-bold" onclick="event.stopPropagation()">
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="openAction(${item.id})" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-xs font-black shadow-lg">記録メモを残す</button>
                        ${item.memo ? `<div class="bg-amber-50 p-4 rounded-2xl text-[11px] text-slate-600 border border-amber-100 italic leading-relaxed">${item.memo}</div>`:''}
                        ${item.stamp ? `<p class="text-[8px] text-slate-300 text-right">${item.stamp}</p>`:''}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function exportAndShare() {
            const dataStr = JSON.stringify(db, null, 2);
            const fileName = `AgriData_${new Date().toISOString().split('T')[0]}.json`;
            const file = new File([dataStr], fileName, { type: 'application/json' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: 'アグリヘルパー作業データ',
                        text: '本日の農作業バックアップデータです。',
                        files: [file]
                    });
                } catch (e) {
                    // 共有キャンセル時などは通常のダウンロードへ
                    downloadFile(dataStr, fileName);
                }
            } else {
                downloadFile(dataStr, fileName);
                alert("共有機能未対応のため、ダウンロードを実行しました。ファイルをメールに添付して保管してください。");
            }
        }

        function downloadFile(content, name) {
            const blob = new Blob([content], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = name; a.click();
        }

        function importData(e) {
            const r = new FileReader(); 
            r.onload = (f) => { 
                try {
                    db = JSON.parse(f.target.result); 
                    save(); render(); 
                    alert("データ復旧が完了しました！");
                    closeHelp();
                } catch(err) { alert("データの形式が正しくありません。"); }
            };
            r.readAsText(e.target.files[0]);
        }

        function openRepeat(id) {
            const item = JSON.parse(JSON.stringify(db.find(x => x.id === id)));
            item.id = Date.now(); item.season++; item.memo = "";
            item.tasks.forEach(t => { t.isDone = false; let d = new Date(t.date); d.setFullYear(d.getFullYear()+1); t.date=d.toISOString().split('T')[0]; });
            db.unshift(item); save(); render();
        }

        function toggleTask(id, idx) { const i = db.find(x => x.id === id); i.tasks[idx].isDone = !i.tasks[idx].isDone; save(); render(); }
        function updateTaskDate(id, idx, v) { db.find(x => x.id === id).tasks[idx].date = v; save(); }
        function save() { localStorage.setItem('agri_v25_db', JSON.stringify(db)); }
        function openRegModal() { document.getElementById('regModal').classList.remove('hidden'); }
        function closeRegModal() { document.getElementById('regModal').classList.add('hidden'); }
        function openHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
        function deleteCard(id) { if(confirm("削除しますか？")) { db = db.filter(x => x.id !== id); save(); render(); } }
        function openAction(id) { activeId = id; document.getElementById('memoInput').value = db.find(x=>x.id===id).memo; document.getElementById('actionModal').classList.remove('hidden'); }
        function closeAction() { document.getElementById('actionModal').classList.add('hidden'); }
        function saveAction() { db.find(x=>x.id===activeId).memo = document.getElementById('memoInput').value; save(); render(); closeAction(); }

        window.onload = init;
    </script>
</body>
</html>
