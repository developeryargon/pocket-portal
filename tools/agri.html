<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriHelper Pro v20</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: #064e3b; color: white; }
        .task-card { background: white; border-radius: 28px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .memo-display { white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.6; }
        
        /* 完了状態のスタイル変更 */
        .status-done { background: #dcfce7; color: #166534; border-color: #86efac; }
        .status-pending { background: #ffffff; color: #1e293b; }
        
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="pb-36">

    <header class="glass-header p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">AgriHelper <span class="text-emerald-400">Pro</span></h1>
                <p id="gpsDisplay" class="text-[9px] font-mono opacity-70">GPS Loading...</p>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="openHelp()" class="text-xl"><i class="bi bi-question-circle"></i></button>
                <button onclick="exportData()" class="text-xl text-emerald-400"><i class="bi bi-download"></i></button>
            </div>
        </div>
    </header>

    <main id="mainList" class="p-4 max-w-xl mx-auto space-y-6"></main>

    <div id="taskMenu" class="fixed inset-0 modal-overlay z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white rounded-[32px] w-full max-w-xs p-6 space-y-3">
            <h3 id="taskMenuTitle" class="font-black text-center text-slate-500 text-sm mb-4">工程メニュー</h3>
            <button onclick="duplicateTask('before')" class="w-full py-4 bg-slate-50 rounded-2xl font-bold flex items-center justify-center gap-2">
                <i class="bi bi-arrow-up-circle"></i> 前へ複製（割り込み）
            </button>
            <button onclick="duplicateTask('after')" class="w-full py-4 bg-slate-50 rounded-2xl font-bold flex items-center justify-center gap-2">
                <i class="bi bi-arrow-down-circle"></i> 後へ複製
            </button>
            <button onclick="deleteTaskActual()" class="w-full py-4 bg-red-50 text-red-600 rounded-2xl font-bold flex items-center justify-center gap-2">
                <i class="bi bi-trash"></i> 削除
            </button>
            <button onclick="closeTaskMenu()" class="w-full py-2 text-slate-400 font-bold">閉じる</button>
        </div>
    </div>

    <div id="helpModal" class="fixed inset-0 modal-overlay z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md max-h-[85vh] overflow-y-auto p-6">
            <h2 class="text-xl font-black mb-6 text-emerald-800 italic border-b pb-2">ヘルプと管理</h2>
            
            <div class="space-y-6 text-sm">
                <section>
                    <h3 class="font-black text-slate-800 flex items-center gap-2"><i class="bi bi-book"></i> 使いかた</h3>
                    <p class="text-slate-500 text-xs mt-1">・中央の＋ボタンで作目を選んで開始。<br>・工程をタップすると「完了」になります。<br>・工程右の「●●●」から複製や削除ができます。</p>
                </section>

                <section>
                    <h3 class="font-black text-slate-800 flex items-center gap-2"><i class="bi bi-save"></i> データの引き継ぎと保存</h3>
                    <p class="text-slate-500 text-xs mt-1">本アプリはサーバーを持ちません。以下の3点をセットで保管してください。</p>
                    <ul class="mt-2 space-y-1 text-[11px] bg-slate-50 p-3 rounded-xl">
                        <li>1. <b>本体HTML</b> (このファイル)</li>
                        <li>2. <b>agri_master.json</b> (作目データ)</li>
                        <li>3. <b>自身のデータ</b> (右上の下矢印ボタンから保存)</li>
                    </ul>
                </section>

                <section class="bg-red-50 p-4 rounded-2xl border border-red-100">
                    <h3 class="font-black text-red-800 text-xs mb-1 italic">【重要】免責事項</h3>
                    <p class="text-[10px] text-red-700 leading-relaxed">不具合、消失、サービス終了、及び本アプリを利用して生じた如何なる損害も、開発者は一切の責任を負いません。定期的なバックアップを強く推奨します。</p>
                </section>
            </div>
            <button onclick="closeHelp()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl mt-8 shadow-lg">確認しました</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 border-t z-[100] pb-8 shadow-2xl">
        <div class="max-w-xl mx-auto flex justify-around items-center h-16">
            <button onclick="render()" class="text-emerald-700"><i class="bi bi-house-door-fill text-2xl"></i></button>
            <button onclick="openRegModal()" class="bg-emerald-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-10 shadow-xl border-4 border-white"><i class="bi bi-plus-lg text-2xl"></i></button>
            <button onclick="document.getElementById('importInput').click()" class="text-slate-400"><i class="bi bi-cloud-arrow-down-fill text-2xl"></i></button>
        </div>
    </nav>

    <input type="file" id="importInput" class="hidden" onchange="importData(event)">

    <script>
        let db = JSON.parse(localStorage.getItem('agri_v20_db') || '[]');
        let MASTER = { crops: {} };
        let activeId = null; // 操作対象のカードID
        let activeTaskIdx = null; // 操作対象の工程INDEX
        let currentPos = "取得中...";

        // 工程メニュー操作
        function openTaskMenu(itemId, taskIdx) {
            activeId = itemId;
            activeTaskIdx = taskIdx;
            const item = db.find(x => x.id === itemId);
            document.getElementById('taskMenuTitle').innerText = `「${item.tasks[taskIdx].name}」を操作`;
            document.getElementById('taskMenu').classList.remove('hidden');
        }
        function closeTaskMenu() { document.getElementById('taskMenu').classList.add('hidden'); }

        // 工程の複製・削除
        function duplicateTask(direction) {
            const item = db.find(x => x.id === activeId);
            const task = JSON.parse(JSON.stringify(item.tasks[activeTaskIdx]));
            task.isDone = false; // コピー時は未完了にする
            
            if (direction === 'before') {
                item.tasks.splice(activeTaskIdx, 0, task);
            } else {
                item.tasks.splice(activeTaskIdx + 1, 0, task);
            }
            save(); render(); closeTaskMenu();
        }

        function deleteTaskActual() {
            if(!confirm("この工程を削除しますか？")) return;
            const item = db.find(x => x.id === activeId);
            item.tasks.splice(activeTaskIdx, 1);
            save(); render(); closeTaskMenu();
        }

        // 描画処理
        function render() {
            const container = document.getElementById('mainList');
            container.innerHTML = db.length ? "" : '<div class="text-center py-24 text-slate-300 font-black italic">NO RECORDS<br><span class="text-[10px] font-normal">下の＋ボタンから開始</span></div>';
            
            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "task-card mb-6";
                card.innerHTML = `
                    <div class="p-5 bg-emerald-900 text-white flex justify-between items-start">
                        <div>
                            <span class="text-[10px] font-black bg-emerald-700 px-2 py-1 rounded-md">${item.season}年</span>
                            <h3 class="text-lg font-black mt-2">${item.name} <span class="text-xs font-normal opacity-60">${item.variety}</span></h3>
                        </div>
                        <button onclick="openRepeat(${item.id})" class="bg-white/10 p-2 rounded-xl text-xs"><i class="bi bi-arrow-repeat"></i> 引き継ぎ</button>
                    </div>
                    <div class="p-5 space-y-4">
                        ${item.memo ? `<div class="memo-display bg-slate-50 p-4 rounded-2xl text-xs text-slate-600 border border-slate-100">${item.memo}</div>` : ''}
                        
                        <div class="space-y-2">
                            ${item.tasks.map((t, idx) => `
                                <div class="flex items-center gap-2">
                                    <div onclick="toggleTask(${item.id}, ${idx})" class="flex-1 flex justify-between items-center p-3 rounded-2xl border-2 transition-all ${t.isDone ? 'status-done' : 'status-pending shadow-sm'}">
                                        <div class="flex items-center gap-2">
                                            ${t.isDone ? '<i class="bi bi-check-circle-fill text-emerald-600"></i>' : '<i class="bi bi-circle text-slate-200"></i>'}
                                            <span class="text-xs font-bold">${t.name}</span>
                                        </div>
                                        <input type="date" value="${t.date}" onchange="updateDate(${item.id}, ${idx}, this.value)" class="text-[10px] font-mono border-none bg-transparent outline-none" onclick="event.stopPropagation()">
                                    </div>
                                    <button onclick="openTaskMenu(${item.id}, ${idx})" class="text-slate-300 p-2"><i class="bi bi-three-dots-vertical"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="openAction(${item.id})" class="flex-1 bg-slate-900 text-white font-black py-4 rounded-2xl text-xs shadow-lg">記録する</button>
                            <button onclick="deleteCard(${item.id})" class="px-4 text-slate-300"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 以下、既存の基本ロジック(v19準拠) ---
        function toggleTask(id, idx) { db.find(x => x.id === id).tasks[idx].isDone = !db.find(x => x.id === id).tasks[idx].isDone; save(); render(); }
        function save() { localStorage.setItem('agri_v20_db', JSON.stringify(db)); }
        function exportData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `AgriData_${new Date().toISOString().split('T')[0]}.json`; a.click();
        }
        function openHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
        // (省略: openRegModal, saveNewCrop, loadMaster, 等の定型処理)
        window.onload = () => { /* マスタ読込などはここ */ render(); };
    </script>
</body>
</html>

