<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriHelper Pro v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .chip.active { background: #059669; color: white; border-color: #059669; }
        .task-done { background: #f1f5f9; color: #94a3b8; text-decoration: line-through; opacity: 0.7; }
        .stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 20px; padding: 12px; }
        .tab-btn.active { border-bottom: 3px solid #10b981; color: #10b981; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-32">

    <header class="glass-header text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="flex justify-between items-center max-w-xl mx-auto">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">AgriHelper <span class="text-emerald-400">Pro v12</span></h1>
                <p id="headerWeather" class="text-[9px] font-mono opacity-80 uppercase mt-1">Weather Loading...</p>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleFertCalc()" class="text-xl text-yellow-400"><i class="bi bi-calculator"></i></button>
                <button onclick="exportData()" class="text-xl text-emerald-400"><i class="bi bi-share-fill"></i></button>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-xl mx-auto space-y-4">
        <div class="grid grid-cols-3 gap-2">
            <div class="stat-card text-center">
                <p class="text-[8px] font-bold text-slate-400">進行中</p>
                <p id="statActive" class="text-lg font-black">0</p>
            </div>
            <div class="stat-card text-center">
                <p class="text-[8px] font-bold text-slate-400">総収穫量</p>
                <p id="statHarvest" class="text-lg font-black text-emerald-600">0<span class="text-[10px]">kg</span></p>
            </div>
            <div class="stat-card text-center">
                <p class="text-[8px] font-bold text-slate-400">総売上</p>
                <p id="statSales" class="text-lg font-black text-blue-600">¥0</p>
            </div>
        </div>

        <div id="activeList" class="space-y-6"></div>
    </main>

    <div id="actionModal" class="fixed inset-0 bg-slate-900/90 z-[70] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-6 max-h-[90vh] overflow-y-auto">
            <div class="w-16 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex border-b mb-6">
                <button onclick="switchTab('harvest')" id="tab-harvest" class="tab-btn flex-1 py-3 font-black active">収穫/売上</button>
                <button onclick="switchTab('pesticide')" id="tab-pesticide" class="tab-btn flex-1 py-3 font-black">農薬記録</button>
            </div>

            <div id="pane-harvest" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold ml-1">追加収穫量 (kg)</label>
                        <input type="number" id="inputKg" class="w-full bg-slate-100 p-4 rounded-2xl font-black text-xl" placeholder="0.0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold ml-1">今回の売上 (円)</label>
                        <input type="number" id="inputYen" class="w-full bg-slate-100 p-4 rounded-2xl font-black text-xl" placeholder="0">
                    </div>
                </div>
                <button onclick="saveAction('harvest')" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg">記録を更新</button>
            </div>

            <div id="pane-pesticide" class="space-y-4 hidden">
                <input type="text" id="pestName" class="w-full bg-slate-100 p-4 rounded-2xl font-bold" placeholder="農薬名 (例: トレボン乳剤)">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="pestRatio" class="w-full bg-slate-100 p-4 rounded-2xl font-bold" placeholder="希釈倍率 (1000倍)">
                    <input type="date" id="pestDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold">
                </div>
                <button onclick="saveAction('pesticide')" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg">散布履歴を追加</button>
            </div>

            <button onclick="closeAction()" class="w-full text-slate-400 font-bold py-4">閉じる</button>
        </div>
    </div>

    <div id="fertCalc" class="fixed inset-x-4 top-20 bg-white border border-slate-200 rounded-3xl shadow-2xl z-[100] p-6 hidden">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-lg">施肥量計算機</h3>
            <button onclick="toggleFertCalc()"><i class="bi bi-x-lg"></i></button>
        </div>
        <input type="number" id="targetN" placeholder="目標N量(kg/10a)" class="w-full bg-slate-100 p-3 rounded-xl mb-2">
        <input type="number" id="fertN" placeholder="肥料N成分(%)" class="w-full bg-slate-100 p-3 rounded-xl mb-4">
        <button onclick="calcFert()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">計算</button>
        <div id="fertResult" class="mt-4 p-3 bg-emerald-50 text-emerald-800 rounded-xl font-bold text-center hidden"></div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t z-50 pb-[env(safe-area-inset-bottom)]">
        <div class="max-w-xl mx-auto flex justify-around items-center h-20">
            <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center text-emerald-600"><i class="bi bi-house-door-fill text-2xl"></i><span class="text-[10px] font-bold">ホーム</span></button>
            <button onclick="openRegModal()" class="bg-emerald-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-8 shadow-xl border-4 border-white"><i class="bi bi-plus-lg text-2xl"></i></button>
            <button onclick="document.getElementById('importFile').click()" class="flex flex-col items-center text-slate-400"><i class="bi bi-cloud-arrow-down-fill text-2xl"></i><span class="text-[10px] font-bold">読込</span></button>
        </div>
    </nav>

    <div id="regModal" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="w-16 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-black mb-6">新規栽培・区画登録</h2>
            <div class="space-y-4">
                <select id="cropSelect" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none">
                    <option value="tomato">トマト</option><option value="budo">ブドウ</option><option value="jagaimo">ジャガイモ</option><option value="kome">お米</option>
                    <option value="custom">-- 自由登録 --</option>
                </select>
                <input type="text" id="varietyName" placeholder="品種名" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none">
                <input type="text" id="fieldName" placeholder="圃場名" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none">
                <input type="date" id="startDate" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none">
                <button onclick="saveRecord()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg mt-4">栽培開始</button>
                <button onclick="closeRegModal()" class="w-full text-slate-400 font-bold py-2">戻る</button>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" class="hidden" onchange="processFile(event)">

    <script>
        const MASTER = {
            "tomato": { days: 100, tasks: ["定植", "わき芽かき", "追肥", "収穫開始"] },
            "budo": { days: 180, tasks: ["芽かき", "ジベ処理", "袋掛け", "収穫開始"] },
            "default": { days: 90, tasks: ["定植", "管理", "収穫"] }
        };

        let db = JSON.parse(localStorage.getItem('agri_v12_db') || '[]');
        let activeId = null;

        // 1. 基本UI制御
        function openRegModal() { document.getElementById('regModal').classList.remove('hidden'); }
        function closeRegModal() { document.getElementById('regModal').classList.add('hidden'); }
        function openAction(id) { activeId = id; document.getElementById('actionModal').classList.remove('hidden'); }
        function closeAction() { document.getElementById('actionModal').classList.add('hidden'); }
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}`));
            document.querySelectorAll('#pane-harvest, #pane-pesticide').forEach(p => p.classList.toggle('hidden', p.id !== `pane-${t}`));
        }

        // 2. 記録保存ロジック
        function saveRecord() {
            const sel = document.getElementById('cropSelect');
            const variety = document.getElementById('varietyName').value;
            const field = document.getElementById('fieldName').value;
            const start = document.getElementById('startDate').value;
            if(!start || !field) return alert("入力してください");

            const preset = MASTER[sel.value] || MASTER["default"];
            const record = {
                id: Date.now(),
                name: sel.options[sel.selectedIndex].text,
                variety: variety,
                field: field,
                start: start,
                harvestTotal: 0,
                salesTotal: 0,
                pestLogs: [],
                tasks: preset.tasks.map((t, i) => ({
                    name: t, isDone: false,
                    date: calculateDate(start, (preset.days / (preset.tasks.length - 1)) * i)
                }))
            };
            db.unshift(record);
            save(); closeRegModal(); render();
        }

        function saveAction(type) {
            const p = db.find(x => x.id === activeId);
            if(type === 'harvest') {
                p.harvestTotal += parseFloat(document.getElementById('inputKg').value || 0);
                p.salesTotal += parseInt(document.getElementById('inputYen').value || 0);
            } else {
                p.pestLogs.push({
                    name: document.getElementById('pestName').value,
                    ratio: document.getElementById('pestRatio').value,
                    date: document.getElementById('pestDate').value
                });
            }
            save(); closeAction(); render();
        }

        // 3. ユーティリティ
        function calculateDate(base, d) {
            const date = new Date(base);
            date.setDate(date.getDate() + Math.floor(d));
            return date.toISOString().split('T')[0];
        }
        function save() { localStorage.setItem('agri_v12_db', JSON.stringify(db)); }
        function toggleFertCalc() { document.getElementById('fertCalc').classList.toggle('hidden'); }
        function calcFert() {
            const res = (document.getElementById('targetN').value / (document.getElementById('fertN').value / 100)).toFixed(1);
            document.getElementById('fertResult').innerText = `必要量: ${res}kg / 10a`;
            document.getElementById('fertResult').classList.remove('hidden');
        }

        function render() {
            const container = document.getElementById('activeList');
            container.innerHTML = "";
            let [totalKg, totalYen] = [0, 0];

            db.forEach(item => {
                totalKg += item.harvestTotal;
                totalYen += item.salesTotal;
                const card = document.createElement('div');
                card.className = "bg-white rounded-[30px] shadow-sm border border-slate-200 overflow-hidden";
                card.innerHTML = `
                    <div class="p-5 bg-slate-50/80 border-b flex justify-between items-start">
                        <div>
                            <span class="text-[9px] font-black text-emerald-600 bg-white border px-2 py-0.5 rounded-full mr-1">${item.field}</span>
                            <h3 class="font-black text-lg mt-1">${item.name} <small class="text-slate-400 font-medium">${item.variety}</small></h3>
                        </div>
                        <div class="text-right">
                            <p class="text-[14px] font-black text-blue-600">¥${item.salesTotal.toLocaleString()}</p>
                            <p class="text-[10px] font-bold text-slate-400">${item.harvestTotal.toFixed(1)}kg</p>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-3">
                        <div class="flex gap-2">
                            <button onclick="openAction(${item.id})" class="flex-1 bg-emerald-50 text-emerald-700 py-3 rounded-2xl text-xs font-black"><i class="bi bi-plus-circle mr-1"></i>収穫・売上</button>
                            <button onclick="openAction(${item.id}); switchTab('pesticide');" class="flex-1 bg-slate-50 text-slate-700 py-3 rounded-2xl text-xs font-black"><i class="bi bi-shield-check mr-1"></i>農薬記録</button>
                        </div>

                        ${item.pestLogs.length > 0 ? `
                            <div class="bg-yellow-50/50 p-3 rounded-xl border border-yellow-100">
                                <p class="text-[8px] font-black text-yellow-600 uppercase mb-1">Pesticide Log</p>
                                ${item.pestLogs.map(l => `<p class="text-[10px] font-bold text-slate-600">・${l.date} | ${l.name} (${l.ratio})</p>`).join('')}
                            </div>
                        ` : ''}

                        <div class="space-y-1.5 pt-2">
                            ${item.tasks.map((t, idx) => `
                                <div class="flex items-center justify-between p-3 rounded-xl ${t.isDone ? 'task-done' : 'bg-white border border-slate-50 shadow-sm'}" onclick="toggleTask(${item.id}, ${idx})">
                                    <div class="flex items-center gap-3">
                                        <i class="bi ${t.isDone ? 'bi-check-circle-fill text-emerald-500' : 'bi-circle text-slate-200'} text-xl"></i>
                                        <span class="text-[13px] font-black">${t.name}</span>
                                    </div>
                                    <span class="text-[10px] font-mono text-slate-400">${t.date}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            document.getElementById('statActive').innerText = db.length;
            document.getElementById('statHarvest').innerText = totalKg.toFixed(1);
            document.getElementById('statSales').innerText = `¥${totalYen.toLocaleString()}`;
        }

        function toggleTask(pId, tIdx) {
            const p = db.find(x => x.id === pId);
            p.tasks[tIdx].isDone = !p.tasks[tIdx].isDone;
            save(); render();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `AgriHelper_v12_FullBackup.json`; a.click();
        }
        
        function processFile(event) {
            const reader = new FileReader();
            reader.onload = (e) => { db = JSON.parse(e.target.result); save(); render(); alert("復元完了"); };
            reader.readAsText(event.target.files[0]);
        }

        // 天気取得 (Open-Meteo)
        navigator.geolocation.getCurrentPosition(pos => {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
            .then(r => r.json()).then(d => {
                document.getElementById('headerWeather').innerText = `NOW: ${d.current_weather.temperature}°C / Loc: ${pos.coords.latitude.toFixed(2)},${pos.coords.longitude.toFixed(2)}`;
            });
        });

        window.onload = () => { document.getElementById('startDate').value = new Date().toISOString().split('T')[0]; render(); };
    </script>
</body>
</html>
