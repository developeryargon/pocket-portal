<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriHelper Pro v19</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: #064e3b; color: white; }
        .task-card { background: white; border-radius: 28px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .memo-display { white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.6; }
        .task-done { opacity: 0.4; background: #f1f5f9; text-decoration: line-through; }
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); }
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.5; }
    </style>
</head>
<body class="pb-36">

    <header class="glass-header p-4 sticky top-0 z-50">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">AgriHelper <span class="text-emerald-400">Pro</span></h1>
                <p id="gpsDisplay" class="text-[9px] font-mono opacity-70 italic uppercase">GPS Loading...</p>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="openHelp()" class="text-xl opacity-80"><i class="bi bi-question-circle"></i></button>
                <button onclick="exportData()" class="text-xl text-emerald-400"><i class="bi bi-cloud-arrow-up"></i></button>
            </div>
        </div>
    </header>

    <main id="mainList" class="p-4 max-w-xl mx-auto space-y-6"></main>

    <div id="regModal" class="fixed inset-0 modal-overlay z-[150] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-black mb-4 italic text-emerald-800">新規作付け登録</h2>
            <div class="space-y-4">
                <select id="cropSelect" class="w-full bg-slate-100 p-4 rounded-2xl font-bold border-none appearance-none">
                    </select>
                <input type="text" id="varietyInput" placeholder="品種名 (例: 桃太郎)" class="w-full bg-slate-100 p-4 rounded-2xl">
                <input type="text" id="fieldInput" placeholder="圃場名・場所 (例: 西側の畑)" class="w-full bg-slate-100 p-4 rounded-2xl">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-400">開始日:</span>
                    <input type="date" id="startDateInput" class="flex-1 bg-slate-100 p-4 rounded-2xl font-bold">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeRegModal()" class="flex-1 py-4 font-bold text-slate-400">キャンセル</button>
                    <button onclick="saveNewCrop()" class="flex-1 bg-emerald-600 text-white font-black py-4 rounded-2xl">登録する</button>
                </div>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 modal-overlay z-[160] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-6 max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-black mb-4 italic">状況を記録</h2>
            <div class="space-y-4">
                <textarea id="memoInput" class="w-full bg-slate-100 p-4 rounded-2xl h-40 text-sm outline-none" placeholder="作業内容や反省点... (改行可)"></textarea>
                <input type="file" id="photoInput" accept="image/*" class="w-full text-xs text-slate-400">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block mb-1">収穫 (kg)</label>
                        <input type="number" id="kgInput" class="w-full bg-transparent font-black text-lg outline-none" placeholder="0">
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block mb-1">売上 (円)</label>
                        <input type="number" id="yenInput" class="w-full bg-transparent font-black text-lg outline-none" placeholder="0">
                    </div>
                </div>
                <button onclick="saveAction()" class="w-full bg-emerald-600 text-white font-black py-5 rounded-3xl shadow-lg">記録を保存</button>
                <button onclick="closeAction()" class="w-full text-slate-400 font-bold py-2">閉じる</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="fixed inset-0 modal-overlay z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md max-h-[80vh] overflow-y-auto p-8">
            <h2 class="text-xl font-black mb-6 italic text-emerald-800"><i class="bi bi-info-circle-fill"></i> Help & Disclaimer</h2>
            <div class="space-y-4 text-xs leading-relaxed text-slate-600">
                <p><b>データ管理:</b> 記録はブラウザ内に保存されます。アプリの更新や端末変更時に備え、右上の共有アイコンからJSONファイルを保存してください。</p>
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100 text-red-800">
                    <p class="font-black mb-2 uppercase">免責事項</p>
                    <ul class="list-disc ml-4 space-y-1">
                        <li>データの消失や不具合に対し一切の責任を負いません。</li>
                        <li>サービス提供の中断や変更による損害も免責されます。</li>
                        <li>本アプリの情報に基づく農作業の結果を保証しません。</li>
                    </ul>
                </div>
            </div>
            <button onclick="closeHelp()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl mt-8">承諾して閉じる</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t z-[100] pb-8 shadow-2xl">
        <div class="max-w-xl mx-auto flex justify-around items-center h-16">
            <button onclick="render()" class="text-emerald-700"><i class="bi bi-house-door-fill text-2xl"></i></button>
            <button onclick="openRegModal()" class="bg-emerald-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-10 shadow-xl border-4 border-white"><i class="bi bi-plus-lg text-2xl"></i></button>
            <button onclick="document.getElementById('importInput').click()" class="text-slate-400"><i class="bi bi-cloud-arrow-down-fill text-2xl"></i></button>
        </div>
    </nav>

    <input type="file" id="importInput" class="hidden" onchange="importData(event)">

    <script>
        let db = JSON.parse(localStorage.getItem('agri_v19_db') || '[]');
        let MASTER = { crops: {} };
        let activeId = null;
        let currentPos = "N/A";

        // マスタ読込とカテゴリー対応
        async function loadMaster() {
            try {
                const res = await fetch('agri_master.json');
                MASTER = await res.json();
                const select = document.getElementById('cropSelect');
                select.innerHTML = '<option value="">-- 作目を選択 --</option>';
                for (let cat in MASTER.crops) {
                    const group = document.createElement('optgroup');
                    group.label = cat;
                    for (let key in MASTER.crops[cat]) {
                        const opt = document.createElement('option');
                        opt.value = `${cat}|${key}`;
                        opt.innerText = MASTER.crops[cat][key].name;
                        group.appendChild(opt);
                    }
                    select.appendChild(group);
                }
            } catch (e) { console.error("Master missing"); }
        }

        // GPS取得
        navigator.geolocation.getCurrentPosition(p => {
            currentPos = `${p.coords.latitude.toFixed(4)},${p.coords.longitude.toFixed(4)}`;
            document.getElementById('gpsDisplay').innerText = `LOC: ${currentPos}`;
        });

        // 新規登録
        function openRegModal() { document.getElementById('regModal').classList.remove('hidden'); }
        function closeRegModal() { document.getElementById('regModal').classList.add('hidden'); }
        function saveNewCrop() {
            const cropKey = document.getElementById('cropSelect').value;
            if(!cropKey) return;
            const [cat, key] = cropKey.split('|');
            const master = MASTER.crops[cat][key];
            const start = document.getElementById('startDateInput').value || new Date().toISOString().split('T')[0];
            
            const newItem = {
                id: Date.now(),
                name: master.name,
                variety: document.getElementById('varietyInput').value || master.varieties[0],
                field: document.getElementById('fieldInput').value || "指定なし",
                start: start,
                season: new Date(start).getFullYear(),
                location: currentPos,
                memo: "", photo: null, harvestTotal: 0, salesTotal: 0,
                tasks: master.tasks.map((t, i) => {
                    let d = new Date(start);
                    d.setDate(d.getDate() + (i * 14)); // 暫定2週間おき
                    return { name: t, date: d.toISOString().split('T')[0], isDone: false };
                })
            };
            db.unshift(newItem);
            save(); render(); closeRegModal();
        }

        // 記録・写真保存
        function openAction(id) { 
            activeId = id; 
            const item = db.find(x => x.id === id);
            document.getElementById('memoInput').value = item.memo || "";
            document.getElementById('actionModal').classList.remove('hidden'); 
        }
        function closeAction() { document.getElementById('actionModal').classList.add('hidden'); }
        function saveAction() {
            const item = db.find(x => x.id === activeId);
            item.memo = document.getElementById('memoInput').value;
            item.harvestTotal += parseFloat(document.getElementById('kgInput').value || 0);
            item.salesTotal += parseInt(document.getElementById('yenInput').value || 0);
            item.location = currentPos;

            const file = document.getElementById('photoInput').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => { item.photo = e.target.result; finishAction(); };
                reader.readAsDataURL(file);
            } else { finishAction(); }
        }
        function finishAction() { save(); render(); closeAction(); }

        // 工程操作
        function toggleTask(id, idx) { db.find(x => x.id === id).tasks[idx].isDone = !db.find(x => x.id === id).tasks[idx].isDone; save(); render(); }
        function updateDate(id, idx, val) { db.find(x => x.id === id).tasks[idx].date = val; save(); }
        function addTask(id) {
            const name = prompt("工程名を入力");
            if(!name) return;
            db.find(x => x.id === id).tasks.push({name, date: new Date().toISOString().split('T')[0], isDone: false});
            save(); render();
        }

        // 引き継ぎ(翌年コピー)
        function openRepeat(id) {
            const item = JSON.parse(JSON.stringify(db.find(x => x.id === id)));
            item.id = Date.now();
            item.season = parseInt(item.season) + 1;
            item.memo = ""; item.photo = null; item.harvestTotal = 0; item.salesTotal = 0;
            item.tasks.forEach(t => {
                let d = new Date(t.date); d.setFullYear(d.getFullYear() + 1);
                t.date = d.toISOString().split('T')[0]; t.isDone = false;
            });
            db.unshift(item); save(); render();
            alert(`${item.season}年度へ引き継ぎました`);
        }

        // 基本機能
        function render() {
            const container = document.getElementById('mainList');
            container.innerHTML = db.length ? "" : '<p class="text-center text-slate-400 py-20 font-bold">右下の＋から登録してください</p>';
            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "task-card";
                card.innerHTML = `
                    <div class="p-5 bg-emerald-900 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="bg-white/20 px-2 py-1 rounded-lg text-[10px] font-black">${item.season}年</span>
                                <h3 class="text-xl font-black mt-2">${item.name}</h3>
                                <p class="text-xs opacity-60">${item.variety}</p>
                            </div>
                            <button onclick="openRepeat(${item.id})" class="bg-emerald-700 px-3 py-2 rounded-xl text-[10px] font-black italic shadow-inner">翌年へ引継</button>
                        </div>
                        <p class="text-[9px] mt-4 opacity-50 font-mono italic"><i class="bi bi-geo-alt"></i> ${item.field} (${item.location})</p>
                    </div>
                    <div class="p-5 space-y-5">
                        ${item.memo ? `<div class="bg-amber-50 p-4 rounded-2xl memo-display text-amber-900 border border-amber-100 italic font-medium">${item.memo}</div>` : ''}
                        ${item.photo ? `<img src="${item.photo}" class="w-full h-48 object-cover rounded-2xl shadow-inner">` : ''}
                        
                        <div class="space-y-2">
                            ${item.tasks.map((t, idx) => `
                                <div class="flex items-center gap-2 group">
                                    <div onclick="toggleTask(${item.id}, ${idx})" class="flex-1 flex justify-between items-center p-3 rounded-2xl border ${t.isDone ? 'task-done' : 'bg-white shadow-sm'} transition-all">
                                        <span class="text-xs font-black">${t.name}</span>
                                        <input type="date" value="${t.date}" onchange="updateDate(${item.id}, ${idx}, this.value)" class="text-[10px] bg-transparent border-none font-bold" onclick="event.stopPropagation()">
                                    </div>
                                    <button onclick="if(confirm('削除？')) { db.find(x=>x.id===${item.id}).tasks.splice(${idx},1); save(); render(); }" class="text-slate-200 hover:text-red-400 p-2"><i class="bi bi-dash-circle"></i></button>
                                </div>
                            `).join('')}
                            <button onclick="addTask(${item.id})" class="w-full py-3 border-2 border-dashed border-slate-100 rounded-2xl text-[10px] font-black text-slate-300 uppercase">+ 工程を追加</button>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="openAction(${item.id})" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl text-xs font-black shadow-lg">記録・収穫</button>
                            <button onclick="if(confirm('全消去しますか？')){deleteItem(${item.id})}" class="bg-slate-50 text-slate-300 px-4 rounded-2xl hover:text-red-500"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function deleteItem(id) { db = db.filter(x => x.id !== id); save(); render(); }
        function save() { localStorage.setItem('agri_v19_db', JSON.stringify(db)); }
        function exportData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `agri_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
        }
        function importData(e) {
            const r = new FileReader(); r.onload = (f) => { db = JSON.parse(f.target.result); save(); render(); };
            r.readAsText(e.target.files[0]);
        }
        function openHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }

        window.onload = () => { loadMaster(); render(); };
    </script>
</body>
</html>
