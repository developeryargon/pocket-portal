<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1200, initial-scale=1" />
  <title>CSV/TSV ä½•ã§ã‚‚å±‹ PRO | PocketPortal</title>

  <!-- Google tag (gtag.js) : color-picker.html ã¨åŒã˜ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9V96DZHTH1');
  </script>

  <!-- Google AdSense : color-picker.html ã¨åŒã˜ -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

  <!-- åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã -->
  <script src="./papaparse.min.js"></script>
  <script src="./encoding.min.js"></script>

  <style>
    :root{
      --bg:#070A12; --fg:#E9EEFF; --muted:#9AA4C0;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --accent:#7aa0ff;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --ok:#66ffcc;

      --ctl-bg: rgba(255,255,255,.06);
      --ctl-bd: rgba(255,255,255,.14);
      --ctl-bg-2: rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    /* â˜…é‡è¦ï¼šãƒ•ã‚©ãƒ¼ãƒ UIã‚’ãƒ€ãƒ¼ã‚¯ã¨ã—ã¦æã‹ã›ã‚‹ï¼ˆChrome/Edgeã§åŠ¹ãï¼‰ */
    body{ color-scheme: dark; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(120,160,255,.10), transparent 60%),
        var(--bg);
      color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      letter-spacing:.02em;
    }

    /* ===== PocketPortal header (ç°¡æ˜“) ===== */
    .topbar{
      position: sticky; top:0; z-index: 50;
      background: rgba(10,14,26,.78);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .topbar .inner{
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      color: var(--fg);
      text-decoration:none;
    }
    .brand .home{
      display:inline-flex;
      width:30px; height:30px;
      border-radius:10px;
      align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .navlink{
      font-size:12px;
      color: var(--muted);
      text-decoration:none;
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .navlink:hover{ color: var(--fg); border-color: rgba(122,160,255,.35); }

    /* ===== Layout ===== */
    .wrap{max-width:1400px; margin:0 auto; padding:16px}
    h1{font-size:18px; margin:6px 0 14px}
    h2{font-size:14px; margin:0 0 10px; color:var(--muted)}
    .grid{display:grid; gap:12px; grid-template-columns: 600px 1fr;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      min-width:0;
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    /* ===== Controls ===== */
    input, select, button, textarea{
      background: var(--ctl-bg);
      border:1px solid var(--ctl-bd);
      color:var(--fg);
      border-radius:10px;
      padding:10px;
      outline:none;
      width:100%;
    }

    /* â˜…ã“ã“ãŒæœ¬é¡Œï¼šselect / option / multiple ã®è¦‹ãˆæ–¹ã‚’å¼·åˆ¶ */
    select{
      background: var(--ctl-bg-2);
      color: var(--fg);
    }
    /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å€™è£œï¼ˆåŠ¹ãç’°å¢ƒã§ã¯ã“ã‚Œã§é»’ããªã‚‹ï¼‰ */
    select option{
      background: #0b1020;
      color: var(--fg);
    }
    /* è¤‡æ•°é¸æŠãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆdedupeColsï¼‰ã‚’ç¢ºå®Ÿã«é»’ã« */
    select[multiple]{
      background: #0b1020;
      color: var(--fg);
      border-color: rgba(255,255,255,.16);
    }
    select[multiple] option{
      background: #0b1020;
      color: var(--fg);
    }
    /* é¸æŠä¸­ã®è¦–èªæ€§ */
    select option:checked{
      background: rgba(122,160,255,.35);
      color: var(--fg);
    }

    textarea{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
    select, button{cursor:pointer}
    button{
      background: rgba(122,160,255,.14);
      border-color: rgba(122,160,255,.35);
    }
    button.secondary{ background: rgba(255,255,255,.06); border-color: var(--line); }
    button.tiny{ width:auto; padding:7px 10px; border-radius:999px; font-size:12px; }

    .mini{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px; color:var(--muted);
    }
    .pill.ok{border-color: rgba(102,255,204,.35); color: var(--ok)}
    .pill.warn{border-color: rgba(255,204,102,.35); color: var(--warn)}
    .pill.bad{border-color: rgba(255,107,107,.35); color: var(--bad)}
    .split{height:1px; background: var(--line); margin:12px 0}

    .two{display:grid; gap:10px; grid-template-columns: 1fr 1fr;}
    .three{display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr;}

    /* Drop zone */
    .dropzone{
      border: 1px dashed rgba(122,160,255,.45);
      background: rgba(122,160,255,.08);
      border-radius:14px;
      padding:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      user-select:none;
    }
    .dropzone.dragover{
      border-color: rgba(102,255,204,.55);
      background: rgba(102,255,204,.08);
    }

    /* Column list */
    .list{
      max-height:280px;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .colItem{
      display:grid;
      grid-template-columns: 22px 1fr 1fr 34px;
      gap:8px;
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:center;
      min-width:0;
    }
    .colItem:last-child{border-bottom:none}
    .colItem input[type="checkbox"]{width:18px; height:18px}
    .drag{
      width:28px; height:28px; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      cursor:grab;
      user-select:none;
      font-size:14px;
      color:var(--muted);
    }
    .colItem.dragging{opacity:.6}
    .colName{font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .colRename{padding:8px}
    .colIndex{font-size:11px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    /* chips */
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex; gap:8px; align-items:center;
      max-width:100%;
    }
    .chip span{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:520px}
    .chip button{
      width:auto; padding:4px 8px; border-radius:999px; font-size:12px;
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    /* Preview */
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:8px;
      vertical-align:top;
      white-space:nowrap;
      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    th{
      color:var(--muted); font-weight:600; position:sticky; top:0;
      background: rgba(7,10,18,.95); backdrop-filter: blur(4px);
    }
    .tablewrap{overflow:auto; max-height:680px; border:1px solid var(--line); border-radius:12px}

    /* Sponsor */
    .sponsorBox{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .footer{
      padding:18px 0 26px;
      text-align:center;
      color: var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <nav class="topbar">
    <div class="inner">
      <a class="brand" href="../index.html">
        <span class="home">ğŸ </span>
        <span>PocketPortal</span>
      </a>
      <a class="navlink" href="./index.html">Webä¾¿åˆ©ãƒ„ãƒ¼ãƒ«é›†ã¸</a>
    </div>
  </nav>

  <div class="wrap">
    <h1>CSV/TSV ä½•ã§ã‚‚å±‹ PROï¼ˆå®‰å®šç‰ˆï¼šD&Då¯¾å¿œãƒ»åŒæ¢±ãƒ»PCæƒ³å®šï¼‰</h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>1) å–ã‚Šè¾¼ã¿</h2>

        <div id="dropzone" class="dropzone">
          <div>
            <div class="mini"><b>ã“ã“ã«CSV/TSVã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</b>ï¼ˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‰</div>
            <div class="mini">â€» ã‚µãƒ¼ãƒé€ä¿¡ãªã—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã ã‘ã§å‡¦ç†ï¼‰</div>
          </div>
          <div class="mini" id="dropHint">Drop</div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="width:100%">
            <label>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆ.csv / .tsv / .txtï¼‰</label>
            <input id="file" type="file" accept=".csv,.tsv,.txt,text/csv,text/tab-separated-values,text/plain" />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>èª­ã¿è¾¼ã¿æ–‡å­—ã‚³ãƒ¼ãƒ‰</label>
            <select id="inEncoding">
              <option value="utf-8" selected>UTF-8</option>
              <option value="shift_jis">Shift_JIS</option>
              <option value="euc-jp">EUC-JP</option>
              <option value="utf-16le">UTF-16LE</option>
              <option value="utf-16be">UTF-16BE</option>
            </select>
          </div>
          <div>
            <label>èª­ã¿è¾¼ã¿åŒºåˆ‡ã‚Š</label>
            <select id="inDelimiter">
              <option value="auto" selected>è‡ªå‹•æ¨å®š</option>
              <option value=",">ã‚«ãƒ³ãƒ (,)</option>
              <option value="\t">ã‚¿ãƒ– (TSV)</option>
              <option value=";">ã‚»ãƒŸã‚³ãƒ­ãƒ³ (;)</option>
              <option value="|">ãƒ‘ã‚¤ãƒ— (|)</option>
            </select>
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼Ÿ</label>
            <select id="hasHeader">
              <option value="yes" selected>ã¯ã„ï¼ˆ1è¡Œç›®ã‚’é …ç›®åï¼‰</option>
              <option value="no">ã„ã„ãˆï¼ˆcol_1...ã‚’ä»˜ä¸ï¼‰</option>
            </select>
          </div>
          <div>
            <label>ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—</label>
            <select id="skipEmpty">
              <option value="yes" selected>ã¯ã„</option>
              <option value="no">ã„ã„ãˆ</option>
            </select>
          </div>
        </div>

        <div class="split"></div>

        <div class="row">
          <button id="loadBtn">èª­ã¿è¾¼ã¿</button>
          <button id="clearBtn" class="secondary">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="statusPill">æœªèª­ã¿è¾¼ã¿</span>
          <span class="pill" id="metaPill">-</span>
        </div>

        <div class="split"></div>

        <h2>2) åˆ—ï¼ˆæŠ½å‡º / æ”¹å / ä¸¦ã³æ›¿ãˆï¼‰</h2>
        <div class="row">
          <button id="allCols" class="secondary tiny">å…¨é¸æŠ</button>
          <button id="noneCols" class="secondary tiny">å…¨è§£é™¤</button>
          <button id="invertCols" class="secondary tiny">åè»¢</button>
          <button id="resetOrder" class="secondary tiny">é †åºãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div style="margin-top:10px">
          <div class="list" id="colList"></div>
          <div class="mini" style="margin-top:6px">ãƒ‰ãƒ©ãƒƒã‚°ã§åˆ—é †å¤‰æ›´ã€‚ãƒã‚§ãƒƒã‚¯OFFã¯å‡ºåŠ›å¯¾è±¡å¤–ã€‚</div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>No.åˆ—ã‚’å…ˆé ­ã«è¿½åŠ </label>
            <select id="addNo">
              <option value="no" selected>è¿½åŠ ã—ãªã„</option>
              <option value="yes">è¿½åŠ ã™ã‚‹ï¼ˆ1,2,3...ï¼‰</option>
            </select>
          </div>
          <div>
            <label>No.åˆ—å</label>
            <input id="noName" type="text" value="No." />
          </div>
        </div>

        <div class="split"></div>

        <h2>3) ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚° / ç½®æ›</h2>
        <div class="three">
          <div>
            <label>å‰å¾Œç©ºç™½ãƒˆãƒªãƒ ï¼ˆå…¨ã‚»ãƒ«ï¼‰</label>
            <select id="trimAll">
              <option value="no" selected>ã—ãªã„</option>
              <option value="yes">ã™ã‚‹</option>
            </select>
          </div>
          <div>
            <label>ç©ºè¡Œã‚’é™¤å»ï¼ˆå…¨åˆ—ãŒç©ºï¼‰</label>
            <select id="dropEmptyRows">
              <option value="no" selected>ã—ãªã„</option>
              <option value="yes">ã™ã‚‹</option>
            </select>
          </div>
          <div>
            <label>ç©ºåˆ—ã‚’é™¤å»ï¼ˆå‡ºåŠ›å¯¾è±¡ã®ä¸­ã§å…¨è¡ŒãŒç©ºï¼‰</label>
            <select id="dropEmptyOutCols">
              <option value="no" selected>ã—ãªã„</option>
              <option value="yes">ã™ã‚‹</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="two">
            <div>
              <label>ç½®æ›ï¼šæ¤œç´¢</label>
              <input id="findText" placeholder="ä¾‹: ãˆ± / å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ ãªã©" />
            </div>
            <div>
              <label>ç½®æ›ï¼šç½®æ›å¾Œ</label>
              <input id="replaceText" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ / åŠè§’ã‚¹ãƒšãƒ¼ã‚¹" />
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="width:200px">
              <label>æ­£è¦è¡¨ç¾</label>
              <select id="replaceRegex">
                <option value="no" selected>OFF</option>
                <option value="yes">ON</option>
              </select>
            </div>
            <div style="width:260px">
              <label>å¯¾è±¡åˆ—</label>
              <select id="replaceTarget"></select>
            </div>
          </div>
        </div>

        <div class="split"></div>

        <h2>4) ãƒ•ã‚£ãƒ«ã‚¿</h2>
        <div class="row">
          <div style="width:160px">
            <label>çµåˆ</label>
            <select id="filterMode">
              <option value="AND" selected>AND</option>
              <option value="OR">OR</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <select id="filterCol" style="width:220px"></select>
          <select id="filterOp" style="width:220px">
            <option value="eq">=ï¼ˆä¸€è‡´ï¼‰</option>
            <option value="neq">!=ï¼ˆä¸ä¸€è‡´ï¼‰</option>
            <option value="contains" selected>å«ã‚€</option>
            <option value="ncontains">å«ã¾ãªã„</option>
            <option value="starts">å‰æ–¹ä¸€è‡´</option>
            <option value="ends">å¾Œæ–¹ä¸€è‡´</option>
            <option value="regex">æ­£è¦è¡¨ç¾</option>
            <option value="gt">&gt;ï¼ˆæ•°å€¤ï¼‰</option>
            <option value="gte">&gt;=ï¼ˆæ•°å€¤ï¼‰</option>
            <option value="lt">&lt;ï¼ˆæ•°å€¤ï¼‰</option>
            <option value="lte">&lt;=ï¼ˆæ•°å€¤ï¼‰</option>
            <option value="empty">ç©º</option>
            <option value="nempty">ç©ºã§ãªã„</option>
          </select>
          <input id="filterVal" style="width:220px" placeholder="å€¤ï¼ˆregex/æ•°å€¤ï¼‰" />
          <button id="addFilterBtn" class="secondary tiny">è¿½åŠ </button>
          <button id="clearFiltersBtn" class="secondary tiny">å…¨å‰Šé™¤</button>
        </div>

        <div class="chips" style="margin-top:10px" id="filterChips"></div>

        <div class="split"></div>

        <h2>5) ã‚½ãƒ¼ãƒˆ</h2>
        <div class="row">
          <select id="sortCol" style="width:220px"></select>
          <select id="sortDir" style="width:160px">
            <option value="asc" selected>æ˜‡é †</option>
            <option value="desc">é™é †</option>
          </select>
          <select id="sortAs" style="width:160px">
            <option value="text" selected>æ–‡å­—</option>
            <option value="number">æ•°å€¤</option>
          </select>
          <button id="addSortBtn" class="secondary tiny">è¿½åŠ </button>
          <button id="clearSortsBtn" class="secondary tiny">å…¨å‰Šé™¤</button>
        </div>
        <div class="chips" style="margin-top:10px" id="sortChips"></div>

        <div class="split"></div>

        <h2>6) é‡è¤‡å‰Šé™¤</h2>
        <div class="two">
          <div>
            <label>é‡è¤‡å‰Šé™¤</label>
            <select id="dedupeMode">
              <option value="none" selected>ã—ãªã„</option>
              <option value="all">å…¨åˆ—ã§é‡è¤‡å‰Šé™¤</option>
              <option value="bycols">æŒ‡å®šåˆ—ã§é‡è¤‡å‰Šé™¤</option>
            </select>
          </div>
          <div>
            <label>æŒ‡å®šåˆ—ï¼ˆbycolsæ™‚ï¼‰</label>
            <select id="dedupeCols" multiple size="7"></select>
            <div class="mini">Ctrl/Shiftã§è¤‡æ•°é¸æŠï¼ˆç’°å¢ƒã«ã‚ˆã‚Šï¼‰</div>
          </div>
        </div>

        <div class="split"></div>

        <h2>7) å‡ºåŠ›</h2>
        <div class="three">
          <div>
            <label>å‡ºåŠ›åŒºåˆ‡ã‚Š</label>
            <select id="outDelimiter">
              <option value=",">ã‚«ãƒ³ãƒ (,)</option>
              <option value="\t">ã‚¿ãƒ– (TSV)</option>
              <option value=";">ã‚»ãƒŸã‚³ãƒ­ãƒ³ (;)</option>
              <option value="|">ãƒ‘ã‚¤ãƒ— (|)</option>
            </select>
          </div>
          <div>
            <label>å‡ºåŠ›æ–‡å­—ã‚³ãƒ¼ãƒ‰</label>
            <select id="outEncoding">
              <option value="utf-8-bom" selected>UTF-8 with BOMï¼ˆExcelå‘ã‘ï¼‰</option>
              <option value="utf-8">UTF-8ï¼ˆBOMãªã—ï¼‰</option>
              <option value="shift_jis">Shift_JIS</option>
              <option value="euc-jp">EUC-JP</option>
            </select>
          </div>
          <div>
            <label>ãƒ•ã‚¡ã‚¤ãƒ«å</label>
            <input id="outName" value="export.csv" />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>åˆ†å‰²ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</label>
            <select id="splitExport">
              <option value="no" selected>ã—ãªã„</option>
              <option value="yes">ã™ã‚‹ï¼ˆNè¡Œã”ã¨ï¼‰</option>
            </select>
          </div>
          <div>
            <label>åˆ†å‰²ï¼š1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šè¡Œæ•°ï¼ˆãƒ˜ãƒƒãƒ€é™¤ãï¼‰</label>
            <input id="splitRows" type="number" min="100" step="100" value="50000" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="updatePreviewBtn" class="secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
          <button id="copyTSVBtn" class="secondary">æŠ½å‡ºçµæœã‚’TSVã§ã‚³ãƒ”ãƒ¼</button>
          <button id="downloadBtn">æŠ½å‡ºã—ã¦ä¿å­˜</button>
        </div>

        <!-- æ¥½å¤©ã‚¢ãƒ•ã‚£ï¼ˆcolor-picker.html ã‚’å‚è€ƒã«ï¼‰ -->
        <div class="sponsorBox">
          <div class="mini" style="margin-bottom:8px; text-transform:uppercase; letter-spacing:.12em;">Sponsor Link</div>
          <div style="display:flex; justify-content:center;">
            <div style="max-width:640px; width:100%;">
              <script type="text/javascript">
                rakuten_design="slide";
                rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";
                rakuten_items="ctsmatch";
                rakuten_genreId="0";
                rakuten_size="600x200";
                rakuten_target="_blank";
                rakuten_theme="gray";
                rakuten_border="off";
                rakuten_auto_mode="on";
                rakuten_genre_title="off";
                rakuten_recommend="on";
                rakuten_ts="1770130145196";
              </script>
              <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>

              <div style="height:10px"></div>

              <script type="text/javascript">
                rakuten_design="slide";
                rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";
                rakuten_items="ranking";
                rakuten_genreId="0";
                rakuten_size="600x200";
                rakuten_target="_blank";
                rakuten_theme="gray";
                rakuten_border="off";
                rakuten_auto_mode="on";
                rakuten_genre_title="off";
                rakuten_recommend="on";
                rakuten_ts="1770130169366";
              </script>
              <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>

        <div class="two">
          <div>
            <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€å¤§è¡Œæ•°</label>
            <input id="previewMaxRows" type="number" min="10" step="10" value="100" />
          </div>
          <div>
            <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œç´¢ï¼ˆè¡¨ç¤ºä¸­ã ã‘çµã‚‹ï¼‰</label>
            <input id="previewSearch" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="previewPill">-</span>
          <span class="pill" id="transformPill">-</span>
        </div>

        <div class="split"></div>

        <div class="tablewrap">
          <table id="previewTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="footer">Â© 2026 PocketPortal Tools</div>
      </div>
    </div>
  </div>

<script>
(function(){
  function guardLibs(){
    if(typeof Papa === "undefined"){
      alert("PapaParse ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚papaparse.min.js ã‚’ csv.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãã€<script src=\"./papaparse.min.js\"> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      return false;
    }
    if(typeof Encoding === "undefined"){
      alert("Encoding.js ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚encoding.min.js ã‚’ csv.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãã€<script src=\"./encoding.min.js\"> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      return false;
    }
    return true;
  }

  var originalHeaders = [];
  var originalRows = [];
  var columns = [];
  var filters = [];
  var sorts = [];

  function $(id){ return document.getElementById(id); }

  var statusPill = $("statusPill");
  var metaPill = $("metaPill");
  var previewPill = $("previewPill");
  var transformPill = $("transformPill");

  var colList = $("colList");
  var replaceTarget = $("replaceTarget");
  var filterCol = $("filterCol");
  var sortCol = $("sortCol");
  var dedupeCols = $("dedupeCols");

  var filterChips = $("filterChips");
  var sortChips = $("sortChips");

  var thead = $("previewTable").querySelector("thead");
  var tbody = $("previewTable").querySelector("tbody");

  function setPill(el, text, kind){
    el.className = "pill" + (kind ? (" " + kind) : "");
    el.textContent = text;
  }
  function safe(v){ return (v === null || v === undefined) ? "" : String(v); }
  function normalizeDelimiter(v){ return (v === "\\t") ? "\t" : v; }

  function escapeHtml(s){
    var x = safe(s);
    x = x.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    return x;
  }
  function bytesToHuman(b){
    var units = ["B","KB","MB","GB"];
    var x = b, i = 0;
    while(x >= 1024 && i < units.length-1){ x = x/1024; i++; }
    return x.toFixed(i===0?0:2) + " " + units[i];
  }
  function guessDelimiter(text){
    var sampleLines = text.split(/\r\n|\n|\r/).slice(0, 30).filter(function(l){ return l.trim().length > 0; });
    var candidates = [",", "\t", ";", "|"];
    var bestD = ",", bestScore = -1e18;

    for(var ci=0; ci<candidates.length; ci++){
      var d = candidates[ci];
      var counts = [];
      for(var li=0; li<sampleLines.length; li++){
        var line = sampleLines[li].replace(/"([^"]|"")*"/g, "\"\"");
        counts.push(line.split(d).length);
      }
      var sum = 0;
      for(var k=0;k<counts.length;k++) sum += counts[k];
      var avg = sum / Math.max(1, counts.length);

      var varSum = 0;
      for(var k2=0;k2<counts.length;k2++){
        var diff = counts[k2] - avg;
        var varSum2 = diff*diff;
        varSum += varSum2;
      }
      var variance = varSum / Math.max(1, counts.length);
      var score = avg * 10 - variance;
      if(score > bestScore){ bestScore = score; bestD = d; }
    }
    return bestD;
  }

  function readFileAsText(file, encoding){
    return file.arrayBuffer().then(function(buf){
      try{
        var dec = new TextDecoder(encoding, { fatal:false });
        return dec.decode(buf);
      }catch(e){
        var dec2 = new TextDecoder("utf-8", { fatal:false });
        return dec2.decode(buf);
      }
    });
  }

  function getColById(id){
    for(var i=0;i<columns.length;i++){
      if(columns[i].id === id) return columns[i];
    }
    return null;
  }

  function selectedCols(){
    return columns.filter(function(c){ return c.selected; });
  }

  function rebuildSelects(){
    var opts = columns.map(function(c){
      return { v:String(c.id), t:(c.outName || c.name) };
    });

    function fill(sel, withAll){
      sel.innerHTML = "";
      if(withAll){
        var o0 = document.createElement("option");
        o0.value = "__ALL__";
        o0.textContent = "ï¼ˆå…¨åˆ—ï¼‰";
        sel.appendChild(o0);
      }
      for(var i=0;i<opts.length;i++){
        var o = document.createElement("option");
        o.value = opts[i].v;
        o.textContent = opts[i].t;
        sel.appendChild(o);
      }
    }

    fill(replaceTarget, true);
    fill(filterCol, false);
    fill(sortCol, false);

    dedupeCols.innerHTML = "";
    for(var j=0;j<columns.length;j++){
      var op = document.createElement("option");
      op.value = String(columns[j].id);
      op.textContent = columns[j].outName || columns[j].name;
      dedupeCols.appendChild(op);
    }
  }

  function renderColumns(){
    colList.innerHTML = "";
    var frag = document.createDocumentFragment();

    for(var i=0;i<columns.length;i++){
      (function(c, idx){
        var row = document.createElement("div");
        row.className = "colItem";
        row.dataset.colId = String(c.id);

        row.innerHTML =
          '<input type="checkbox" ' + (c.selected ? "checked" : "") + ' data-role="select" />' +
          '<div>' +
            '<div class="colName"><b>' + escapeHtml(c.name) + '</b></div>' +
            '<div class="colIndex">orig:' + c.origIndex + ' / now:' + idx + '</div>' +
          '</div>' +
          '<input class="colRename" data-role="rename" value="' + escapeHtml(c.outName) + '" placeholder="å‡ºåŠ›åˆ—åï¼ˆç©ºãªã‚‰å…ƒåï¼‰" />' +
          '<div class="drag" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ" data-role="drag" draggable="true">::</div>';

        row.querySelector('[data-role="select"]').addEventListener("change", function(e){
          c.selected = !!e.target.checked;
          rebuildSelects();
        });

        row.querySelector('[data-role="rename"]').addEventListener("input", function(e){
          c.outName = e.target.value;
          rebuildSelects();
        });

        var handle = row.querySelector('[data-role="drag"]');
        handle.addEventListener("dragstart", function(e){
          row.classList.add("dragging");
          e.dataTransfer.setData("text/plain", String(c.id));
          e.dataTransfer.effectAllowed = "move";
        });
        handle.addEventListener("dragend", function(){ row.classList.remove("dragging"); });

        row.addEventListener("dragover", function(e){ e.preventDefault(); e.dataTransfer.dropEffect = "move"; });

        row.addEventListener("drop", function(e){
          e.preventDefault();
          var srcId = Number(e.dataTransfer.getData("text/plain"));
          var dstId = Number(row.dataset.colId);
          if(!srcId || !dstId || srcId === dstId) return;

          var si = columns.findIndex(function(x){ return x.id === srcId; });
          var di = columns.findIndex(function(x){ return x.id === dstId; });

          var moved = columns.splice(si, 1)[0];
          columns.splice(di, 0, moved);

          renderColumns();
          rebuildSelects();
        });

        frag.appendChild(row);
      })(columns[i], i);
    }
    colList.appendChild(frag);
  }

  function opLabel(op){
    var m = {
      eq:"=", neq:"!=", contains:"å«ã‚€", ncontains:"å«ã¾ãªã„",
      starts:"å‰æ–¹ä¸€è‡´", ends:"å¾Œæ–¹ä¸€è‡´", regex:"regex",
      gt:">", gte:">=", lt:"<", lte:"<=", empty:"ç©º", nempty:"ç©ºã§ãªã„"
    };
    return m[op] || op;
  }
  function renderFilterChips(){
    filterChips.innerHTML = "";
    for(var i=0;i<filters.length;i++){
      (function(f, idx){
        var col = getColById(f.colId);
        var name = col ? (col.outName || col.name) : "?";
        var label = (name + " " + opLabel(f.op) + " " + safe(f.val)).trim();

        var chip = document.createElement("span");
        chip.className = "chip";

        var span = document.createElement("span");
        span.textContent = label;

        var btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "å‰Šé™¤";
        btn.addEventListener("click", function(){
          filters.splice(idx, 1);
          renderFilterChips();
        });

        chip.appendChild(span);
        chip.appendChild(btn);
        filterChips.appendChild(chip);
      })(filters[i], i);
    }
  }
  function renderSortChips(){
    sortChips.innerHTML = "";
    for(var i=0;i<sorts.length;i++){
      (function(s, idx){
        var col = getColById(s.colId);
        var name = col ? (col.outName || col.name) : "?";
        var label = name + " " + s.dir.toUpperCase() + " (" + s.as + ")";

        var chip = document.createElement("span");
        chip.className = "chip";

        var span = document.createElement("span");
        span.textContent = label;

        var btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "å‰Šé™¤";
        btn.addEventListener("click", function(){
          sorts.splice(idx, 1);
          renderSortChips();
        });

        chip.appendChild(span);
        chip.appendChild(btn);
        sortChips.appendChild(chip);
      })(sorts[i], i);
    }
  }

  function evalFilter(f, row){
    var col = getColById(f.colId);
    if(!col) return true;

    var v = safe(row[col.origIndex]);
    var op = f.op;
    var val = safe(f.val);

    var t = v.toLowerCase();
    var q = val.toLowerCase();

    var numV = Number(v);
    var numQ = Number(val);

    if(op === "eq") return v === val;
    if(op === "neq") return v !== val;
    if(op === "contains") return t.indexOf(q) >= 0;
    if(op === "ncontains") return t.indexOf(q) < 0;
    if(op === "starts") return t.indexOf(q) === 0;
    if(op === "ends") return t.lastIndexOf(q) === (t.length - q.length);
    if(op === "regex"){ try{ return (new RegExp(val)).test(v); }catch(e){ return false; } }
    if(op === "gt") return isFinite(numV) && isFinite(numQ) && numV > numQ;
    if(op === "gte") return isFinite(numV) && isFinite(numQ) && numV >= numQ;
    if(op === "lt") return isFinite(numV) && isFinite(numQ) && numV < numQ;
    if(op === "lte") return isFinite(numV) && isFinite(numQ) && numV <= numQ;
    if(op === "empty") return v.trim() === "";
    if(op === "nempty") return v.trim() !== "";
    return true;
  }

  function multiCompare(rowA, rowB, keyDefs){
    for(var i=0;i<keyDefs.length;i++){
      var k = keyDefs[i];
      var col = getColById(k.colId);
      if(!col) continue;

      var a = safe(rowA[col.origIndex]);
      var b = safe(rowB[col.origIndex]);

      var cmp = 0;
      if(k.as === "number"){
        var na = Number(a), nb = Number(b);
        var fa = isFinite(na), fb = isFinite(nb);
        if(fa && fb) cmp = (na === nb) ? 0 : (na < nb ? -1 : 1);
        else if(fa && !fb) cmp = -1;
        else if(!fa && fb) cmp = 1;
        else cmp = a.localeCompare(b);
      }else{
        cmp = a.localeCompare(b);
      }
      if(cmp !== 0) return (k.dir === "desc") ? -cmp : cmp;
    }
    return 0;
  }

  function applyTransforms(){
    if(!originalHeaders.length) throw new Error("æœªèª­ã¿è¾¼ã¿ã§ã™ã€‚");

    var data = originalRows.map(function(r){ return r.slice(); });
    var steps = [];

    if($("trimAll").value === "yes"){
      data = data.map(function(r){ return r.map(function(c){ return safe(c).trim(); }); });
      steps.push("trim");
    }

    var find = $("findText").value || "";
    if(find.length > 0){
      var rep = $("replaceText").value || "";
      var useRegex = $("replaceRegex").value === "yes";
      var target = $("replaceTarget").value;
      var re = null;

      if(useRegex){ try{ re = new RegExp(find, "g"); }catch(e){ throw new Error("ç½®æ›ï¼šæ­£è¦è¡¨ç¾ãŒç„¡åŠ¹ã§ã™ã€‚"); } }

      function applyToCell(s){
        var str = safe(s);
        return useRegex ? str.replace(re, rep) : str.split(find).join(rep);
      }

      if(target === "__ALL__"){
        data = data.map(function(r){ return r.map(applyToCell); });
      }else{
        var col = getColById(Number(target));
        if(col){
          data = data.map(function(r){
            if(col.origIndex < r.length) r[col.origIndex] = applyToCell(r[col.origIndex]);
            return r;
          });
        }
      }
      steps.push("replace");
    }

    if($("dropEmptyRows").value === "yes"){
      data = data.filter(function(r){
        for(var i=0;i<r.length;i++) if(safe(r[i]).trim() !== "") return true;
        return false;
      });
      steps.push("dropEmptyRows");
    }

    if(filters.length){
      var mode = $("filterMode").value;
      data = data.filter(function(r){
        var evals = filters.map(function(f){ return evalFilter(f, r); });
        if(mode === "AND"){
          for(var i=0;i<evals.length;i++) if(!evals[i]) return false;
          return true;
        }else{
          for(var j=0;j<evals.length;j++) if(evals[j]) return true;
          return false;
        }
      });
      steps.push("filter(" + mode + ")");
    }

    if(sorts.length){
      var defs = sorts.map(function(s){ return {colId:s.colId, dir:s.dir, as:s.as}; });
      data.sort(function(a,b){ return multiCompare(a,b,defs); });
      steps.push("sort(" + sorts.length + ")");
    }

    var sel = selectedCols();
    if(sel.length === 0) throw new Error("å‡ºåŠ›å¯¾è±¡ã®åˆ—ãŒ0ã§ã™ã€‚");

    var outHdr = sel.map(function(c){
      var nm = safe(c.outName).trim();
      return nm ? nm : safe(c.name).trim();
    });

    var outRows = data.map(function(r){
      return sel.map(function(c){ return safe(r[c.origIndex]); });
    });

    if($("dropEmptyOutCols").value === "yes"){
      var keep = [];
      for(var ci=0; ci<outHdr.length; ci++){
        var allEmpty = true;
        for(var ri=0; ri<outRows.length; ri++){
          if(safe(outRows[ri][ci]).trim() !== ""){ allEmpty = false; break; }
        }
        if(!allEmpty) keep.push(ci);
      }
      outHdr = keep.map(function(i){ return outHdr[i]; });
      outRows = outRows.map(function(rr){ return keep.map(function(i){ return rr[i]; }); });
      steps.push("dropEmptyOutCols");
    }

    var dedupeMode = $("dedupeMode").value;
    if(dedupeMode !== "none"){
      var keyIdxs = [];
      if(dedupeMode === "all"){
        for(var ii=0; ii<outHdr.length; ii++) keyIdxs.push(ii);
      }else{
        var selected = Array.from(dedupeCols.selectedOptions).map(function(o){ return Number(o.value); });
        if(selected.length === 0) throw new Error("é‡è¤‡å‰Šé™¤: æŒ‡å®šåˆ—ãŒæœªé¸æŠã§ã™ã€‚");

        var outIds = sel.map(function(c){ return c.id; });
        for(var k=0;k<selected.length;k++){
          var pos = outIds.indexOf(selected[k]);
          if(pos >= 0) keyIdxs.push(pos);
        }
        if(keyIdxs.length === 0) throw new Error("é‡è¤‡å‰Šé™¤: æŒ‡å®šåˆ—ãŒå‡ºåŠ›å¯¾è±¡ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }

      var seen = new Set();
      var ded = [];
      for(var rrI=0; rrI<outRows.length; rrI++){
        var rr = outRows[rrI];
        var parts = [];
        for(var ki=0; ki<keyIdxs.length; ki++) parts.push(safe(rr[keyIdxs[ki]]));
        var key = parts.join("\u0001");
        if(seen.has(key)) continue;
        seen.add(key);
        ded.push(rr);
      }
      outRows = ded;
      steps.push("dedupe(" + dedupeMode + ")");
    }

    if($("addNo").value === "yes"){
      var nn = safe($("noName").value).trim() || "No.";
      outHdr = [nn].concat(outHdr);
      outRows = outRows.map(function(r,i){ return [String(i+1)].concat(r); });
      steps.push("No");
    }

    return { headers: outHdr, rows: outRows, steps: steps };
  }

  function renderPreview(headers, rows){
    thead.innerHTML = "";
    tbody.innerHTML = "";

    var trh = document.createElement("tr");
    for(var i=0;i<headers.length;i++){
      var th = document.createElement("th");
      th.innerHTML = escapeHtml(headers[i]);
      trh.appendChild(th);
    }
    thead.appendChild(trh);

    var search = safe($("previewSearch").value).toLowerCase().trim();
    var maxRows = Math.max(10, Number($("previewMaxRows").value || 100));

    var shown = 0;
    for(var r=0; r<rows.length && shown < maxRows; r++){
      var row = rows[r];

      if(search){
        var hit = false;
        for(var c=0;c<row.length;c++){
          if(safe(row[c]).toLowerCase().indexOf(search) >= 0){ hit = true; break; }
        }
        if(!hit) continue;
      }

      var tr = document.createElement("tr");
      for(var c2=0;c2<row.length;c2++){
        var td = document.createElement("td");
        td.innerHTML = escapeHtml(row[c2]);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      shown++;
    }

    setPill(previewPill, "è¡¨ç¤º: " + shown + "è¡Œ / " + headers.length + "åˆ—ï¼ˆå…¨" + rows.length + "è¡Œï¼‰", "");
  }

  function updatePreview(){
    var t0 = performance.now();
    var obj = applyTransforms();
    renderPreview(obj.headers, obj.rows);
    var dt = Math.round(performance.now() - t0);
    var steps = obj.steps.length ? obj.steps.join(" -> ") : "ãªã—";
    setPill(transformPill, "å¤‰æ›: " + steps + " / " + dt + "ms", obj.steps.length ? "ok" : "");
  }

  function rowsToDelimitedText(headers, rows, delimiter){
    return Papa.unparse([headers].concat(rows), {
      delimiter: delimiter,
      quotes: false,
      quoteChar: '"',
      escapeChar: '"',
      newline: "\r\n",
      skipEmptyLines: false
    });
  }

  function makeBlob(text, outEnc){
    if(outEnc === "utf-8-bom") return new Blob(["\uFEFF" + text], { type:"text/plain;charset=utf-8" });
    if(outEnc === "utf-8") return new Blob([text], { type:"text/plain;charset=utf-8" });

    if(outEnc === "shift_jis" || outEnc === "euc-jp"){
      var unicodeArray = Encoding.stringToCode(text);
      var converted = Encoding.convert(unicodeArray, { to: (outEnc === "shift_jis") ? "SJIS" : "EUCJP", from:"UNICODE" });
      return new Blob([new Uint8Array(converted)], { type:"application/octet-stream" });
    }
    return new Blob([text], { type:"text/plain;charset=utf-8" });
  }

  function downloadBlob(blob, filename){
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ URL.revokeObjectURL(a.href); }, 2000);
  }

  function doDownload(){
    var obj = applyTransforms();
    var outDel = normalizeDelimiter($("outDelimiter").value);
    var outEnc = $("outEncoding").value;
    var baseName = safe($("outName").value).trim() || "export.csv";

    var split = $("splitExport").value === "yes";
    if(!split){
      var text = rowsToDelimitedText(obj.headers, obj.rows, outDel);
      var blob = makeBlob(text, outEnc);
      downloadBlob(blob, baseName);
      return;
    }

    var per = Math.max(100, Number($("splitRows").value || 50000));
    var total = obj.rows.length;
    var parts = Math.ceil(total / per);

    var dot = baseName.lastIndexOf(".");
    var name = (dot >= 0) ? baseName.slice(0, dot) : baseName;
    var ext = (dot >= 0) ? baseName.slice(dot) : ".csv";

    for(var p=0;p<parts;p++){
      var chunk = obj.rows.slice(p*per, (p+1)*per);
      var text2 = rowsToDelimitedText(obj.headers, chunk, outDel);
      var blob2 = makeBlob(text2, outEnc);
      var fn = name + "_part" + String(p+1).padStart(3,"0") + ext;
      downloadBlob(blob2, fn);
    }
  }

  function copyAsTSV(){
    var obj = applyTransforms();
    var text = rowsToDelimitedText(obj.headers, obj.rows, "\t");
    return navigator.clipboard.writeText(text).then(function(){
      alert("TSVã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    }).catch(function(){
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPS/æ¨©é™åˆ¶ç´„ã®å¯èƒ½æ€§ï¼‰ã€‚");
    });
  }

  function loadFromFile(file){
    if(!file){ alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return Promise.resolve(); }
    if(!guardLibs()) return Promise.resolve();

    setPill(statusPill, "èª­ã¿è¾¼ã¿ä¸­...", "warn");
    setPill(metaPill, file.name + " / " + bytesToHuman(file.size), "");

    var enc = $("inEncoding").value;
    return readFileAsText(file, enc).then(function(text){
      var inDelRaw = $("inDelimiter").value;
      var delim = (inDelRaw === "auto") ? guessDelimiter(text) : normalizeDelimiter(inDelRaw);

      var skipEmpty = ($("skipEmpty").value === "yes");
      var hasHeader = ($("hasHeader").value === "yes");

      var parsed = Papa.parse(text, {
        delimiter: delim,
        skipEmptyLines: skipEmpty,
        quoteChar: '"',
        escapeChar: '"',
        dynamicTyping: false
      });

      var data = (parsed.data || []).filter(function(r){
        if(!Array.isArray(r)) return false;
        for(var i=0;i<r.length;i++) if(safe(r[i]).trim() !== "") return true;
        return false;
      });

      if(data.length === 0){
        setPill(statusPill, "ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™", "bad");
        return;
      }

      if(hasHeader){
        originalHeaders = (data[0] || []).map(function(x,i){ var s = safe(x); return s ? s : ("col_" + (i+1)); });
        originalRows = data.slice(1).map(function(r){ return r.map(function(c){ return safe(c); }); });
      }else{
        var maxCols = 0;
        for(var i2=0;i2<data.length;i2++) if(data[i2].length > maxCols) maxCols = data[i2].length;
        originalHeaders = [];
        for(var ci=0; ci<maxCols; ci++) originalHeaders.push("col_" + (ci+1));
        originalRows = data.map(function(r){
          var rr = [];
          for(var ci2=0; ci2<maxCols; ci2++) rr.push(safe(r[ci2]));
          return rr;
        });
      }

      columns = originalHeaders.map(function(h, i){
        var name = safe(h) || ("col_" + (i+1));
        return { id:i+1, origIndex:i, name:name, outName:name, selected:true };
      });

      filters = [];
      sorts = [];
      renderFilterChips();
      renderSortChips();

      renderColumns();
      rebuildSelects();

      setPill(statusPill, "èª­ã¿è¾¼ã¿å®Œäº†", (parsed.errors && parsed.errors.length) ? "warn" : "ok");
      setPill(metaPill, file.name + " / " + bytesToHuman(file.size) + " / åŒºåˆ‡ã‚Š: " + (delim === "\t" ? "TAB" : delim), "");

      updatePreview();
    }).catch(function(e){
      console.error(e);
      setPill(statusPill, "ã‚¨ãƒ©ãƒ¼: " + e.message, "bad");
      alert(e.message);
    });
  }

  function clearAll(){
    originalHeaders = [];
    originalRows = [];
    columns = [];
    filters = [];
    sorts = [];

    $("file").value = "";
    $("findText").value = "";
    $("replaceText").value = "";
    $("previewSearch").value = "";

    colList.innerHTML = "";
    filterChips.innerHTML = "";
    sortChips.innerHTML = "";

    replaceTarget.innerHTML = "";
    filterCol.innerHTML = "";
    sortCol.innerHTML = "";
    dedupeCols.innerHTML = "";

    thead.innerHTML = "";
    tbody.innerHTML = "";

    setPill(statusPill, "æœªèª­ã¿è¾¼ã¿", "");
    setPill(metaPill, "-", "");
    setPill(previewPill, "-", "");
    setPill(transformPill, "-", "");
  }

  $("loadBtn").addEventListener("click", function(){
    var f = $("file").files && $("file").files[0];
    if(!f){ alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚"); return; }
    loadFromFile(f);
  });
  $("file").addEventListener("change", function(){
    var f = $("file").files && $("file").files[0];
    if(!f) return;
    loadFromFile(f);
  });
  $("clearBtn").addEventListener("click", function(){ clearAll(); });

  $("allCols").addEventListener("click", function(){ columns.forEach(function(c){ c.selected = true; }); renderColumns(); rebuildSelects(); });
  $("noneCols").addEventListener("click", function(){ columns.forEach(function(c){ c.selected = false; }); renderColumns(); rebuildSelects(); });
  $("invertCols").addEventListener("click", function(){ columns.forEach(function(c){ c.selected = !c.selected; }); renderColumns(); rebuildSelects(); });
  $("resetOrder").addEventListener("click", function(){ columns.sort(function(a,b){ return a.origIndex - b.origIndex; }); renderColumns(); rebuildSelects(); });

  $("addFilterBtn").addEventListener("click", function(){
    if(!columns.length) return;
    filters.push({ colId:Number(filterCol.value), op:$("filterOp").value, val:$("filterVal").value || "" });
    renderFilterChips();
  });
  $("clearFiltersBtn").addEventListener("click", function(){ filters = []; renderFilterChips(); });

  $("addSortBtn").addEventListener("click", function(){
    if(!columns.length) return;
    sorts.push({ colId:Number(sortCol.value), dir:$("sortDir").value, as:$("sortAs").value });
    renderSortChips();
  });
  $("clearSortsBtn").addEventListener("click", function(){ sorts = []; renderSortChips(); });

  $("updatePreviewBtn").addEventListener("click", function(){ if(originalHeaders.length) updatePreview(); });
  $("previewSearch").addEventListener("input", function(){ if(originalHeaders.length) updatePreview(); });
  $("previewMaxRows").addEventListener("change", function(){ if(originalHeaders.length) updatePreview(); });

  var autoIds = ["addNo","noName","trimAll","dropEmptyRows","dropEmptyOutCols","findText","replaceText","replaceRegex","replaceTarget","filterMode","dedupeMode","outDelimiter","outEncoding","outName","splitExport","splitRows"];
  autoIds.forEach(function(id){
    var el = $(id);
    if(!el) return;
    el.addEventListener("change", function(){ if(originalHeaders.length){ try{ updatePreview(); }catch(e){} } });
    el.addEventListener("input", function(){ if(originalHeaders.length){ try{ updatePreview(); }catch(e){} } });
  });

  $("downloadBtn").addEventListener("click", function(){ try{ doDownload(); }catch(e){ console.error(e); alert(e.message); } });
  $("copyTSVBtn").addEventListener("click", function(){ copyAsTSV(); });

  var dz = $("dropzone");
  function setDZ(on){ if(on) dz.classList.add("dragover"); else dz.classList.remove("dragover"); }
  ["dragenter","dragover"].forEach(function(ev){
    dz.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); setDZ(true); });
  });
  ["dragleave","drop"].forEach(function(ev){
    dz.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); setDZ(false); });
  });
  dz.addEventListener("drop", function(e){
    var file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if(!file) return;
    loadFromFile(file);
  });

  setPill(statusPill, "æœªèª­ã¿è¾¼ã¿", "");
  setPill(metaPill, "-", "");
  setPill(previewPill, "-", "");
  setPill(transformPill, "-", "");
})();
</script>
</body>
</html>
