<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´ç›£è¦–ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    <style>
        :root { --main: #4A154B; --active: #ECB22E; --bg: #f4f7f9; --stop: #d32f2f; --alert: #ff5252; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 8px; margin: 0; font-size: 14px; }
        #top-alert { background: var(--alert); color: white; text-align: center; padding: 8px; font-weight: bold; position: sticky; top: 0; z-index: 100; border-radius: 0 0 10px 10px; margin: -8px -8px 10px -8px; display: none; }
        .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--main); border-left: 4px solid var(--main); padding-left: 8px; }
        .selector-row { display: flex; justify-content: space-around; padding: 8px; background: #eee; border-radius: 8px; align-items: center; margin-top: 10px; }
        .selector-row label { display: flex; align-items: center; font-size: 14px; font-weight: bold; cursor: pointer; color: #333; margin: 0; }
        .selector-row input { width: auto; margin-right: 4px; }
        .tab-group { display: flex; gap: 4px; margin: 10px 0; background: #ddd; padding: 2px; border-radius: 6px; }
        .tab { flex: 1; text-align: center; padding: 8px 4px; font-size: 11px; border-radius: 4px; cursor: pointer; border: none; background: none; font-weight: bold; color: #555; }
        .tab.active { background: white; color: var(--main); }
        .sub-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .sub-toggle button { font-size: 11px; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .sub-toggle button.active { background: #666; color: #fff; border-color: #666; }
        label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 2px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 8px; background: #fff; }
        .grid-3 { display: flex; gap: 4px; }
        .grid-3 div { flex: 1; }
        .result-panel { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 12px; margin: 10px 0; text-align: center; color: #2e7d32; min-height: 110px; display: flex; flex-direction: column; justify-content: center; }
        .finish-time { font-size: 32px; font-weight: bold; display: block; line-height: 1.2; color: #1b5e20; }
        .monitor-item { border-left: 5px solid var(--active); padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .item-btns { display: flex; gap: 5px; margin-top: 8px; }
        .btn-sm { flex: 1; padding: 8px; font-size: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--stop); }
        .btn-blue { background: #2196F3; }
        .btn-gray { background: #777; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 17px; cursor: pointer; color: white; margin-top: 10px; background: var(--main); }
        .hidden { display: none !important; }
        .edit-input { font-size: 12px; padding: 5px; margin-bottom: 4px; width: 100%; border: 1px solid var(--active); }
    </style>
</head>
<body>

<div id="top-alert">âš ï¸ çµ¦æ°´ç›£è¦–ä¸­</div>

<div class="card">
    <div class="card">
        <div style="display: flex; gap: 4px; align-items: flex-end;">
        <div style="flex:1;"><label>åŒæœŸID</label><input type="password" id="gid" placeholder="ID" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:1;"><label>PASS</label><input type="password" id="gpw" placeholder="PASS" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:0.7; margin-bottom:8px;">
            <button onclick="loadDataFromKV()" class="btn-sm btn-blue" style="height:40px; width:100%;">åŒæœŸ</button>
        </div>
        <div style="flex:0.5; margin-bottom:8px;"><button onclick="toggleConfig()" style="font-size:10px; height:40px; padding:5px;">è¨­å®šâš™</button></div>
    </div>
    
    <div id="config-area" class="hidden" style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px;">
        <label>Slack Webhook URL</label>
        <input type="password" id="slackUrl" placeholder="https://hooks.slack.com/..." onfocus="this.type='text'" onblur="this.type='password'">
        
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <a href="user_reg.html" style="font-size: 11px; color: #2196F3;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/PASSç™»éŒ²ç”»é¢ã¸</a>
            <a href="help.html" style="font-size: 11px; color: #2196F3;">â“ ãƒ˜ãƒ«ãƒ—</a>
        </div>
        <button onclick="saveInitialData()" class="btn-sm btn-blue" style="margin-top:10px; width:100%;">ã“ã®è¨­å®šã‚’åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ²</button>
    </div>

    <div class="selector-row">
        <label><input type="radio" name="unit" value="ã¥" checked onchange="convertVolUnit('ã¥')"> ã¥</label>
        <label><input type="radio" name="unit" value="â„“" onchange="convertVolUnit('â„“')"> â„“</label>
        <label><input type="radio" name="unit" value="t" onchange="convertVolUnit('t')"> t</label>
        <div style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></div>
        <label><input type="radio" name="t_unit" value="åˆ†" onchange="convertTimeUnit('åˆ†')"> /åˆ†</label>
        <label><input type="radio" name="t_unit" value="æ™‚" checked onchange="convertTimeUnit('æ™‚')"> /æ™‚</label>
    </div>
</div>

<div class="card">
    <h3>ğŸŒŠ çµ¦æ°´ç™»éŒ²</h3>
    <div class="tab-group">
        <button id="tab-size" class="tab active" onclick="setMode('size')">ã‚µã‚¤ã‚ºå…¥åŠ›</button>
        <button id="tab-vol" class="tab" onclick="setMode('vol')">æ°´é‡ç›´æ¥</button>
        <button id="tab-time" class="tab" onclick="setMode('time')">æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®š</button>
    </div>

    <div id="flow-input-area">
        <label id="flowLabel">çµ¦æ°´èƒ½åŠ› (ã¥/æ™‚)</label>
        <input type="number" id="flowRate" value="18" oninput="uiCalc()">
    </div>

    <div id="mode-size">
        <div class="grid-3">
            <div><label>é•·ã•(m)</label><input type="number" id="L" value="25" oninput="uiCalc()"></div>
            <div><label>å¹…(m)</label><input type="number" id="W" value="12" oninput="uiCalc()"></div>
            <div><label>æ·±ã•(m)</label><input type="number" id="D" value="1.2" oninput="uiCalc()"></div>
        </div>
        <label>ç¾åœ¨é‡ (%)</label>
        <input type="number" id="currentPer" value="0" oninput="uiCalc()">
    </div>

    <div id="mode-vol" class="hidden">
        <label id="manualVolLabel">å¿…è¦æ°´é‡ (ã¥)</label>
        <input type="number" id="manualVol" value="360" oninput="uiCalc()">
    </div>

    <div id="mode-time" class="hidden">
        <div class="sub-toggle">
            <button id="sub-rel" class="active" onclick="setSubTimeMode('rel')">æ®‹ã‚Šæ™‚é–“</button>
            <button id="sub-abs" onclick="setSubTimeMode('abs')">å®Œäº†æ—¥æ™‚ã§æŒ‡å®š</button>
        </div>
        <div id="time-rel-area">
            <div class="grid-3">
                <div style="flex:1;"><label>æ™‚é–“</label><input type="number" id="manualHrs" value="5" oninput="uiCalc()"></div>
                <div style="flex:1;"><label>åˆ†</label><input type="number" id="manualMin" value="0" oninput="uiCalc()"></div>
            </div>
        </div>
        <div id="time-abs-area" class="hidden">
            <div class="grid-3">
                <div style="flex:1.5;"><label>å®Œäº†æ—¥</label><input type="date" id="absDate" onchange="uiCalc()"></div>
                <div><label>æ™‚</label><select id="absHour" onchange="uiCalc()"></select></div>
                <div><label>åˆ†</label><select id="absMin" onchange="uiCalc()"></select></div>
            </div>
        </div>
    </div>

    <div class="result-panel">
        <span id="finishDate" style="font-weight:bold;">----/--/--</span>
        <span id="finishClock" class="finish-time">--:--</span>
        <div id="detailRes" style="font-size:13px; font-weight:bold; margin-top:5px;"></div>
    </div>

    <div class="grid-3">
        <div style="flex:2"><label>æ–½è¨­å</label><input type="text" id="facility" placeholder="æ–½è¨­å"></div>
        <div style="flex:1"><label>æ‹…å½“è€…</label><input type="text" id="startUser" placeholder="åå‰"></div>
    </div>
    <button class="btn-main" onclick="doStart()">ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="monitor-list-area" class="card">
    <h3>ğŸ“¡ ç¨¼åƒçŠ¶æ³ãƒ»å±¥æ­´</h3>
    <div id="monitor-list"></div>
</div>

<script>
    let currentMode = 'size';
    let subTimeMode = 'rel';
    let lastVolUnit = 'ã¥';
    let lastTimeUnit = 'æ™‚';
    let monitorItems = [];

    // æ—¥æ™‚æŒ‡å®šç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
    const hSelect = document.getElementById('absHour');
    for(let i=0; i<24; i++) hSelect.add(new Option(i, i));
    const mSelect = document.getElementById('absMin');
    for(let i=0; i<60; i++) mSelect.add(new Option(i, i));


    // --- è¨­å®šã‚¨ãƒªã‚¢ã®é–‹é–‰ ---
    function toggleConfig() {
        document.getElementById('config-area').classList.toggle('hidden');
    }

    // --- è¨­å®šå€¤ã€Webhookã‚’IDã¨PASSã«åˆã‚ã›ã¦åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ² (DBä¿å­˜ç”¨) ---
    async function saveInitialData() {
        const configPayload = {
            webhook: document.getElementById('slackUrl').value,
            facility: document.getElementById('facility').value,
            startUser: document.getElementById('startUser').value,
            unit_vol: document.querySelector('input[name="unit"]:checked').value,
            unit_time: document.querySelector('input[name="t_unit"]:checked').value,
            default_flow: document.getElementById('flowRate').value,
            
            // ğŸŸ¢ ã“ã“ãŒé‡è¦ï¼šã‚µã‚¤ã‚ºã¨ç›´æ¥æ°´é‡ã‚’ä¿å­˜å¯¾è±¡ã«è¿½åŠ 
            L: document.getElementById('L').value,
            W: document.getElementById('W').value,
            D: document.getElementById('D').value,
            manualVol: document.getElementById('manualVol').value,
            
            // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ–ï¼‰ã‚‚ä¿å­˜
            currentMode: currentMode 
        };
    
        try {
            await apiFetch("/save-config", { configPayload: configPayload });
            alert("å¹…ã€æ·±ã•ã€æ°´é‡ã‚’å«ã‚€ã™ã¹ã¦ã®åˆæœŸå€¤ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
        } catch (e) { alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    function convertVolUnit(newUnit) {
        const inputs = ['flowRate', 'manualVol'];
        inputs.forEach(id => {
            let val = parseFloat(document.getElementById(id).value);
            if (isNaN(val)) return;
            let m3Val = (lastVolUnit === 'â„“') ? val / 1000 : val; 
            document.getElementById(id).value = (newUnit === 'â„“') ? (m3Val * 1000) : m3Val;
        });
        lastVolUnit = newUnit;
        uiCalc();
    }

    function convertTimeUnit(newUnit) {
        if (lastTimeUnit === newUnit) return;
        let val = parseFloat(document.getElementById('flowRate').value);
        if (!isNaN(val)) {
            if (newUnit === 'åˆ†') document.getElementById('flowRate').value = (val / 60).toFixed(2);
            else document.getElementById('flowRate').value = (val * 60).toFixed(1);
        }
        lastTimeUnit = newUnit;
        uiCalc();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + m).classList.add('active');
        ['mode-size', 'mode-vol', 'mode-time'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('mode-' + m).classList.remove('hidden');
        document.getElementById('flow-input-area').classList.toggle('hidden', m === 'time');
        uiCalc();
    }

    function setSubTimeMode(sm) {
        subTimeMode = sm;
        document.getElementById('sub-rel').classList.toggle('active', sm === 'rel');
        document.getElementById('sub-abs').classList.toggle('active', sm === 'abs');
        document.getElementById('time-rel-area').classList.toggle('hidden', sm === 'abs');
        document.getElementById('time-abs-area').classList.toggle('hidden', sm === 'rel');
        if(sm === 'abs') {
            const now = new Date();
            document.getElementById('absDate').value = now.toISOString().split('T')[0];
            document.getElementById('absHour').value = now.getHours();
            document.getElementById('absMin').value = now.getMinutes();
        }
        uiCalc();
    }



    const WORKER_URL = "https://pool-api.nogray.workers.dev/api"; // â˜…è¦æ›¸ãæ›ãˆ

    // å…±é€šé€šä¿¡é–¢æ•° (Workerå´ã®èªè¨¼ã«å¯¾å¿œ)
    async function apiFetch(endpoint, payload = {}) {
        const gid = document.getElementById('gid').value.trim();
        const gpw = document.getElementById('gpw').value.trim();
        if (!gid || !gpw) throw new Error("è¨­å®šã‹ã‚‰IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const response = await fetch(`${WORKER_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gid, gpw, ...payload })
        });
        if (!response.ok) throw new Error(await response.text());
        return await response.json();
    }







    function uiCalc() {
        const vUnit = document.querySelector('input[name="unit"]:checked').value;
        const tUnit = document.querySelector('input[name="t_unit"]:checked').value;
        document.getElementById('flowLabel').innerText = `çµ¦æ°´èƒ½åŠ› (${vUnit}/${tUnit})`;
        document.getElementById('manualVolLabel').innerText = `å¿…è¦æ°´é‡ (${vUnit})`;

        let totalMins = 0; let reqM3 = 0;
        const sizeM3 = (parseFloat(document.getElementById('L').value)||0) * (parseFloat(document.getElementById('W').value)||0) * (parseFloat(document.getElementById('D').value)||0) * (1 - (parseFloat(document.getElementById('currentPer').value)||0)/100);

        if (currentMode === 'time') {
            if (subTimeMode === 'rel') {
                totalMins = (parseInt(document.getElementById('manualHrs').value)||0)*60 + (parseInt(document.getElementById('manualMin').value)||0);
            } else {
                const datePart = document.getElementById('absDate').value;
                const h = document.getElementById('absHour').value;
                const m = document.getElementById('absMin').value;
                if(datePart) {
                    const target = new Date(`${datePart}T${h.padStart(2,'0')}:${m.padStart(2,'0')}:00`);
                    totalMins = Math.max(0, (target - new Date()) / 60000);
                }
            }
            reqM3 = sizeM3; 
        } else {
            const rawFlow = parseFloat(document.getElementById('flowRate').value) || 0.001;
            let flowMinM3 = (vUnit === 'â„“') ? rawFlow / 1000 : rawFlow;
            if (tUnit === 'æ™‚') flowMinM3 /= 60;
            if (currentMode === 'size') reqM3 = sizeM3;
            else {
                const iv = parseFloat(document.getElementById('manualVol').value)||0;
                reqM3 = (vUnit === 'â„“') ? iv / 1000 : iv;
            }
            totalMins = reqM3 / flowMinM3;
        }

        const finish = new Date(Date.now() + totalMins * 60000);
        document.getElementById('finishDate').innerText = finish.toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit', weekday:'short'});
        document.getElementById('finishClock').innerText = finish.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
        
        const dh = Math.floor(totalMins / 60);
        const dm = Math.round(totalMins % 60);
        const m3Text = reqM3.toFixed(1);
        const lText = Math.round(reqM3 * 1000).toLocaleString();
        let volDisp = (vUnit === "â„“") ? `${lText}â„“ (${m3Text}ã¥)` : `${m3Text}ã¥ (${lText}â„“)`;

        document.getElementById('detailRes').innerHTML = `å®Œäº†ã¾ã§: ç´„${dh}æ™‚é–“${dm}åˆ†<br>å¿…è¦é‡: ${volDisp} / ${m3Text}t`;
        return { totalMins, reqM3 };
    }




        // ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚
    async function doStart() {
        const { totalMins, reqM3 } = uiCalc();
        const limitTime = Date.now() + totalMins * 60000;
        
        const payload = {
            id: Date.now(),
            facility: document.getElementById('facility').value || "æœªè¨­å®šæ–½è¨­",
            startUser: document.getElementById('startUser').value || "æœªè¨­å®šè€…",
            status: 'active', // monitoring ã‹ã‚‰ active ã«çµ±ä¸€ï¼ˆWorkerå´ã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
            limitTime: limitTime,
            totalVolM3: reqM3,
            webhook: document.getElementById('slackUrl').value,
            settings: { m: 10, at0: true, p: 5, interval: 10 }
        };

        try {
            await apiFetch("/save", { payload });
            alert("ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
            // ID/PASSã‚’ä¿å­˜
            localStorage.setItem('water_gid', document.getElementById('gid').value);
            localStorage.setItem('water_gpw', document.getElementById('gpw').value);
            location.reload();
        } catch (e) { alert(e.message); }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    window.addEventListener('load', async () => {
        document.getElementById('gid').value = localStorage.getItem('water_gid') || '';
        document.getElementById('gpw').value = localStorage.getItem('water_gpw') || '';

        if (document.getElementById('gid').value && document.getElementById('gpw').value) {
            try {
                const data = await apiFetch("/load");
                if (data.config) document.getElementById('slackUrl').value = data.config.webhook || "";
                monitorItems = data.pools || [];
                updateMonitorList();
            } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"); }
        }
        uiCalc();
    });



    // KVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ç”»é¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    async function loadDataFromKV() {
        const gid = document.getElementById('gid').value.trim();
        const gpw = document.getElementById('gpw').value.trim();
        if (!gid || !gpw) return;
    
        try {
            const data = await apiFetch("/load");
            if (data.config) {
                const c = data.config;
                
                // æ—¢å­˜ã®åæ˜ 
                document.getElementById('slackUrl').value = c.webhook || "";
                document.getElementById('facility').value = c.facility || "";
                document.getElementById('startUser').value = c.startUser || "";
                document.getElementById('flowRate').value = c.default_flow || "18";
    
                // ğŸŸ¢ æ‹¡å¼µã—ãŸé …ç›®ã®åæ˜ 
                if(c.L) document.getElementById('L').value = c.L;
                if(c.W) document.getElementById('W').value = c.W;
                if(c.D) document.getElementById('D').value = c.D;
                if(c.manualVol) document.getElementById('manualVol').value = c.manualVol;
                document.getElementById('currentPer').value = "0"; // ç¾åœ¨é‡ã¯å¸¸ã«0
    
                // ğŸŸ¢ ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ–ï¼‰ã®å¾©å…ƒ
                if(c.currentMode) setMode(c.currentMode);
    
                // ğŸŸ¢ æ™‚é–“æŒ‡å®šã®å ´åˆã®åˆæœŸåŒ–ï¼ˆç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆï¼‰
                if(c.currentMode === 'time') {
                    document.getElementById('manualHrs').value = "0";
                    document.getElementById('manualMin').value = "0";
                    const now = new Date();
                    document.getElementById('absDate').value = now.toISOString().split('T')[0];
                    document.getElementById('absHour').value = now.getHours();
                    document.getElementById('absMin').value = now.getMinutes();
                }
            }
            
            monitorItems = data.pools || [];
            updateMonitorList();
            uiCalc(); // å…¨ã¦ã‚»ãƒƒãƒˆã—ãŸå¾Œã«è¨ˆç®—ã‚’å®Ÿè¡Œ
        } catch (e) { console.error("åŒæœŸå¤±æ•—:", e.message); }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', async () => {
        // ä¿å­˜ã•ã‚ŒãŸID/PASSãŒã‚ã‚Œã°å¾©å…ƒ
        document.getElementById('gid').value = localStorage.getItem('water_gid') || '';
        document.getElementById('gpw').value = localStorage.getItem('water_gpw') || '';
        
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•ã§1å›èª­ã¿è¾¼ã¿ã«è¡Œã
        if (document.getElementById('gid').value && document.getElementById('gpw').value) {
            await loadDataFromKV();
        }
        uiCalc();
    });


    function updateMonitorList() {
    const listDiv = document.getElementById('monitor-list');
    listDiv.innerHTML = '';
    const now = new Date();
    let activeCount = 0;

    monitorItems.forEach(item => {
        const isMon = item.status === 'active';
        if(isMon) activeCount++;
        const remainMins = Math.max(0, (item.limitTime - (isMon ? now : item.stopTime)) / 60000);
        const rh = Math.floor(remainMins / 60);
        const rm = Math.round(remainMins % 60);

        // æ‹…å½“è€…è¡¨ç¤ºã®ä½œæˆ
        let userDisplay = "";
        if (item.isEditing) {
            const isMon = item.status === 'active';
            userDisplay = `
                <div style="margin-bottom:5px;">æ–½è¨­: <input id="edit-f-${item.id}" class="edit-input" value="${item.facility}"></div>
                <div style="margin-bottom:5px;">é–‹å§‹è€…: <input id="edit-u-${item.id}" class="edit-input" value="${item.startUser}"></div>
                ${!isMon ? `<div>çµ‚äº†è€…: <input id="edit-su-${item.id}" class="edit-input" value="${item.stopUser || ''}"></div>` : ''}
            `;
        } else {
            userDisplay = `
                <span style="font-size:14px;">${item.facility}</span><br>
                <span style="font-size:12px; color:#666;">é–‹å§‹è€…: ${item.startUser}</span>
                ${item.stopUser ? `<br><span style="font-size:12px; color:var(--stop);">çµ‚äº†è€…: ${item.stopUser}</span>` : ''}
            `;
        }

        const div = document.createElement('div');
        div.className = `monitor-item ${isMon ? '' : 'finished'}`;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-weight:bold; align-items: flex-start;">
                <div style="flex:1;">${userDisplay}</div>
                <span style="color:${isMon?'#2196F3':'#999'}">${isMon?'ğŸ”µ ç›£è¦–ä¸­':'âšª åœæ­¢æ¸ˆ'}</span>
            </div>
            <div style="font-size:11px; color:#666; margin-top:5px;">
                é–‹å§‹: ${new Date(item.created_at).toLocaleString()} | å¿…è¦: ${item.totalVolM3.toFixed(1)}t
            </div>
            <div style="background:#eee; padding:8px; border-radius:4px; margin:5px 0; font-size:12px;">
                <div>${isMon ? 'çµ‚äº†äºˆå®š' : 'åœæ­¢æ™‚åˆ»'}: <strong>${isMon ? new Date(item.limitTime).toLocaleString() : new Date(item.stopTime).toLocaleString()}</strong></div>
                ${isMon ? `<div style="color:var(--stop); font-weight:bold;">æ®‹ã‚Šç´„ ${rh}æ™‚é–“${rm}åˆ†</div>` : '<div style="color:#666;">ç›£è¦–ã‚’çµ‚äº†ã—ã¾ã—ãŸ</div>'}
            </div>
            <div class="item-btns">
                ${item.isEditing ? `<button class="btn-sm btn-blue" onclick="saveEdit(${item.id})">ä¿å­˜</button>` : `<button class="btn-sm btn-gray" onclick="toggleEdit(${item.id})">ä¿®æ­£</button>`}
                ${isMon ? `<button class="btn-sm btn-red" onclick="doStop(${item.id})">åœæ­¢</button>` : `<button class="btn-sm btn-gray" style="background:#ccc" disabled>å®Œäº†</button>`}
                <button class="btn-sm btn-gray" onclick="doDelete(${item.id})">å‰Šé™¤</button>
            </div>
        `;
        listDiv.appendChild(div);
    });
    document.getElementById('top-alert').style.display = activeCount > 0 ? 'block' : 'none';
    }

    function toggleEdit(id) { monitorItems.find(i => i.id === id).isEditing = true; updateMonitorList(); }
    // --- ä¿®æ­£ä¿å­˜ ---
    async function saveEdit(id) {
        const item = monitorItems.find(i => i.id === id);
        const facility = document.getElementById(`edit-f-${id}`).value;
        const startUser = document.getElementById(`edit-u-${id}`).value;
        const stopUser = item.status === 'completed' ? document.getElementById(`edit-su-${id}`).value : "";

        const body = {
            gid: document.getElementById('gid').value,
            gpw: document.getElementById('gpw').value,
            poolId: id,
            facility: facility,
            startUser: startUser,
            stopUser: stopUser
        };

        await fetch(`${WORKER_URL}/update-item`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        item.facility = facility;
        item.startUser = startUser;
        if (item.status === 'completed') item.stopUser = stopUser;
        item.isEditing = false;
        updateMonitorList();
    }
    
    // --- åœæ­¢å‡¦ç† (ã“ã“ã‹ã‚‰) ---
    async function doStop(id) {
        const stopUser = document.getElementById('startUser').value || "æœªè¨­å®šè€…";
        if (!confirm("çµ¦æ°´ã‚’åœæ­¢ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
            // æ–°ã—ã„ Worker ã®ä»•æ§˜ (apiFetch) ã§é€šä¿¡
            await apiFetch("/stop", { 
                poolId: id, 
                stopUser: stopUser 
            });
            
            // æˆåŠŸã—ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã«ã™ã‚‹
            location.reload();
        } catch (e) {
            alert("åœæ­¢ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    }
    // --- åœæ­¢å‡¦ç† (ã“ã“ã¾ã§) ---
    
    // å‰Šé™¤å‡¦ç†
    async function doDelete(id) {
        if (!confirm("å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            await apiFetch("/delete", { poolId: id });
            location.reload();
        } catch (e) { alert(e.message); }
    }


    setInterval(updateMonitorList, 30000);

</script>
</body>

</html>



