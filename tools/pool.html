<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ°´ç›£è¦–ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9V96DZHTH1');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

  <style>
    :root { --main:#4A154B; --active:#ECB22E; --bg:#f4f7f9; --stop:#d32f2f; --alert:#ff5252; }
    *{ box-sizing:border-box; }
    body{ font-family:-apple-system,system-ui,sans-serif; background:var(--bg); padding:8px; margin:0; font-size:14px; }
    .card{ background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.05); margin-bottom:10px; }
    h3{ margin:0 0 10px 0; font-size:.95rem; color:var(--main); border-left:4px solid var(--main); padding-left:8px; }
    label{ display:block; font-size:11px; font-weight:700; color:#666; margin-bottom:2px; }
    input,select{ width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:16px; margin-bottom:8px; background:#fff; }
    .grid-3{ display:flex; gap:4px; }
    .grid-3 > div{ flex:1; }
    .selector-row{ display:flex; justify-content:space-around; padding:8px; background:#eee; border-radius:8px; align-items:center; margin-top:10px; }
    .selector-row label{ display:flex; align-items:center; font-size:14px; font-weight:700; cursor:pointer; color:#333; margin:0; }
    .selector-row input{ width:auto; margin-right:4px; }
    .tab-group{ display:flex; gap:4px; margin:10px 0; background:#ddd; padding:2px; border-radius:6px; }
    .tab{ flex:1; text-align:center; padding:8px 4px; font-size:11px; border-radius:4px; cursor:pointer; border:none; background:none; font-weight:800; color:#555; }
    .tab.active{ background:#fff; color:var(--main); }
    .sub-toggle{ display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
    .sub-toggle button{ font-size:11px; padding:6px 12px; border-radius:20px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .sub-toggle button.active{ background:#666; color:#fff; border-color:#666; }
    .result-panel{ background:#e8f5e9; border:1px solid #c8e6c9; border-radius:8px; padding:12px; margin:10px 0; text-align:center; color:#2e7d32; min-height:110px; display:flex; flex-direction:column; justify-content:center; }
    .finish-time{ font-size:32px; font-weight:900; display:block; line-height:1.2; color:#1b5e20; }
    .btn-sm{ flex:1; padding:8px; font-size:12px; border:none; border-radius:4px; color:#fff; cursor:pointer; font-weight:800; }
    .btn-red{ background:var(--stop); }
    .btn-blue{ background:#2196F3; }
    .btn-gray{ background:#777; }
    .btn-main{ width:100%; padding:15px; border:none; border-radius:8px; font-weight:900; font-size:17px; cursor:pointer; color:#fff; margin-top:10px; background:var(--main); }
    .hidden{ display:none !important; }

    /* ä¸Šéƒ¨ãƒãƒŠãƒ¼ */
    #top-alert{ background:var(--alert); color:#fff; text-align:center; padding:8px; font-weight:900; position:sticky; top:58px; z-index:40; border-radius:0 0 10px 10px; margin:0 -8px 10px -8px; display:none; }

    /* ç›£è¦–ã‚«ãƒ¼ãƒ‰ */
    .monitor-item{ border-left:5px solid var(--active); padding:12px; background:#fff; margin-bottom:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,.08); }
    .monitor-item.finished{ padding:10px 12px; cursor:pointer; background:#fcfcfc; border-left-color:#bbb; }
    .monitor-item .detail-area{ display:block; }
    .monitor-item.finished .detail-area{ display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; }
    .monitor-item.finished:not(.open) .item-btns{ display:none; }
    .monitor-item.finished.open .detail-area{ display:block; }
    .monitor-item.finished .simple-area{ display:flex; }
    .monitor-item.finished.open .simple-area{ display:none; }

    /* å±é™ºè¡¨ç¤º */
    .danger-alert{ background:#fff0f0 !important; border:2px solid #ff0000 !important; animation:blink 1s infinite; }
    @keyframes blink{ 0%{ box-shadow:0 0 0px #ff0000; } 50%{ box-shadow:0 0 18px #ff0000; } 100%{ box-shadow:0 0 0px #ff0000; } }

    .time-panel{ margin-top:10px; background:#f0f0f0; padding:12px; border-radius:10px; border:1px solid #000; }
    .time-title{ font-size:14px; font-weight:900; color:#444; }
    .time-big{ font-size:2.4rem; font-weight:900; color:#000; line-height:1.1; }
    .time-sub{ font-size:14px; color:#333; font-weight:800; }

    .vol-panel{ margin-top:10px; padding:10px; background:#000; color:#fff; border-radius:8px; border:2px solid #ECB22E; }
    .vol-label{ font-size:12px; color:#ccc; }
    .vol-big{ font-size:1.35rem; font-weight:900; }

    .sync-status{ font-size:11px; color:#666; margin-top:4px; }
  </style>
</head>

<body onload="init()">

  <nav class="bg-white border-b border-slate-200 py-4 px-6 sticky top-0 z-50">
    <div class="container mx-auto" style="max-width:1100px; display:flex; justify-content:space-between; align-items:center;">
      <a href="../index.html" class="flex items-center font-bold text-lg text-blue-700" style="text-decoration:none; display:flex; align-items:center; white-space:nowrap;">
        <span style="margin-right:8px;">ğŸ </span> PocketPortal
      </a>
      <div style="flex:1; text-align:right;">
        <a href="./index.html" class="text-slate-400 hover:text-blue-500 transition-colors" style="text-decoration:none; font-size:10px; margin-left:auto;">Webä¾¿åˆ©ãƒ„ãƒ¼ãƒ«é›†ã¸</a>
      </div>
    </div>
  </nav>

  <div id="top-alert">âš ï¸ çµ¦æ°´ç›£è¦–ä¸­</div>

  <div class="container" style="max-width:600px; margin:0 auto;">

    <div class="card">
      <div style="display:flex; gap:4px; align-items:flex-end;">
        <div style="flex:1;"><label>åŒæœŸID</label><input type="password" id="gid" placeholder="ID" autocomplete="off" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:1;"><label>PASS</label><input type="password" id="gpw" placeholder="PASS" autocomplete="off" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:0.9; margin-bottom:8px;">
          <div id="syncStatus" class="sync-status"></div>
          <button id="syncBtn" onclick="syncData()" class="btn-sm btn-blue" style="height:40px; width:100%;">åŒæœŸ</button>
        </div>
        <div style="flex:0.5; margin-bottom:8px;"><button onclick="toggleConfig()" style="font-size:10px; height:40px; padding:5px;">è¨­å®šâš™</button></div>
      </div>

      <div id="config-area" class="hidden" style="border-top:1px solid #eee; padding-top:8px; margin-top:5px;">
        <label>Slack Webhook URL</label>
        <input type="password" id="slackUrl" placeholder="https://hooks.slack.com/..." autocomplete="off" onfocus="this.type='text'" onblur="this.type='password'">

        <div class="setting-item" style="border:1px solid #ddd; padding:10px; border-radius:8px;">
          <label style="color:var(--main); margin-bottom:10px; display:block;">ğŸ”” é€šçŸ¥è¨­å®šï¼ˆåˆæœŸå€¤ã¨ã—ã¦ä¿å­˜å¯èƒ½ï¼‰</label>
          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="at0_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´äºˆå®šæ™‚åˆ»ã«é€šçŸ¥</span>
          </div>
          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="m_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´ã® <input type="number" id="m_val" value="10" style="width:55px; padding:2px;"> åˆ†å‰ã«äºˆå‘Š</span>
          </div>
          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="p_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´ã‹ã‚‰ <input type="number" id="p_val" value="5" style="width:55px; padding:2px;"> åˆ†éããŸã‚‰è­¦å‘Š</span>
          </div>
          <div style="display:flex; align-items:center;">
            <input type="checkbox" id="interval_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">è¶…éä¸­ <input type="number" id="interval_val" value="10" style="width:55px; padding:2px;"> åˆ†ãŠãã«å†é€šçŸ¥</span>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:5px;">
          <a href="user_reg.html" style="font-size:11px; color:#2196F3;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/PASSç™»éŒ²ç”»é¢ã¸</a>
          <a href="help.html" style="font-size:11px; color:#2196F3;">â“ ãƒ˜ãƒ«ãƒ—</a>
        </div>
        <button onclick="saveInitialData()" class="btn-sm btn-blue" style="margin-top:10px; width:100%;">ã“ã®è¨­å®šã‚’åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ²</button>
      </div>

      <div class="selector-row">
        <label><input type="radio" name="unit" value="ã¥" checked onchange="convertVolUnit('ã¥')"> ã¥</label>
        <label><input type="radio" name="unit" value="â„“" onchange="convertVolUnit('â„“')"> â„“</label>
        <label><input type="radio" name="unit" value="t" onchange="convertVolUnit('t')"> t</label>
        <div style="border-left:1px solid #ccc; height:20px; margin:0 5px;"></div>
        <label><input type="radio" name="t_unit" value="åˆ†" onchange="convertTimeUnit('åˆ†')"> /åˆ†</label>
        <label><input type="radio" name="t_unit" value="æ™‚" checked onchange="convertTimeUnit('æ™‚')"> /æ™‚</label>
      </div>
    </div>

    <div class="card">
      <h3>ğŸŒŠ çµ¦æ°´ç™»éŒ²</h3>
      <div class="tab-group">
        <button id="tab-size" class="tab active" onclick="setMode('size')">ã‚µã‚¤ã‚ºå…¥åŠ›</button>
        <button id="tab-vol" class="tab" onclick="setMode('vol')">æ°´é‡ç›´æ¥</button>
        <button id="tab-time" class="tab" onclick="setMode('time')">æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®š</button>
      </div>

      <div id="flow-input-area">
        <label id="flowLabel">çµ¦æ°´èƒ½åŠ› (ã¥/æ™‚)</label>
        <input type="number" id="flowRate" value="18" oninput="uiCalc()">
      </div>

      <div id="mode-size">
        <div class="grid-3">
          <div><label>é•·ã•(m)</label><input type="number" id="L" value="25" oninput="uiCalc()"></div>
          <div><label>å¹…(m)</label><input type="number" id="W" value="12" oninput="uiCalc()"></div>
          <div><label>æ·±ã•(m)</label><input type="number" id="D" value="1.2" oninput="uiCalc()"></div>
        </div>
        <label>ç¾åœ¨é‡ (%)</label>
        <input type="number" id="currentPer" value="0" oninput="uiCalc()">
      </div>

      <div id="mode-vol" class="hidden">
        <label id="manualVolLabel">å¿…è¦æ°´é‡ (ã¥)</label>
        <input type="number" id="manualVol" value="360" oninput="uiCalc()">
      </div>

      <div id="mode-time" class="hidden">
        <div class="sub-toggle">
          <button id="sub-rel" class="active" onclick="setSubTimeMode('rel')">æ®‹ã‚Šæ™‚é–“</button>
          <button id="sub-abs" onclick="setSubTimeMode('abs')">å®Œäº†æ—¥æ™‚ã§æŒ‡å®š</button>
        </div>
        <div id="time-rel-area">
          <div class="grid-3">
            <div style="flex:1;"><label>æ™‚é–“</label><input type="number" id="manualHrs" value="5" oninput="uiCalc()"></div>
            <div style="flex:1;"><label>åˆ†</label><input type="number" id="manualMin" value="0" oninput="uiCalc()"></div>
          </div>
        </div>
        <div id="time-abs-area" class="hidden">
          <div class="grid-3">
            <div style="flex:1.5;"><label>å®Œäº†æ—¥</label><input type="date" id="absDate" onchange="uiCalc()"></div>
            <div><label>æ™‚</label><select id="absHour" onchange="uiCalc()"></select></div>
            <div><label>åˆ†</label><select id="absMin" onchange="uiCalc()"></select></div>
          </div>
        </div>
      </div>

      <div class="result-panel">
        <span id="finishDate" style="font-weight:900;">----/--/--</span>
        <span id="finishClock" class="finish-time">--:--</span>
        <div id="detailRes" style="font-size:13px; font-weight:900; margin-top:5px;"></div>
      </div>

      <div class="grid-3">
        <div style="flex:2"><label>æ–½è¨­å</label><input type="text" id="facility" placeholder="æ–½è¨­å"></div>
        <div style="flex:1"><label>æ‹…å½“è€…</label><input type="text" id="startUser" placeholder="åå‰"></div>
      </div>
      <button class="btn-main" onclick="doStart()">ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="monitor-list-area" class="card">
      <h3>ğŸ“¡ ç›£è¦–çŠ¶æ³ï¼ˆslackã‚‚ã”ç¢ºèªãã ã•ã„ï¼‰</h3>
      <div id="monitor-list"></div>
    </div>

    <!-- Bottom Ads (given) -->
    <div class="bottom-ads">
      <p class="text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">Sponsor Link</p>
      <div class="box bg-white p-1 rounded shadow-sm">
        <script type="text/javascript">
          rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770128068587";
        </script>
        <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>

        <script type="text/javascript">
          rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ranking";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770559441426";
        </script>
        <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
      </div>
    </div>

  </div>

  <script>
    // =============================
    // å®‰å®šåŒ–ãƒã‚¤ãƒ³ãƒˆ
    // - loadã‚¤ãƒ™ãƒ³ãƒˆã®é‡è¤‡ã‚’æ’é™¤ï¼ˆinit()ä¸€æœ¬åŒ–ï¼‰
    // - ID/PASS ã¯ localStorage ã«å¿…ãšä¿å­˜ã—ã€start/stop/resume/delete ã§ã‚‚ä¿æŒ
    // - webhook ã‚‚ gidå˜ä½ã§ãƒ­ãƒ¼ã‚«ãƒ«ä¿æŒï¼ˆconfigãŒç©ºã§ã‚‚ä¸Šæ›¸ãã§æ¶ˆã•ãªã„ï¼‰
    // - KVå´ã®æ™‚åˆ»ãŒ ç§’/ãƒŸãƒªç§’/æ–‡å­—åˆ— ã§ã‚‚è¡¨ç¤ºã§ãã‚‹ã‚ˆã†æ­£è¦åŒ–
    // - undefined/NaN/1970 ã‚’é˜²ããŸã‚ fallback ã‚’å¾¹åº•
    // =============================

    const WORKER_URL = "https://pool-api.nogray.workers.dev/api"; // â˜…è¦æ›¸ãæ›ãˆ

    let currentMode = 'size';
    let subTimeMode = 'rel';
    let lastVolUnit = 'ã¥';
    let lastTimeUnit = 'æ™‚';
    let monitorItems = [];

    // æ—¥æ™‚æŒ‡å®šç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
    const hSelect = document.getElementById('absHour');
    for(let i=0; i<24; i++) hSelect.add(new Option(i, i));
    const mSelect = document.getElementById('absMin');
    for(let i=0; i<60; i++) mSelect.add(new Option(i, i));

    // ---- localStorage keys ----
    const LS_GID = 'pool_gid';
    const LS_GPW = 'pool_gpw';
    const LS_WEBHOOK_PREFIX = 'pool_webhook_';

    function saveCreds() {
      const gid = document.getElementById('gid').value.trim();
      const gpw = document.getElementById('gpw').value.trim();
      if (gid) localStorage.setItem(LS_GID, gid);
      if (gpw) localStorage.setItem(LS_GPW, gpw);
      const wh = document.getElementById('slackUrl').value.trim();
      if (gid && wh) localStorage.setItem(LS_WEBHOOK_PREFIX + gid, wh);
    }

    function restoreCreds() {
      const savedId = localStorage.getItem(LS_GID) || '';
      const savedPw = localStorage.getItem(LS_GPW) || '';
      if (savedId) document.getElementById('gid').value = savedId;
      if (savedPw) document.getElementById('gpw').value = savedPw;
      const wh = savedId ? (localStorage.getItem(LS_WEBHOOK_PREFIX + savedId) || '') : '';
      if (wh) document.getElementById('slackUrl').value = wh;
    }

    function toggleConfig() {
      document.getElementById('config-area').classList.toggle('hidden');
    }

    async function apiFetch(endpoint, payload = {}) {
      const gid = document.getElementById('gid').value.trim();
      const gpw = document.getElementById('gpw').value.trim();
      if (!gid || !gpw) throw new Error("IDã¨PASSã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      const res = await fetch(`${WORKER_URL}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gid, gpw, ...payload })
      });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    async function syncData() {
      const btn = document.getElementById('syncBtn');
      const status = document.getElementById('syncStatus');
      const gid = document.getElementById('gid').value.trim();
      const gpw = document.getElementById('gpw').value.trim();
      if (!gid || !gpw) { alert("IDã¨PASSã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      try {
        btn.innerText = "åŒæœŸä¸­...";
        btn.disabled = true;
        saveCreds();

        await loadDataFromKV();

        const now = new Date();
        status.textContent = `æœ€çµ‚åŒæœŸ: ${fmtDateTime(now.getTime())}`;
        btn.innerText = "âœ… åŒæœŸå®Œäº†";
        btn.style.background = "#2e7d32";

        setTimeout(() => {
          btn.innerText = "åŒæœŸ";
          btn.style.background = "";
          btn.disabled = false;
        }, 1200);
      } catch (e) {
        alert("åŒæœŸå¤±æ•—: " + (e?.message || e));
        btn.innerText = "åŒæœŸ";
        btn.style.background = "";
        btn.disabled = false;
      }
    }

    async function saveInitialData() {
      saveCreds();
      const configPayload = {
        webhook: document.getElementById('slackUrl').value,
        facility: document.getElementById('facility').value,
        startUser: document.getElementById('startUser').value,
        unit_vol: document.querySelector('input[name="unit"]:checked').value,
        unit_time: document.querySelector('input[name="t_unit"]:checked').value,
        default_flow: document.getElementById('flowRate').value,
        at0: document.getElementById('at0_on').checked,
        m_on: document.getElementById('m_on').checked,
        m_val: document.getElementById('m_val').value,
        p_on: document.getElementById('p_on').checked,
        p_val: document.getElementById('p_val').value,
        interval_on: document.getElementById('interval_on').checked,
        interval_val: document.getElementById('interval_val').value,
        L: document.getElementById('L').value,
        W: document.getElementById('W').value,
        D: document.getElementById('D').value,
        manualVol: document.getElementById('manualVol').value,
        currentMode
      };

      try {
        await apiFetch('/save-config', { configPayload });
        alert('åˆæœŸå€¤ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
      } catch (e) {
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + (e?.message || e));
      }
    }

    function convertVolUnit(newUnit) {
      const inputs = ['flowRate', 'manualVol'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        let val = parseFloat(el.value);
        if (isNaN(val)) return;
        let m3Val = (lastVolUnit === 'â„“') ? val / 1000 : val;
        el.value = (newUnit === 'â„“') ? (m3Val * 1000) : m3Val;
      });
      lastVolUnit = newUnit;
      uiCalc();
    }

    function convertTimeUnit(newUnit) {
      if (lastTimeUnit === newUnit) return;
      let val = parseFloat(document.getElementById('flowRate').value);
      if (!isNaN(val)) {
        if (newUnit === 'åˆ†') document.getElementById('flowRate').value = (val / 60).toFixed(2);
        else document.getElementById('flowRate').value = (val * 60).toFixed(1);
      }
      lastTimeUnit = newUnit;
      uiCalc();
    }

    function setMode(m) {
      currentMode = m;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + m).classList.add('active');
      ['mode-size', 'mode-vol', 'mode-time'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('mode-' + m).classList.remove('hidden');
      document.getElementById('flow-input-area').classList.toggle('hidden', m === 'time');
      uiCalc();
    }

    function setSubTimeMode(sm) {
      subTimeMode = sm;
      document.getElementById('sub-rel').classList.toggle('active', sm === 'rel');
      document.getElementById('sub-abs').classList.toggle('active', sm === 'abs');
      document.getElementById('time-rel-area').classList.toggle('hidden', sm === 'abs');
      document.getElementById('time-abs-area').classList.toggle('hidden', sm === 'rel');
      if (sm === 'abs') {
        const now = new Date();
        document.getElementById('absDate').value = now.toISOString().split('T')[0];
        document.getElementById('absHour').value = now.getHours();
        document.getElementById('absMin').value = now.getMinutes();
      }
      uiCalc();
    }

    function uiCalc() {
      const vUnit = document.querySelector('input[name="unit"]:checked').value;
      const tUnit = document.querySelector('input[name="t_unit"]:checked').value;
      document.getElementById('flowLabel').innerText = `çµ¦æ°´èƒ½åŠ› (${vUnit}/${tUnit})`;
      document.getElementById('manualVolLabel').innerText = `å¿…è¦æ°´é‡ (${vUnit})`;

      let totalMins = 0;
      let reqM3 = 0;
      const sizeM3 = (parseFloat(document.getElementById('L').value)||0) * (parseFloat(document.getElementById('W').value)||0) * (parseFloat(document.getElementById('D').value)||0) * (1 - (parseFloat(document.getElementById('currentPer').value)||0)/100);

      if (currentMode === 'time') {
        if (subTimeMode === 'rel') {
          totalMins = (parseInt(document.getElementById('manualHrs').value)||0)*60 + (parseInt(document.getElementById('manualMin').value)||0);
        } else {
          const datePart = document.getElementById('absDate').value;
          const h = document.getElementById('absHour').value;
          const m = document.getElementById('absMin').value;
          if (datePart) {
            const target = new Date(`${datePart}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
            totalMins = Math.max(0, (target - new Date()) / 60000);
          }
        }
        reqM3 = sizeM3;
      } else {
        const rawFlow = parseFloat(document.getElementById('flowRate').value) || 0.001;
        let flowMinM3 = (vUnit === 'â„“') ? rawFlow / 1000 : rawFlow;
        if (tUnit === 'æ™‚') flowMinM3 /= 60;
        if (currentMode === 'size') reqM3 = sizeM3;
        else {
          const iv = parseFloat(document.getElementById('manualVol').value)||0;
          reqM3 = (vUnit === 'â„“') ? iv / 1000 : iv;
        }
        totalMins = reqM3 / flowMinM3;
      }

      const finish = new Date(Date.now() + totalMins * 60000);
      document.getElementById('finishDate').innerText = finish.toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit', weekday:'short'});
      document.getElementById('finishClock').innerText = finish.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});


      const dh = Math.floor(totalMins / 60);
      const dm = Math.round(totalMins % 60);
      
      if (currentMode === 'time') {
        // âœ… æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®šã¯æ°´é‡è¡¨ç¤ºã‚’å‡ºã•ãªã„
        document.getElementById('detailRes').innerHTML =
          `å®Œäº†ã¾ã§: ç´„${dh}æ™‚é–“${dm}åˆ†`;
      } else {
        const m3Text = reqM3.toFixed(1);
        const lText = Math.round(reqM3 * 1000).toLocaleString();
        let volDisp = (vUnit === "â„“") ? `${lText}â„“ (${m3Text}ã¥)` : `${m3Text}ã¥ (${lText}â„“)`;
      
        document.getElementById('detailRes').innerHTML =
          `å®Œäº†ã¾ã§: ç´„${dh}æ™‚é–“${dm}åˆ†<br>å¿…è¦é‡: ${volDisp} / ${m3Text}t`;
      }

      return { totalMins, reqM3 };
    }


    async function doStart() {
      const { totalMins, reqM3 } = uiCalc();
      const limitTime = Date.now() + totalMins * 60000;
    
      const payload = {
        id: Date.now(),
        facility: document.getElementById('facility').value || "æœªè¨­å®šæ–½è¨­",
        startUser: document.getElementById('startUser').value || "æœªè¨­å®šè€…",
        status: 'active',
        limitTime: limitTime,
        webhook: document.getElementById('slackUrl').value,
    
        // âœ… é‡è¦ï¼šãƒ¢ãƒ¼ãƒ‰ã‚’ä¿å­˜ï¼ˆã“ã‚ŒãŒãªã„ã¨æ—¥æ™‚æŒ‡å®šã‹å¾Œã§åˆ¤æ–­ã§ããšæ°´é‡ãŒå‡ºã‚‹ï¼‰
        inputMode: currentMode,
    
        // ğŸ”” é€šçŸ¥è¨­å®š
        settings: {
          at0: document.getElementById('at0_on').checked,
          m: document.getElementById('m_on').checked ? parseInt(document.getElementById('m_val').value) : null,
          p: document.getElementById('p_on').checked ? parseInt(document.getElementById('p_val').value) : null,
          interval: document.getElementById('interval_on').checked ? parseInt(document.getElementById('interval_val').value) : null
        }
      };
    
      // âœ… æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®šã®ã¨ãã¯æ°´é‡ã‚’é€ã‚‰ãªã„
      if (currentMode !== 'time') {
        payload.totalVolM3 = reqM3;
      }
    
      try {
        await apiFetch("/save", { payload });
        alert("ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
        location.reload();
      } catch (e) {
        alert(e.message);
      }
    }


    async function loadDataFromKV() {
      const data = await apiFetch('/load');
      const c = data?.config || {};

      if (c.webhook) document.getElementById('slackUrl').value = c.webhook;

      const gid = document.getElementById('gid').value.trim();
      const localWh = gid ? (localStorage.getItem(LS_WEBHOOK_PREFIX + gid) || '') : '';
      if (!document.getElementById('slackUrl').value && localWh) document.getElementById('slackUrl').value = localWh;

      document.getElementById('facility').value = c.facility || document.getElementById('facility').value || '';
      document.getElementById('startUser').value = c.startUser || document.getElementById('startUser').value || '';
      document.getElementById('flowRate').value = c.default_flow || document.getElementById('flowRate').value || '18';

      document.getElementById('at0_on').checked = (c.at0 !== false);
      document.getElementById('m_on').checked = !!c.m_on;
      document.getElementById('m_val').value = c.m_val || '10';
      document.getElementById('p_on').checked = !!c.p_on;
      document.getElementById('p_val').value = c.p_val || '5';
      document.getElementById('interval_on').checked = !!c.interval_on;
      document.getElementById('interval_val').value = c.interval_val || '10';

      if (c.L) document.getElementById('L').value = c.L;
      if (c.W) document.getElementById('W').value = c.W;
      if (c.D) document.getElementById('D').value = c.D;
      if (c.manualVol) document.getElementById('manualVol').value = c.manualVol;
      document.getElementById('currentPer').value = '0';
      if (c.currentMode) setMode(c.currentMode);

      monitorItems = Array.isArray(data?.pools) ? data.pools.map(normalizeItem) : [];
      updateMonitorList();
      uiCalc();
      saveCreds();
    }

    function toMs(x) {
      if (x === null || x === undefined) return null;
      if (typeof x === 'number') {
        if (x > 0 && x < 1e12) return x * 1000;
        return x;
      }
      if (typeof x === 'string') {
        const n = Number(x);
        if (!Number.isNaN(n)) return toMs(n);
        const t = Date.parse(x);
        return Number.isNaN(t) ? null : t;
      }
      return null;
    }

    function fmtDateTime(ms) {
      const d = new Date(ms);
      if (Number.isNaN(d.getTime())) return 'â€”';
      const y = d.getFullYear();
      const mo = d.getMonth() + 1;
      const da = d.getDate();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}/${mo}/${da} ${hh}:${mm}`;
    }

    function fmtTime(ms) {
      const d = new Date(ms);
      if (Number.isNaN(d.getTime())) return '--:--';
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function normalizeItem(item) {
      const x = { ...item };
      x.facility = (typeof x.facility === 'string' && x.facility.trim()) ? x.facility : 'æœªè¨­å®šæ–½è¨­';
      x.startUser = (typeof x.startUser === 'string' && x.startUser.trim()) ? x.startUser : 'æœªè¨­å®šè€…';
      if (x.stopUser !== undefined && x.stopUser !== null) {
        x.stopUser = (typeof x.stopUser === 'string' && x.stopUser.trim()) ? x.stopUser : 'æœªè¨­å®šè€…';
      }
      x.limitTimeMs = toMs(x.limitTimeMs) ?? toMs(x.limitTime);
      x.stopTimeMs = toMs(x.stopTime);
      x.createdAtMs = toMs(x.created_at) ?? toMs(x.createdAt) ?? null;
      x.totalVolM3 = (typeof x.totalVolM3 === 'number') ? x.totalVolM3 : Number(x.totalVolM3 || 0);
      if (!Number.isFinite(x.totalVolM3) || x.totalVolM3 < 0) x.totalVolM3 = 0;
      if (!x.settings || typeof x.settings !== 'object') x.settings = {};
      x.isOpen = !!x.isOpen;   // â†è¿½åŠ 
      return x;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function updateMonitorList() {
      const listDiv = document.getElementById('monitor-list');
      listDiv.innerHTML = '';
      let activeCount = 0;
    
      // æœ€æ–°é †ï¼ˆç›£è¦–ä¸­ã‚’ä¸Šã€ã‚ã¨ã¯IDé™é †ï¼‰
      monitorItems.sort((a, b) => {
        if (a.status === 'active' && b.status !== 'active') return -1;
        if (a.status !== 'active' && b.status === 'active') return 1;
        return b.id - a.id;
      });
    
      monitorItems.forEach(item => {
        const isMon = item.status === 'active';
        if (isMon) activeCount++;

        // âœ… è¿½åŠ ï¼šæ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®šãªã‚‰æ°´é‡ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‡ºã•ãªã„
        const isTimeMode = item.inputMode === 'time';
        
        const targetMs = item.limitTimeMs;
        const isOver = isMon && targetMs && Date.now() > targetMs;
        const displayMs = isMon ? targetMs : (item.stopTimeMs || targetMs);
        
        // æŒ‡ç¤ºï¼šå¹´æœˆæ—¥ã¨æ™‚é–“ã‚’ã—ã£ã‹ã‚Šè¡¨ç¤º
        const timeStr = displayMs ? fmtTime(displayMs) : '--:--';
        const dateTimeStr = displayMs ? fmtDateTime(displayMs) : 'â€”';
    
        const div = document.createElement('div');
        const isEditing = !!item.isEditing;
        
        // ç›£è¦–ä¸­ãƒ»ä¿®æ­£ä¸­ã¯å¸¸ã«å±•é–‹ã€‚å±¥æ­´ã¯ã‚¯ãƒªãƒƒã‚¯ã§ open ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        const isOpen = isMon || isEditing || item.isOpen;
        div.className = `monitor-item ${isMon ? '' : 'finished'} ${isOver ? 'danger-alert' : ''} ${isOpen ? 'open' : ''}`;
    
        // æŒ‡ç¤ºï¼šå±¥æ­´ã®ã¿ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºå®Ÿã«é–‹é–‰
        if (!isMon && !isEditing) {
          div.onclick = (e) => {
          if (e.target.closest('button') || e.target.closest('input')) return;
            item.isOpen = !item.isOpen;
            updateMonitorList();
          };
        }
    
        let html = isOver ? `<div style="background:#d32f2f; color:#fff; font-size:16px; text-align:center; padding:8px; font-weight:900; margin-bottom:10px;">ğŸš¨ æº€æ°´æ™‚åˆ»è¶…é ğŸš¨</div>` : '';
    
        if (isEditing) {
          // æŒ‡ç¤ºï¼š1å›ã§3ç®‡æ‰€ç›´ã›ã‚‹ä¿®æ­£ãƒ‘ãƒãƒ«
          html += `
            <div style="background:#fffbe6; padding:15px; border:3px solid #ECB22E; border-radius:10px;">
              <div style="margin-bottom:10px;">
                <label style="font-weight:900; font-size:14px;">æ–½è¨­å</label>
                <input id="edit-f-${item.id}" class="edit-input" value="${escapeHtml(item.facility)}" style="width:100%; padding:12px; border:2px solid #000;">
              </div>
              <div style="margin-bottom:10px;">
                <label style="font-weight:900; font-size:14px;">é–‹å§‹æ‹…å½“è€…</label>
                <input id="edit-u-${item.id}" class="edit-input" value="${escapeHtml(item.startUser)}" style="width:100%; padding:12px; border:2px solid #000;">
              </div>
              ${!isMon ? `
              <div style="margin-bottom:10px;">
                <label style="font-weight:900; font-size:14px;">çµ‚äº†æ‹…å½“è€…</label>
                <input id="edit-su-${item.id}" class="edit-input" value="${escapeHtml(item.stopUser || '')}" style="width:100%; padding:12px; border:2px solid #000;">
              </div>` : ''}
              <div style="display:flex; gap:10px; margin-top:15px;">
                <button style="flex:1; padding:15px; font-weight:900; background:#2e7d32; color:#fff; border:none; border-radius:8px;" onclick="saveEdit(${item.id})">âœ… ä¿å­˜</button>
                <button style="flex:1; padding:15px; font-weight:900; background:#eee; color:#000; border:2px solid #000; border-radius:8px;" onclick="toggleEdit(${item.id})">ä¸­æ­¢</button>
              </div>
            </div>`;
        } else {
          if (!isMon && !isOpen) {
            // å±¥æ­´ï¼ˆé–‰ã˜ã¦ã„ã‚‹æ™‚ï¼‰
            html += `
              <div class="simple-area" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;">
                <b style="font-size:20px;">${escapeHtml(item.facility)}</b>
                <span style="font-size:15px; font-weight:900; color:#444;">${dateTimeStr} åœæ­¢ â–¼</span>
              </div>`;
          } else {
            // ç›£è¦–ä¸­ ã¾ãŸã¯ å±¥æ­´ï¼ˆå±•é–‹æ™‚ï¼‰
            let volHtml = '';
            const isTimeMode = (item.inputMode || item.currentMode) === 'time';
            if (!isTimeMode && isMon && item.totalVolM3 > 0 && item.createdAtMs && targetMs) {
              const totalMs = targetMs - item.createdAtMs;
              const elapsedMs = Math.max(0, Math.min(totalMs, Date.now() - item.createdAtMs));
              const progress = totalMs > 0 ? (elapsedMs / totalMs) : 0;
              const currentVol = (item.totalVolM3 * progress);
              const remainingVol = Math.max(0, item.totalVolM3 - currentVol);
              volHtml = `
                <div style="background:#000; color:#fff; padding:12px; border-radius:8px; border:2px solid #ECB22E; margin-top:10px;">
                  <div style="font-size:14px; color:#ccc; font-weight:900; margin-bottom:5px;">çµ¦æ°´æ¸ˆ / æº€æ°´ã¾ã§ / å¿…è¦é‡</div>
                  <div style="font-size:1.8rem; font-weight:900;">
                    ${currentVol.toFixed(1)} / <span style="color:#ff5252;">${remainingVol.toFixed(1)}</span> / ${item.totalVolM3.toFixed(1)} <span style="font-size:16px;">mÂ³</span>
                  </div>
                </div>`;
            }

            let stopVolHtml = '';
            if (!isMon && !isTimeMode &&
                Number.isFinite(item.stopVolM3) &&
                Number.isFinite(item.stopRemainM3) &&
                Number.isFinite(item.stopMaxM3)) {
            
              stopVolHtml = `
                <div style="background:#111; color:#fff; padding:12px; border-radius:8px; border:2px solid #ccc; margin-top:10px;">
                  <div style="font-size:14px; color:#ccc; font-weight:900; margin-bottom:5px;">åœæ­¢æ™‚ï¼šçµ¦æ°´æ¸ˆ / æº€æ°´ã¾ã§ / å¿…è¦é‡</div>
                  <div style="font-size:1.6rem; font-weight:900;">
                    ${item.stopVolM3.toFixed(1)} / 
                    <span style="color:#ff5252;">${item.stopRemainM3.toFixed(1)}</span> / 
                    ${item.stopMaxM3.toFixed(1)}
                    <span style="font-size:16px;"> mÂ³</span>
                  </div>
                </div>`;
            }

            
            // ã€ä¿®æ­£ç®‡æ‰€ã€‘å±¥æ­´ï¼ˆå±•é–‹æ™‚ï¼‰ã®è©³ç´°ãƒ‘ãƒãƒ«éƒ¨åˆ†
            html += `
              <div class="detail-area" style="display:${isOpen ? 'block' : 'none'};">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                  <b style="font-size:24px;">${escapeHtml(item.facility)}</b>
                  <span style="font-size:12px; padding:4px 10px; background:${isMon?'#000':'#eee'}; color:${isMon?'#ECB22E':'#666'}; font-weight:900; border-radius:6px;">
                    ${isMon ? 'çµ¦æ°´ä¸­' : 'å±¥æ­´ â–²'}
                  </span>
                </div>
                <div style="background:#f0f0f0; padding:15px; border:2px solid #000; border-radius:10px;">
                    <div style="font-size:15px; font-weight:900;">
                      ${isMon ? 'åœæ­¢äºˆå®šæ™‚åˆ»' : 'åœæ­¢æ™‚åˆ»'}
                    </div>
                    
                    <!-- â˜…å†—é•·è¡¨ç¤ºæ’é™¤ï¼šæ—¥æ™‚ã¯1è¡Œã ã‘ -->
                    <div style="font-size:28px; font-weight:900; line-height:1.2; color:#000;">
                      ${dateTimeStr}
                    </div>
                  

                  
                  ${volHtml}

                </div>
                <div style="font-size:16px; color:#000; margin-top:12px; font-weight:900;">
                  æ‹…å½“: ${escapeHtml(item.startUser)}${item.stopUser ? ' â†’ ' + escapeHtml(item.stopUser) : ''}
                </div>

              </div>
              <div class="item-btns" style="display:flex; gap:10px; margin-top:15px;">
                <button style="flex:1; padding:15px; font-weight:900; background:#eee; color:#000; border:2px solid #000; border-radius:8px;" onclick="toggleEdit(${item.id}); event.stopPropagation();">å†…å®¹ä¿®æ­£</button>
                ${isMon
                  ? `<button style="flex:1; padding:15px; font-weight:900; background:#d32f2f; color:#fff; border:none; border-radius:8px;" onclick="doStop(${item.id}); event.stopPropagation();">çµ¦æ°´åœæ­¢</button>`
                  : `<button style="flex:1; padding:15px; font-weight:900; background:#2e7d32; color:#fff; border:none; border-radius:8px;" onclick="doResume(${item.id}); event.stopPropagation();">ç›£è¦–å†é–‹</button>`
                }
                <button style="width:60px; background:#fff; border:2px solid #ccc; border-radius:8px;" onclick="doDelete(${item.id}); event.stopPropagation();">ğŸ—‘ï¸</button>
              </div>`;
          }
        }
        div.innerHTML = html;
        listDiv.appendChild(div);
      });
      document.getElementById('top-alert').style.display = activeCount > 0 ? 'block' : 'none';
    }

    function toggleEdit(id) {
      const item = monitorItems.find(i => i.id === id);
      if (!item) return;
    
      // promptã¯ä¸€åˆ‡å‡ºã•ãšã€ãƒ•ãƒ©ã‚°ã ã‘åˆ‡ã‚Šæ›¿ãˆã¦å†æç”»
      item.isEditing = !item.isEditing;
      updateMonitorList();
    }

    async function saveEdit(id) {
      const item = monitorItems.find(i => i.id === id);
      const facility = document.getElementById(`edit-f-${id}`).value;
      const startUser = document.getElementById(`edit-u-${id}`).value;
      const stopUserEl = document.getElementById(`edit-su-${id}`);
      const stopUser = stopUserEl ? stopUserEl.value : "";
    
      if (!facility || !startUser) {
        alert("å¿…é ˆé …ç›®ãŒç©ºã§ã™");
        return;
      }
    
      try {
        // ã‚µãƒ¼ãƒãƒ¼æ›´æ–°
        await apiFetch("/update-item", {
          poolId: id,
          facility: facility,
          startUser: startUser,
          stopUser: stopUser
        });
    
        // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        item.facility = facility;
        item.startUser = startUser;
        item.stopUser = stopUser;
        item.isEditing = false;
        
        updateMonitorList();
      } catch (e) {
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    }

    // ===== doStop(id) ã“ã“ã‹ã‚‰ä¸¸ã”ã¨å·®ã—æ›¿ãˆ =====
    async function doStop(id) {
      const stopUser = document.getElementById('startUser').value || "æœªè¨­å®šè€…";
      if (!confirm("çµ¦æ°´ã‚’åœæ­¢ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
    
      // âœ… å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ï¼ˆåœæ­¢æ™‚ç‚¹ã®æ°´é‡ã‚’è¨ˆç®—ã™ã‚‹ï¼‰
      const item = monitorItems.find(x => x.id === id);
    
      // stopæ™‚ã«è¿½åŠ ã§é€ã‚‹æƒ…å ±
      const extra = {};
    
      // âœ… æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®šã¯æ°´é‡ã‚’æ®‹ã•ãªã„ï¼ˆé€ã‚‰ãªã„ï¼‰
      const isTimeMode = (item && item.inputMode === 'time');
    
      if (item && !isTimeMode && item.totalVolM3 > 0) {
        const targetMs = item.limitTimeMs || item.limitTime;
    
        const startMs =
          item.createdAtMs ||
          (item.created_at ? new Date(item.created_at).getTime() : null);
    
        if (targetMs && startMs && targetMs > startMs) {
          const totalMs = targetMs - startMs;
          const elapsedMs = Math.max(0, Math.min(totalMs, Date.now() - startMs));
          const progress = elapsedMs / totalMs;
    
          const stopVol = item.totalVolM3 * progress;
          const stopRemain = Math.max(0, item.totalVolM3 - stopVol);
    
          extra.stopVolM3 = Number(stopVol.toFixed(1));
          extra.stopRemainM3 = Number(stopRemain.toFixed(1));
          extra.stopMaxM3 = Number(item.totalVolM3.toFixed(1));
        }
      }
    
      try {
        await apiFetch("/stop", {
          poolId: id,
          stopUser: stopUser,
          ...extra
        });
        location.reload();
      } catch (e) {
        alert("åœæ­¢ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    }
    // ===== doStop(id) ã“ã“ã¾ã§ =====

    async function doResume(id) {
      saveCreds();
      if (!confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆé€šçŸ¥è¨­å®šã‚‚ç¶™ç¶šã•ã‚Œã¾ã™ï¼‰')) return;
      try {
        await apiFetch('/resume', { poolId: id });
        saveCreds();
        await syncData();
      } catch (e) {
        alert('å†é–‹ã‚¨ãƒ©ãƒ¼: ' + (e?.message || e));
      }
    }

    async function doDelete(id) {
      saveCreds();
      if (!confirm('å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await apiFetch('/delete', { poolId: id });
        saveCreds();
        await syncData();
      } catch (e) {
        alert(e?.message || e);
      }
    }

    async function init() {
      restoreCreds();
      uiCalc();

      const gid = document.getElementById('gid').value.trim();
      const gpw = document.getElementById('gpw').value.trim();
      if (gid && gpw) {
        try { await syncData(); } catch (_) {}
      }

      setInterval(updateMonitorList, 30000);
    }
  </script>
</body>
</html>
















