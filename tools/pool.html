<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´ç›£è¦–ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9V96DZHTH1');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

    
    <style>
        :root { --main: #4A154B; --active: #ECB22E; --bg: #f4f7f9; --stop: #d32f2f; --alert: #ff5252; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 8px; margin: 0; font-size: 14px; }
        #top-alert {
            background: var(--alert);
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            position: sticky; 
            top: 58px; /* ğŸ”” ã“ã“ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´ */
            z-index: 40; /* ğŸ”” ãƒ˜ãƒƒãƒ€ãƒ¼(z-50)ã‚ˆã‚Šå°‘ã—èƒŒé¢ã«è¨­å®š */
            border-radius: 0 0 10px 10px;
            margin: 0 -8px 10px -8px; /* marginã®èª¿æ•´ */
            display: none;
        }
        .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--main); border-left: 4px solid var(--main); padding-left: 8px; }
        .selector-row { display: flex; justify-content: space-around; padding: 8px; background: #eee; border-radius: 8px; align-items: center; margin-top: 10px; }
        .selector-row label { display: flex; align-items: center; font-size: 14px; font-weight: bold; cursor: pointer; color: #333; margin: 0; }
        .selector-row input { width: auto; margin-right: 4px; }
        .tab-group { display: flex; gap: 4px; margin: 10px 0; background: #ddd; padding: 2px; border-radius: 6px; }
        .tab { flex: 1; text-align: center; padding: 8px 4px; font-size: 11px; border-radius: 4px; cursor: pointer; border: none; background: none; font-weight: bold; color: #555; }
        .tab.active { background: white; color: var(--main); }
        .sub-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .sub-toggle button { font-size: 11px; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .sub-toggle button.active { background: #666; color: #fff; border-color: #666; }
        label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 2px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 8px; background: #fff; }
        .grid-3 { display: flex; gap: 4px; }
        .grid-3 div { flex: 1; }
        .result-panel { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 12px; margin: 10px 0; text-align: center; color: #2e7d32; min-height: 110px; display: flex; flex-direction: column; justify-content: center; }
        .finish-time { font-size: 32px; font-weight: bold; display: block; line-height: 1.2; color: #1b5e20; }
        .monitor-item { border-left: 5px solid var(--active); padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .item-btns { display: flex; gap: 5px; margin-top: 8px; }
        .btn-sm { flex: 1; padding: 8px; font-size: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--stop); }
        .btn-blue { background: #2196F3; }
        .btn-gray { background: #777; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 17px; cursor: pointer; color: white; margin-top: 10px; background: var(--main); }
        .hidden { display: none !important; }
        .edit-input { font-size: 12px; padding: 5px; margin-bottom: 4px; width: 100%; border: 1px solid var(--active); }
        /* å±é™ºãªè­¦å‘Šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .danger-alert {
            background: #fff0f0 !important;
            border: 2px solid #ff0000 !important;
            animation: blink 1s infinite;
        }
        .alert-banner {
            background: #ff0000;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 4px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .text-danger { color: #ff0000; font-weight: bold; font-size: 1.2rem; }

        /* æ—¥ä»˜å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
        .day-label {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
            vertical-align: middle;
        }
        .label-today { background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; } /* ä»Šæ—¥ã¯é’ç³» */
        .label-tomorrow { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; } /* æ˜æ—¥ã¯ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
        .label-future { background: #f3e5f5; color: #7b1fa2; border: 1px solid #7b1fa2; } /* æ˜å¾Œæ—¥ä»¥é™ã¯ç´«ç³» */
        
        .time-focus {
            font-size: 1.5rem; /* æ™‚åˆ»ã‚’å¤§ãã */
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        @keyframes blink {
            0% { box-shadow: 0 0 0px #ff0000; }
            50% { box-shadow: 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 0px #ff0000; }
        }
        /* æŠ˜ã‚ŠãŸãŸã¿ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .monitor-item.finished {
            padding: 8px 12px;
            cursor: pointer;
            background: #fcfcfc;
        }
        .monitor-item.finished .detail-content {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .monitor-item.finished.open .detail-content {
            display: block; /* ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º */
        }
        .expand-icon::after { content: ' â–¼'; font-size: 10px; color: #999; }
        .open .expand-icon::after { content: ' â–²'; }

        /* ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .edit-input {
            display: block;
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 2px;
        }
        
        /* ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è©³ç´°ã‚’å¼·åˆ¶è¡¨ç¤º */
        .monitor-item.open .detail-content {
            display: block !important;
        }
                
    </style>
</head>
<body>

<body onload="init()">

<nav class="bg-white border-b border-slate-200 py-4 px-6 sticky top-0 z-50">
  <div class="container mx-auto" style="max-width:1100px; display: flex; justify-content: space-between; align-items: center;">
    
    <a href="../index.html" class="flex items-center font-bold text-lg text-blue-700" style="text-decoration:none; display: flex; align-items: center; white-space: nowrap;">
      <span style="margin-right:8px;">ğŸ </span> PocketPortal
    </a>
    
    <div style="flex: 1; text-align: right;">
      <a href="./index.html" class="text-slate-400 hover:text-blue-500 transition-colors" style="text-decoration:none; font-size: 10px; margin-left: auto;">
        Webä¾¿åˆ©ãƒ„ãƒ¼ãƒ«é›†ã¸
      </a>
    </div>
    
  </div>
</nav>

    
<div id="top-alert">âš ï¸ çµ¦æ°´ç›£è¦–ä¸­</div>

<div class="container" style="max-width: 600px; margin: 0 auto;">
    
<div class="card">
    <div class="card">
        <div style="display: flex; gap: 4px; align-items: flex-end;">
        <div style="flex:1;"><label>åŒæœŸID</label><input type="password" id="gid" placeholder="ID" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:1;"><label>PASS</label><input type="password" id="gpw" placeholder="PASS" onfocus="this.type='text'" onblur="this.type='password'"></div>
        <div style="flex:0.7; margin-bottom:8px;">
            <button onclick="loadDataFromKV()" class="btn-sm btn-blue" style="height:40px; width:100%;">åŒæœŸ</button>
        </div>
        <div style="flex:0.5; margin-bottom:8px;"><button onclick="toggleConfig()" style="font-size:10px; height:40px; padding:5px;">è¨­å®šâš™</button></div>
    </div>
    
    <div id="config-area" class="hidden" style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px;">
        <label>Slack Webhook URL</label>
        <input type="password" id="slackUrl" placeholder="https://hooks.slack.com/..." onfocus="this.type='text'" onblur="this.type='password'">

        <div class="setting-item" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
            <label style="color: var(--main); margin-bottom: 10px; display: block;">ğŸ”” é€šçŸ¥è¨­å®šï¼ˆåˆæœŸå€¤ã¨ã—ã¦ä¿å­˜å¯èƒ½ï¼‰</label>
            
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="at0_on" style="width: 20px; height: 20px;">
                <span style="margin-left: 8px;">æº€æ°´äºˆå®šæ™‚åˆ»ã«é€šçŸ¥</span>
            </div>
        
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="m_on" style="width: 20px; height: 20px;">
                <span style="margin-left: 8px;">æº€æ°´ã® <input type="number" id="m_val" value="10" style="width:45px; padding:2px;"> åˆ†å‰ã«äºˆå‘Š</span>
            </div>
        
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="p_on" style="width: 20px; height: 20px;">
                <span style="margin-left: 8px;">æº€æ°´ã‹ã‚‰ <input type="number" id="p_val" value="5" style="width:45px; padding:2px;"> åˆ†éããŸã‚‰è­¦å‘Š</span>
            </div>
        
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="interval_on" style="width: 20px; height: 20px;">
                <span style="margin-left: 8px;">è¶…éä¸­ <input type="number" id="interval_val" value="10" style="width:45px; padding:2px;"> åˆ†ãŠãã«å†é€šçŸ¥</span>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <a href="user_reg.html" style="font-size: 11px; color: #2196F3;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/PASSç™»éŒ²ç”»é¢ã¸</a>
            <a href="help.html" style="font-size: 11px; color: #2196F3;">â“ ãƒ˜ãƒ«ãƒ—</a>
        </div>
        <button onclick="saveInitialData()" class="btn-sm btn-blue" style="margin-top:10px; width:100%;">ã“ã®è¨­å®šã‚’åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ²</button>
    </div>

    <div class="selector-row">
        <label><input type="radio" name="unit" value="ã¥" checked onchange="convertVolUnit('ã¥')"> ã¥</label>
        <label><input type="radio" name="unit" value="â„“" onchange="convertVolUnit('â„“')"> â„“</label>
        <label><input type="radio" name="unit" value="t" onchange="convertVolUnit('t')"> t</label>
        <div style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></div>
        <label><input type="radio" name="t_unit" value="åˆ†" onchange="convertTimeUnit('åˆ†')"> /åˆ†</label>
        <label><input type="radio" name="t_unit" value="æ™‚" checked onchange="convertTimeUnit('æ™‚')"> /æ™‚</label>
    </div>
</div>

<div class="card">
    <h3>ğŸŒŠ çµ¦æ°´ç™»éŒ²</h3>
    <div class="tab-group">
        <button id="tab-size" class="tab active" onclick="setMode('size')">ã‚µã‚¤ã‚ºå…¥åŠ›</button>
        <button id="tab-vol" class="tab" onclick="setMode('vol')">æ°´é‡ç›´æ¥</button>
        <button id="tab-time" class="tab" onclick="setMode('time')">æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®š</button>
    </div>

    <div id="flow-input-area">
        <label id="flowLabel">çµ¦æ°´èƒ½åŠ› (ã¥/æ™‚)</label>
        <input type="number" id="flowRate" value="18" oninput="uiCalc()">
    </div>

    <div id="mode-size">
        <div class="grid-3">
            <div><label>é•·ã•(m)</label><input type="number" id="L" value="25" oninput="uiCalc()"></div>
            <div><label>å¹…(m)</label><input type="number" id="W" value="12" oninput="uiCalc()"></div>
            <div><label>æ·±ã•(m)</label><input type="number" id="D" value="1.2" oninput="uiCalc()"></div>
        </div>
        <label>ç¾åœ¨é‡ (%)</label>
        <input type="number" id="currentPer" value="0" oninput="uiCalc()">
    </div>

    <div id="mode-vol" class="hidden">
        <label id="manualVolLabel">å¿…è¦æ°´é‡ (ã¥)</label>
        <input type="number" id="manualVol" value="360" oninput="uiCalc()">
    </div>

    <div id="mode-time" class="hidden">
        <div class="sub-toggle">
            <button id="sub-rel" class="active" onclick="setSubTimeMode('rel')">æ®‹ã‚Šæ™‚é–“</button>
            <button id="sub-abs" onclick="setSubTimeMode('abs')">å®Œäº†æ—¥æ™‚ã§æŒ‡å®š</button>
        </div>
        <div id="time-rel-area">
            <div class="grid-3">
                <div style="flex:1;"><label>æ™‚é–“</label><input type="number" id="manualHrs" value="5" oninput="uiCalc()"></div>
                <div style="flex:1;"><label>åˆ†</label><input type="number" id="manualMin" value="0" oninput="uiCalc()"></div>
            </div>
        </div>
        <div id="time-abs-area" class="hidden">
            <div class="grid-3">
                <div style="flex:1.5;"><label>å®Œäº†æ—¥</label><input type="date" id="absDate" onchange="uiCalc()"></div>
                <div><label>æ™‚</label><select id="absHour" onchange="uiCalc()"></select></div>
                <div><label>åˆ†</label><select id="absMin" onchange="uiCalc()"></select></div>
            </div>
        </div>
    </div>

    <div class="result-panel">
        <span id="finishDate" style="font-weight:bold;">----/--/--</span>
        <span id="finishClock" class="finish-time">--:--</span>
        <div id="detailRes" style="font-size:13px; font-weight:bold; margin-top:5px;"></div>
    </div>

    <div class="grid-3">
        <div style="flex:2"><label>æ–½è¨­å</label><input type="text" id="facility" placeholder="æ–½è¨­å"></div>
        <div style="flex:1"><label>æ‹…å½“è€…</label><input type="text" id="startUser" placeholder="åå‰"></div>
    </div>
    <button class="btn-main" onclick="doStart()">ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="monitor-list-area" class="card">
    <h3>ğŸ“¡ ç›£è¦–çŠ¶æ³(slackã‚‚ã”ç¢ºèªãã ã•ã„)</h3>
    <div id="monitor-list"></div>
</div>

    <!-- Bottom Ads (given) -->
    <div class="bottom-ads">
      <p class="text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">Sponsor Link</p>
      <div class="box bg-white p-1 rounded shadow-sm">
        <script type="text/javascript">
          rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770128068587";
        </script>
        <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>

        <script type="text/javascript">
          rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ranking";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770559441426";
        </script>
        <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
      </div>
    </div>
  </div>

    
<script>
    let currentMode = 'size';
    let subTimeMode = 'rel';
    let lastVolUnit = 'ã¥';
    let lastTimeUnit = 'æ™‚';
    let monitorItems = [];

    // æ—¥æ™‚æŒ‡å®šç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
    const hSelect = document.getElementById('absHour');
    for(let i=0; i<24; i++) hSelect.add(new Option(i, i));
    const mSelect = document.getElementById('absMin');
    for(let i=0; i<60; i++) mSelect.add(new Option(i, i));


    // --- è¨­å®šã‚¨ãƒªã‚¢ã®é–‹é–‰ ---
    function toggleConfig() {
        document.getElementById('config-area').classList.toggle('hidden');
    }

    // --- è¨­å®šå€¤ã€Webhookã‚’IDã¨PASSã«åˆã‚ã›ã¦åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ² (DBä¿å­˜ç”¨) ---
    async function saveInitialData() {
        const configPayload = {
            webhook: document.getElementById('slackUrl').value,
            facility: document.getElementById('facility').value,
            startUser: document.getElementById('startUser').value,
            unit_vol: document.querySelector('input[name="unit"]:checked').value,
            unit_time: document.querySelector('input[name="t_unit"]:checked').value,
            default_flow: document.getElementById('flowRate').value,


            // ğŸ”” é€šçŸ¥è¨­å®šã‚‚åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
            at0: document.getElementById('at0_on').checked,
            m_on: document.getElementById('m_on').checked,
            m_val: document.getElementById('m_val').value,
            p_on: document.getElementById('p_on').checked,
            p_val: document.getElementById('p_val').value,
            interval_on: document.getElementById('interval_on').checked,
            interval_val: document.getElementById('interval_val').value,
            
            // ğŸŸ¢ ã“ã“ãŒé‡è¦ï¼šã‚µã‚¤ã‚ºã¨ç›´æ¥æ°´é‡ã‚’ä¿å­˜å¯¾è±¡ã«è¿½åŠ 
            L: document.getElementById('L').value,
            W: document.getElementById('W').value,
            D: document.getElementById('D').value,
            manualVol: document.getElementById('manualVol').value,
            
            // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ–ï¼‰ã‚‚ä¿å­˜
            currentMode: currentMode 
        };
    
        try {
            await apiFetch("/save-config", { configPayload: configPayload });
            alert("åˆæœŸå€¤ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
        } catch (e) { alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    function convertVolUnit(newUnit) {
        const inputs = ['flowRate', 'manualVol'];
        inputs.forEach(id => {
            let val = parseFloat(document.getElementById(id).value);
            if (isNaN(val)) return;
            let m3Val = (lastVolUnit === 'â„“') ? val / 1000 : val; 
            document.getElementById(id).value = (newUnit === 'â„“') ? (m3Val * 1000) : m3Val;
        });
        lastVolUnit = newUnit;
        uiCalc();
    }

    function convertTimeUnit(newUnit) {
        if (lastTimeUnit === newUnit) return;
        let val = parseFloat(document.getElementById('flowRate').value);
        if (!isNaN(val)) {
            if (newUnit === 'åˆ†') document.getElementById('flowRate').value = (val / 60).toFixed(2);
            else document.getElementById('flowRate').value = (val * 60).toFixed(1);
        }
        lastTimeUnit = newUnit;
        uiCalc();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + m).classList.add('active');
        ['mode-size', 'mode-vol', 'mode-time'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('mode-' + m).classList.remove('hidden');
        document.getElementById('flow-input-area').classList.toggle('hidden', m === 'time');
        uiCalc();
    }

    function setSubTimeMode(sm) {
        subTimeMode = sm;
        document.getElementById('sub-rel').classList.toggle('active', sm === 'rel');
        document.getElementById('sub-abs').classList.toggle('active', sm === 'abs');
        document.getElementById('time-rel-area').classList.toggle('hidden', sm === 'abs');
        document.getElementById('time-abs-area').classList.toggle('hidden', sm === 'rel');
        if(sm === 'abs') {
            const now = new Date();
            document.getElementById('absDate').value = now.toISOString().split('T')[0];
            document.getElementById('absHour').value = now.getHours();
            document.getElementById('absMin').value = now.getMinutes();
        }
        uiCalc();
    }



    const WORKER_URL = "https://pool-api.nogray.workers.dev/api"; // â˜…è¦æ›¸ãæ›ãˆ

    // å…±é€šé€šä¿¡é–¢æ•° (Workerå´ã®èªè¨¼ã«å¯¾å¿œ)
    async function apiFetch(endpoint, payload = {}) {
        const gid = document.getElementById('gid').value.trim();
        const gpw = document.getElementById('gpw').value.trim();
        if (!gid || !gpw) throw new Error("è¨­å®šã‹ã‚‰IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const response = await fetch(`${WORKER_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gid, gpw, ...payload })
        });
        if (!response.ok) throw new Error(await response.text());
        return await response.json();
    }







    function uiCalc() {
        const vUnit = document.querySelector('input[name="unit"]:checked').value;
        const tUnit = document.querySelector('input[name="t_unit"]:checked').value;
        document.getElementById('flowLabel').innerText = `çµ¦æ°´èƒ½åŠ› (${vUnit}/${tUnit})`;
        document.getElementById('manualVolLabel').innerText = `å¿…è¦æ°´é‡ (${vUnit})`;

        let totalMins = 0; let reqM3 = 0;
        const sizeM3 = (parseFloat(document.getElementById('L').value)||0) * (parseFloat(document.getElementById('W').value)||0) * (parseFloat(document.getElementById('D').value)||0) * (1 - (parseFloat(document.getElementById('currentPer').value)||0)/100);

        if (currentMode === 'time') {
            if (subTimeMode === 'rel') {
                totalMins = (parseInt(document.getElementById('manualHrs').value)||0)*60 + (parseInt(document.getElementById('manualMin').value)||0);
            } else {
                const datePart = document.getElementById('absDate').value;
                const h = document.getElementById('absHour').value;
                const m = document.getElementById('absMin').value;
                if(datePart) {
                    const target = new Date(`${datePart}T${h.padStart(2,'0')}:${m.padStart(2,'0')}:00`);
                    totalMins = Math.max(0, (target - new Date()) / 60000);
                }
            }
            reqM3 = sizeM3; 
        } else {
            const rawFlow = parseFloat(document.getElementById('flowRate').value) || 0.001;
            let flowMinM3 = (vUnit === 'â„“') ? rawFlow / 1000 : rawFlow;
            if (tUnit === 'æ™‚') flowMinM3 /= 60;
            if (currentMode === 'size') reqM3 = sizeM3;
            else {
                const iv = parseFloat(document.getElementById('manualVol').value)||0;
                reqM3 = (vUnit === 'â„“') ? iv / 1000 : iv;
            }
            totalMins = reqM3 / flowMinM3;
        }

        const finish = new Date(Date.now() + totalMins * 60000);
        document.getElementById('finishDate').innerText = finish.toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit', weekday:'short'});
        document.getElementById('finishClock').innerText = finish.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
        
        const dh = Math.floor(totalMins / 60);
        const dm = Math.round(totalMins % 60);
        const m3Text = reqM3.toFixed(1);
        const lText = Math.round(reqM3 * 1000).toLocaleString();
        let volDisp = (vUnit === "â„“") ? `${lText}â„“ (${m3Text}ã¥)` : `${m3Text}ã¥ (${lText}â„“)`;

        document.getElementById('detailRes').innerHTML = `å®Œäº†ã¾ã§: ç´„${dh}æ™‚é–“${dm}åˆ†<br>å¿…è¦é‡: ${volDisp} / ${m3Text}t`;
        return { totalMins, reqM3 };
    }




        // ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚
        async function doStart() {
            const { totalMins, reqM3 } = uiCalc();
            const limitTime = Date.now() + totalMins * 60000;
            
            const payload = {
                id: Date.now(),
                facility: document.getElementById('facility').value || "æœªè¨­å®šæ–½è¨­",
                startUser: document.getElementById('startUser').value || "æœªè¨­å®šè€…",
                status: 'active',
                limitTime: limitTime,
                totalVolM3: reqM3,
                webhook: document.getElementById('slackUrl').value,
                // ğŸ”” ã“ã“ã‚’ç”»é¢ä¸Šã®è¨­å®šå€¤ã§é€ã‚‹ã‚ˆã†ã«ä¿®æ­£
                settings: {
                    at0: document.getElementById('at0_on').checked,
                    m: document.getElementById('m_on').checked ? parseInt(document.getElementById('m_val').value) : null,
                    p: document.getElementById('p_on').checked ? parseInt(document.getElementById('p_val').value) : null,
                    interval: document.getElementById('interval_on').checked ? parseInt(document.getElementById('interval_val').value) : null
                }
            };
        
            try {
                await apiFetch("/save", { payload });
                alert("ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
                location.reload();
            } catch (e) { alert(e.message); }
        }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    window.addEventListener('load', async () => {
        document.getElementById('gid').value = localStorage.getItem('water_gid') || '';
        document.getElementById('gpw').value = localStorage.getItem('water_gpw') || '';

        if (document.getElementById('gid').value && document.getElementById('gpw').value) {
            try {
                const data = await apiFetch("/load");
                if (data.config) document.getElementById('slackUrl').value = data.config.webhook || "";
                monitorItems = data.pools || [];
                updateMonitorList();
            } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"); }
        }
        uiCalc();
    });



    // KVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ç”»é¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    async function loadDataFromKV() {
        const gid = document.getElementById('gid').value.trim();
        const gpw = document.getElementById('gpw').value.trim();
        if (!gid || !gpw) return;
    
        try {
            const data = await apiFetch("/load");
            if (data.config) {
                const c = data.config;
                
                // æ—¢å­˜ã®åæ˜ 
                if (c.webhook) document.getElementById('slackUrl').value = c.webhook;
                document.getElementById('facility').value = c.facility || "";
                document.getElementById('startUser').value = c.startUser || "";
                document.getElementById('flowRate').value = c.default_flow || "18";


                // é€šçŸ¥è¨­å®šã®åæ˜ ï¼ˆã“ã“ãŒåæ˜ ã•ã‚Œã¦ã„ãªã‹ã£ãŸéƒ¨åˆ†ã§ã™ï¼‰
                document.getElementById('slackUrl').value = c.webhook || "";
                document.getElementById('at0_on').checked = c.at0 !== false; // configå†…ã®at0ã‚’å‚ç…§
                document.getElementById('m_on').checked = !!c.m_on;
                document.getElementById('m_val').value = c.m_val || "10";
                document.getElementById('p_on').checked = !!c.p_on;
                document.getElementById('p_val').value = c.p_val || "5";
                document.getElementById('interval_on').checked = !!c.interval_on;
                document.getElementById('interval_val').value = c.interval_val || "10";
                
                // ğŸŸ¢ æ‹¡å¼µã—ãŸé …ç›®ã®åæ˜ 
                if(c.L) document.getElementById('L').value = c.L;
                if(c.W) document.getElementById('W').value = c.W;
                if(c.D) document.getElementById('D').value = c.D;
                if(c.manualVol) document.getElementById('manualVol').value = c.manualVol;
                document.getElementById('currentPer').value = "0"; // ç¾åœ¨é‡ã¯å¸¸ã«0
    
                // ğŸŸ¢ ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ–ï¼‰ã®å¾©å…ƒ
                if(c.currentMode) setMode(c.currentMode);
    
                // ğŸŸ¢ æ™‚é–“æŒ‡å®šã®å ´åˆã®åˆæœŸåŒ–ï¼ˆç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆï¼‰
                if(c.currentMode === 'time') {
                    document.getElementById('manualHrs').value = "0";
                    document.getElementById('manualMin').value = "0";
                    const now = new Date();
                    document.getElementById('absDate').value = now.toISOString().split('T')[0];
                    document.getElementById('absHour').value = now.getHours();
                    document.getElementById('absMin').value = now.getMinutes();
                }
            }
            
            monitorItems = data.pools || [];
            updateMonitorList();


            // loadDataFromKV ã®æˆåŠŸå‡¦ç†å†…ï¼ˆãƒ‡ãƒ¼ã‚¿ã®åæ˜ ãŒçµ‚ã‚ã£ãŸå¾Œï¼‰ã«é…ç½®
            const now = new Date();
            const syncStatusEl = document.getElementById('sync-status');
            const syncBtn = document.querySelector('button[onclick="loadDataFromKV()"]');
            
            // æ—¥ä»˜åˆ¤å®šç”¨ã®è¨ˆç®—
            const today = new Date();
            today.setHours(0,0,0,0);
            const loadDay = new Date(now);
            loadDay.setHours(0,0,0,0);
            
            const diffDays = Math.round((loadDay - today) / (1000 * 60 * 60 * 24));
            
            // 1. åŒæœŸãƒœã‚¿ãƒ³ã®è­¦å‘Šè¡¨ç¤ºï¼ˆä»Šæ—¥ã§ã¯ãªã„å ´åˆï¼‰
            if (diffDays !== 0) {
                // ä»Šæ—¥ä»¥å¤–ï¼ˆæ˜¨æ—¥ä»¥å‰ãªã©ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ãªã‚‰ãƒœã‚¿ãƒ³ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«ã—ã¦è­¦å‘Š
                syncBtn.style.background = "#ef6c00"; 
                syncBtn.style.color = "white";
                syncBtn.style.fontWeight = "bold";
                syncBtn.innerHTML = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ãã ã•ã„";
            } else {
                // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãªã‚‰é€šå¸¸ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå…ƒã®CSSã«å¾“ã†ï¼‰
                syncBtn.style.background = ""; 
                syncBtn.style.color = "";
                syncBtn.style.fontWeight = "";
                syncBtn.innerHTML = "åŒæœŸ";
            }
            
            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡å­—ã®æ›´æ–°
            let dateLabel = "";
            if (diffDays === 0) {
                dateLabel = `<span class="day-label label-today">ä»Šæ—¥</span>`;
            } else if (diffDays === -1) {
                dateLabel = `<span class="day-label label-future" style="background:#666; color:white;">æ˜¨æ—¥</span>`;
            } else {
                dateLabel = `<span class="day-label label-future">${now.getMonth()+1}/${now.getDate()}</span>`;
            }
            
            syncStatusEl.innerHTML = `è¡¨ç¤ºä¸­: ${dateLabel} <b>${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}</b> æ™‚ç‚¹`;
            


            
            uiCalc(); // å…¨ã¦ã‚»ãƒƒãƒˆã—ãŸå¾Œã«è¨ˆç®—ã‚’å®Ÿè¡Œ
        } catch (e) { console.error("åŒæœŸå¤±æ•—:", e.message); }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', async () => {
        // ä¿å­˜ã•ã‚ŒãŸID/PASSãŒã‚ã‚Œã°å¾©å…ƒ
        document.getElementById('gid').value = localStorage.getItem('water_gid') || '';
        document.getElementById('gpw').value = localStorage.getItem('water_gpw') || '';
        
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•ã§1å›èª­ã¿è¾¼ã¿ã«è¡Œã
        if (document.getElementById('gid').value && document.getElementById('gpw').value) {
            await loadDataFromKV();
        }
        uiCalc();
    });


function updateMonitorList() {
    const listDiv = document.getElementById('monitor-list');
    listDiv.innerHTML = '';
    const now = new Date();
    let activeCount = 0;

    // ä¸¦ã¹æ›¿ãˆï¼šç›£è¦–ä¸­ãŒä¸Šã€ã‹ã¤æœ€æ–°é †
    monitorItems.sort((a, b) => {
        if (a.status === 'active' && b.status !== 'active') return -1;
        if (a.status !== 'active' && b.status === 'active') return 1;
        return b.id - a.id;
    });

    monitorItems.forEach(item => {
        const isMon = item.status === 'active';
        if (isMon) activeCount++;
        
        const targetTimeMs = item.limitTimeMs || item.limitTime;
        const targetDate = new Date(isMon ? targetTimeMs : item.stopTime);
        const isOver = (isMon && Date.now() > targetTimeMs);

        // --- æ—¥ä»˜ãƒãƒƒã‚¸åˆ¤å®š ---
        const today = new Date(); today.setHours(0,0,0,0);
        const targetDay = new Date(targetDate); targetDay.setHours(0,0,0,0);
        const diffDays = Math.round((targetDay - today) / (1000 * 60 * 60 * 24));
        let dateHtml = diffDays === 0 ? `<span class="day-label label-today">ä»Šæ—¥</span>` : 
                       diffDays === 1 ? `<span class="day-label label-tomorrow">æ˜æ—¥</span>` : 
                       `<span class="day-label label-future">${targetDate.getMonth()+1}/${targetDate.getDate()}</span>`;

        const div = document.createElement('div');
        // ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯å¼·åˆ¶çš„ã« 'open' ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã¦é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹
        const openClass = (isMon || item.isEditing) ? 'open' : '';
        div.className = `monitor-item ${isMon ? '' : 'finished'} ${isOver ? 'danger-alert' : ''} ${openClass}`;
        
        // --- ä¿®æ­£ï¼ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ¶å¾¡ ---
        div.onclick = (e) => {
            // ç›£è¦–ä¸­ã€ã¾ãŸã¯ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ä½•ã‚‚ã—ãªã„
            if (isMon || item.isEditing) return;
            // ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã‚‚ä½•ã‚‚ã—ãªã„ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­é˜²æ­¢ï¼‰
            if (e.target.closest('button') || e.target.closest('input')) return;
            
            div.classList.toggle('open');
        };

        // --- è¡¨ç¤ºå†…å®¹ã®çµ„ã¿ç«‹ã¦ ---
        let userDisplay = "";
        if (item.isEditing) {
            // ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå…¥åŠ›æ¬„ã‚’ã—ã£ã‹ã‚Šå‡ºã™ï¼‰
            userDisplay = `
                <div style="background:#fffbe6; padding:8px; border-radius:5px; border:1px solid #ffe58f;">
                    <label style="font-size:10px; color:#888;">æ–½è¨­å</label>
                    <input id="edit-f-${item.id}" class="edit-input" value="${item.facility}" style="width:100%; margin-bottom:8px;">
                    <label style="font-size:10px; color:#888;">é–‹å§‹æ‹…å½“</label>
                    <input id="edit-u-${item.id}" class="edit-input" value="${item.startUser}" style="width:100%; margin-bottom:8px;">
                    ${!isMon ? `
                        <label style="font-size:10px; color:#888;">çµ‚äº†æ‹…å½“</label>
                        <input id="edit-su-${item.id}" class="edit-input" value="${item.stopUser || ''}" style="width:100%;">
                    ` : ''}
                </div>`;
        } else {
            // é€šå¸¸è¡¨ç¤º
            userDisplay = `
                <span style="font-size:16px; font-weight:bold;">${item.facility}</span>
                ${!isMon ? `<div style="font-size:12px; color:#666;">${dateHtml} åœæ­¢: <b>${targetDate.getHours()}:${String(targetDate.getMinutes()).padStart(2,'0')}</b> <span class="expand-icon"></span></div>` : ''}
            `;
        }

        div.innerHTML = `
            ${isOver ? '<div class="alert-banner">âš ï¸ æº€æ°´æ™‚é–“ã‚’è¶…éã—ã¦ã„ã¾ã™ï¼</div>' : ''}
            <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                <div style="flex:1;">${userDisplay}</div>
                <span style="color:${isMon ? '#2196F3' : '#999'}; font-size:11px; white-space:nowrap; margin-left:10px;">${isMon ? 'ğŸ”µ ç›£è¦–ä¸­' : 'âšª åœæ­¢æ¸ˆ'}</span>
            </div>

            <div class="detail-content" style="${(isMon || item.isEditing) ? 'display:block;' : ''}">
                <div style="font-size:11px; color:#666; margin: 8px 0 5px 0;">
                    ${!item.isEditing ? `æ‹…å½“: ${item.startUser} ${item.stopUser ? `â†’ ${item.stopUser}` : ''} | ` : ''}
                    é–‹å§‹: ${new Date(item.created_at).toLocaleString('ja-JP')}
                </div>

                <div style="background:#f8f9fa; border:1px solid #dee2e6; padding:10px; border-radius:6px;">
                    <div style="${isOver ? 'color:var(--stop);' : ''} display:flex; align-items:center;">
                        ${dateHtml} <span style="font-size:1.5rem; font-weight:800; margin:0 5px;">${targetDate.getHours()}:${String(targetDate.getMinutes()).padStart(2,'0')}</span>
                    </div>
                </div>

                <div class="item-btns" style="margin-top:10px;">
                    ${item.isEditing ? 
                        `<button class="btn-sm btn-blue" onclick="saveEdit(${item.id})">âœ… ä¿å­˜</button>` : 
                        `<button class="btn-sm btn-gray" onclick="toggleEdit(${item.id})">âœï¸ ä¿®æ­£</button>`
                    }
                    ${isMon ? `<button class="btn-sm btn-red" onclick="doStop(${item.id})">ğŸ›‘ åœæ­¢</button>` : ''}
                    <button class="btn-sm btn-gray" onclick="doDelete(${item.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            </div>
        `;
        listDiv.appendChild(div);
    });

    const alertEl = document.getElementById('top-alert');
    if (alertEl) alertEl.style.display = activeCount > 0 ? 'block' : 'none';
}

    function toggleEdit(id) { monitorItems.find(i => i.id === id).isEditing = true; updateMonitorList(); }
    // --- ä¿®æ­£ä¿å­˜ ---
    async function saveEdit(id) {
        const item = monitorItems.find(i => i.id === id);
        const facility = document.getElementById(`edit-f-${id}`).value;
        const startUser = document.getElementById(`edit-u-${id}`).value;
        const stopUser = item.status === 'completed' ? document.getElementById(`edit-su-${id}`).value : "";

        const body = {
            gid: document.getElementById('gid').value,
            gpw: document.getElementById('gpw').value,
            poolId: id,
            facility: facility,
            startUser: startUser,
            stopUser: stopUser
        };

        await fetch(`${WORKER_URL}/update-item`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        item.facility = facility;
        item.startUser = startUser;
        if (item.status === 'completed') item.stopUser = stopUser;
        item.isEditing = false;
        updateMonitorList();
    }
    
    // --- åœæ­¢å‡¦ç† (ã“ã“ã‹ã‚‰) ---
    async function doStop(id) {
        const stopUser = document.getElementById('startUser').value || "æœªè¨­å®šè€…";
        if (!confirm("çµ¦æ°´ã‚’åœæ­¢ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
            // æ–°ã—ã„ Worker ã®ä»•æ§˜ (apiFetch) ã§é€šä¿¡
            await apiFetch("/stop", { 
                poolId: id, 
                stopUser: stopUser 
            });
            
            // æˆåŠŸã—ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã«ã™ã‚‹
            location.reload();
        } catch (e) {
            alert("åœæ­¢ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    }
    // --- åœæ­¢å‡¦ç† (ã“ã“ã¾ã§) ---
    
    // å‰Šé™¤å‡¦ç†
    async function doDelete(id) {
        if (!confirm("å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            await apiFetch("/delete", { poolId: id });
            location.reload();
        } catch (e) { alert(e.message); }
    }


    setInterval(updateMonitorList, 30000);

</script>
</body>

</html>























