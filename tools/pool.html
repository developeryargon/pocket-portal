<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ°´ç›£è¦–ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9V96DZHTH1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9V96DZHTH1');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6758339830570094" crossorigin="anonymous"></script>

  <style>
    :root { --main: #4A154B; --active: #ECB22E; --bg: #f4f7f9; --stop: #d32f2f; --alert: #ff5252; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 8px; margin: 0; font-size: 14px; }

    #top-alert{
      background: var(--alert);
      color: white;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      position: sticky;
      top: 58px;
      z-index: 40;
      border-radius: 0 0 10px 10px;
      margin: 0 -8px 10px -8px;
      display: none;
    }

    .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--main); border-left: 4px solid var(--main); padding-left: 8px; }
    .selector-row { display: flex; justify-content: space-around; padding: 8px; background: #eee; border-radius: 8px; align-items: center; margin-top: 10px; }
    .selector-row label { display: flex; align-items: center; font-size: 14px; font-weight: bold; cursor: pointer; color: #333; margin: 0; }
    .selector-row input { width: auto; margin-right: 4px; }
    .tab-group { display: flex; gap: 4px; margin: 10px 0; background: #ddd; padding: 2px; border-radius: 6px; }
    .tab { flex: 1; text-align: center; padding: 8px 4px; font-size: 11px; border-radius: 4px; cursor: pointer; border: none; background: none; font-weight: bold; color: #555; }
    .tab.active { background: white; color: var(--main); }
    .sub-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .sub-toggle button { font-size: 11px; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .sub-toggle button.active { background: #666; color: #fff; border-color: #666; }

    label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 2px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 8px; background: #fff; }
    .grid-3 { display: flex; gap: 4px; }
    .grid-3 div { flex: 1; }

    .result-panel { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 12px; margin: 10px 0; text-align: center; color: #2e7d32; min-height: 110px; display: flex; flex-direction: column; justify-content: center; }
    .finish-time { font-size: 32px; font-weight: bold; display: block; line-height: 1.2; color: #1b5e20; }

    .monitor-item { border-left: 5px solid var(--active); padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .item-btns { display: flex; gap: 5px; margin-top: 8px; }
    .btn-sm { flex: 1; padding: 8px; font-size: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
    .btn-red { background: var(--stop); }
    .btn-blue { background: #2196F3; }
    .btn-gray { background: #777; }
    .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 17px; cursor: pointer; color: white; margin-top: 10px; background: var(--main); }
    .hidden { display: none !important; }

    .danger-alert {
      background: #fff0f0 !important;
      border: 2px solid #ff0000 !important;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { box-shadow: 0 0 0px #ff0000; }
      50% { box-shadow: 0 0 20px #ff0000; }
      100% { box-shadow: 0 0 0px #ff0000; }
    }

    .day-label { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; vertical-align: middle; }
    .label-today { background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; }
    .label-future { background: #f3e5f5; color: #7b1fa2; border: 1px solid #7b1fa2; }

    .monitor-item.finished { padding: 8px 12px; cursor: pointer; background: #fcfcfc; }
  </style>
</head>

<body>
<nav class="bg-white border-b border-slate-200 py-4 px-6 sticky top-0 z-50">
  <div class="container mx-auto" style="max-width:1100px; display:flex; justify-content:space-between; align-items:center;">
    <a href="../index.html" class="flex items-center font-bold text-lg text-blue-700" style="text-decoration:none; display:flex; align-items:center; white-space:nowrap;">
      <span style="margin-right:8px;">ğŸ </span> PocketPortal
    </a>
    <div style="flex:1; text-align:right;">
      <a href="./index.html" class="text-slate-400 hover:text-blue-500 transition-colors" style="text-decoration:none; font-size:10px; margin-left:auto;">
        Webä¾¿åˆ©ãƒ„ãƒ¼ãƒ«é›†ã¸
      </a>
    </div>
  </div>
</nav>

<div id="top-alert">âš ï¸ çµ¦æ°´ç›£è¦–ä¸­</div>

<div class="container" style="max-width: 600px; margin: 0 auto;">
  <div class="card">
    <div class="card">
      <div style="display:flex; gap:4px; align-items:flex-end;">
        <div style="flex:1;">
          <label>åŒæœŸID</label>
          <input type="password" id="gid" placeholder="ID" onfocus="this.type='text'" onblur="this.type='password'">
        </div>
        <div style="flex:1;">
          <label>PASS</label>
          <input type="password" id="gpw" placeholder="PASS" onfocus="this.type='text'" onblur="this.type='password'">
        </div>
        <div style="flex:0.7; margin-bottom:8px;">
          <button id="syncBtn" onclick="loadDataFromKV()" class="btn-sm btn-blue" style="height:40px; width:100%;">åŒæœŸ</button>
        </div>
        <div style="flex:0.5; margin-bottom:8px;">
          <button onclick="toggleConfig()" style="font-size:10px; height:40px; padding:5px;">è¨­å®šâš™</button>
        </div>
      </div>

      <div id="sync-status" style="font-size:11px; color:#666; margin-top:6px;"></div>

      <div id="config-area" class="hidden" style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px;">
        <label>Slack Webhook URL</label>
        <input type="password" id="slackUrl" placeholder="https://hooks.slack.com/..." onfocus="this.type='text'" onblur="this.type='password'">

        <div class="setting-item" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
          <label style="color: var(--main); margin-bottom: 10px; display: block;">ğŸ”” é€šçŸ¥è¨­å®šï¼ˆåˆæœŸå€¤ã¨ã—ã¦ä¿å­˜å¯èƒ½ï¼‰</label>

          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="at0_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´äºˆå®šæ™‚åˆ»ã«é€šçŸ¥</span>
          </div>

          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="m_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´ã® <input type="number" id="m_val" value="10" style="width:45px; padding:2px;"> åˆ†å‰ã«äºˆå‘Š</span>
          </div>

          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="p_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">æº€æ°´ã‹ã‚‰ <input type="number" id="p_val" value="5" style="width:45px; padding:2px;"> åˆ†éããŸã‚‰è­¦å‘Š</span>
          </div>

          <div style="display:flex; align-items:center;">
            <input type="checkbox" id="interval_on" style="width:20px; height:20px;">
            <span style="margin-left:8px;">è¶…éä¸­ <input type="number" id="interval_val" value="10" style="width:45px; padding:2px;"> åˆ†ãŠãã«å†é€šçŸ¥</span>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:5px;">
          <a href="user_reg.html" style="font-size:11px; color:#2196F3;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/PASSç™»éŒ²ç”»é¢ã¸</a>
          <a href="help.html" style="font-size:11px; color:#2196F3;">â“ ãƒ˜ãƒ«ãƒ—</a>
        </div>
        <button onclick="saveInitialData()" class="btn-sm btn-blue" style="margin-top:10px; width:100%;">ã“ã®è¨­å®šã‚’åˆæœŸå€¤ã¨ã—ã¦ç™»éŒ²</button>
      </div>

      <div class="selector-row">
        <label><input type="radio" name="unit" value="ã¥" checked onchange="convertVolUnit('ã¥')"> ã¥</label>
        <label><input type="radio" name="unit" value="â„“" onchange="convertVolUnit('â„“')"> â„“</label>
        <label><input type="radio" name="unit" value="t" onchange="convertVolUnit('t')"> t</label>
        <div style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></div>
        <label><input type="radio" name="t_unit" value="åˆ†" onchange="convertTimeUnit('åˆ†')"> /åˆ†</label>
        <label><input type="radio" name="t_unit" value="æ™‚" checked onchange="convertTimeUnit('æ™‚')"> /æ™‚</label>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸŒŠ çµ¦æ°´ç™»éŒ²</h3>

    <div class="tab-group">
      <button id="tab-size" class="tab active" onclick="setMode('size')">ã‚µã‚¤ã‚ºå…¥åŠ›</button>
      <button id="tab-vol" class="tab" onclick="setMode('vol')">æ°´é‡ç›´æ¥</button>
      <button id="tab-time" class="tab" onclick="setMode('time')">æ—¥æ™‚ãƒ»æ™‚é–“æŒ‡å®š</button>
    </div>

    <div id="flow-input-area">
      <label id="flowLabel">çµ¦æ°´èƒ½åŠ› (ã¥/æ™‚)</label>
      <input type="number" id="flowRate" value="18" oninput="uiCalc()">
    </div>

    <div id="mode-size">
      <div class="grid-3">
        <div><label>é•·ã•(m)</label><input type="number" id="L" value="25" oninput="uiCalc()"></div>
        <div><label>å¹…(m)</label><input type="number" id="W" value="12" oninput="uiCalc()"></div>
        <div><label>æ·±ã•(m)</label><input type="number" id="D" value="1.2" oninput="uiCalc()"></div>
      </div>
      <label>ç¾åœ¨é‡ (%)</label>
      <input type="number" id="currentPer" value="0" oninput="uiCalc()">
    </div>

    <div id="mode-vol" class="hidden">
      <label id="manualVolLabel">å¿…è¦æ°´é‡ (ã¥)</label>
      <input type="number" id="manualVol" value="360" oninput="uiCalc()">
    </div>

    <div id="mode-time" class="hidden">
      <div class="sub-toggle">
        <button id="sub-rel" class="active" onclick="setSubTimeMode('rel')">æ®‹ã‚Šæ™‚é–“</button>
        <button id="sub-abs" onclick="setSubTimeMode('abs')">å®Œäº†æ—¥æ™‚ã§æŒ‡å®š</button>
      </div>

      <div id="time-rel-area">
        <div class="grid-3">
          <div style="flex:1;"><label>æ™‚é–“</label><input type="number" id="manualHrs" value="5" oninput="uiCalc()"></div>
          <div style="flex:1;"><label>åˆ†</label><input type="number" id="manualMin" value="0" oninput="uiCalc()"></div>
        </div>
      </div>

      <div id="time-abs-area" class="hidden">
        <div class="grid-3">
          <div style="flex:1.5;"><label>å®Œäº†æ—¥</label><input type="date" id="absDate" onchange="uiCalc()"></div>
          <div><label>æ™‚</label><select id="absHour" onchange="uiCalc()"></select></div>
          <div><label>åˆ†</label><select id="absMin" onchange="uiCalc()"></select></div>
        </div>
      </div>
    </div>

    <div class="result-panel">
      <span id="finishDate" style="font-weight:bold;">----/--/--</span>
      <span id="finishClock" class="finish-time">--:--</span>
      <div id="detailRes" style="font-size:13px; font-weight:bold; margin-top:5px;"></div>
    </div>

    <div class="grid-3">
      <div style="flex:2"><label>æ–½è¨­å</label><input type="text" id="facility" placeholder="æ–½è¨­å"></div>
      <div style="flex:1"><label>æ‹…å½“è€…</label><input type="text" id="startUser" placeholder="åå‰"></div>
    </div>
    <button class="btn-main" onclick="doStart()">ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <div id="monitor-list-area" class="card">
    <h3>ğŸ“¡ ç›£è¦–çŠ¶æ³(slackã‚‚ã”ç¢ºèªãã ã•ã„)</h3>
    <div id="monitor-list"></div>
  </div>

  <!-- Bottom Ads (given) -->
  <div class="bottom-ads">
    <p class="text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">Sponsor Link</p>
    <div class="box bg-white p-1 rounded shadow-sm">
      <script type="text/javascript">
        rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770128068587";
      </script>
      <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>

      <script type="text/javascript">
        rakuten_design="slide";rakuten_affiliateId="022cbf82.9ae811c1.06d2eb59.bd2a4ff3";rakuten_items="ranking";rakuten_genreId="0";rakuten_size="300x250";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1770559441426";
      </script>
      <script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
    </div>
  </div>
</div>

<script>
  // ========= å®‰å®šåŒ–ï¼šlocalStorageã‚­ãƒ¼çµ±ä¸€ =========
  const STORAGE_GID = "water_gid";
  const STORAGE_GPW = "water_gpw";
  const STORAGE_LAST_SYNC = "water_last_sync";

  const WORKER_URL = "https://pool-api.nogray.workers.dev/api"; // â˜…è¦æ›¸ãæ›ãˆ

  let currentMode = 'size';
  let subTimeMode = 'rel';
  let lastVolUnit = 'ã¥';
  let lastTimeUnit = 'æ™‚';
  let monitorItems = [];

  // æ—¥æ™‚æŒ‡å®šç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
  const hSelect = document.getElementById('absHour');
  for (let i = 0; i < 24; i++) hSelect.add(new Option(i, i));
  const mSelect = document.getElementById('absMin');
  for (let i = 0; i < 60; i++) mSelect.add(new Option(i, i));

  function toggleConfig() {
    document.getElementById('config-area').classList.toggle('hidden');
  }

  function persistCreds() {
    const gid = document.getElementById('gid')?.value?.trim() || "";
    const gpw = document.getElementById('gpw')?.value?.trim() || "";
    if (gid && gpw) {
      localStorage.setItem(STORAGE_GID, gid);
      localStorage.setItem(STORAGE_GPW, gpw);
    }
  }

  function restoreCredsToInputs() {
    const gid = localStorage.getItem(STORAGE_GID) || "";
    const gpw = localStorage.getItem(STORAGE_GPW) || "";
    if (gid) document.getElementById('gid').value = gid;
    if (gpw) document.getElementById('gpw').value = gpw;
  }

  function safeDate(v) {
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  function pad2(n){ return String(n).padStart(2, "0"); }

  function fmtYMDHM(dateObj) {
    if (!dateObj) return "--:--";
    return `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()} ${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;
  }

  function fmtMDHM(dateObj) {
    if (!dateObj) return "--:--";
    return `${dateObj.getMonth()+1}/${dateObj.getDate()} ${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;
  }

  function updateSyncStatus(ts) {
    const el = document.getElementById('sync-status');
    if (!el) return;

    const d = safeDate(ts);
    if (!d) { el.textContent = ""; return; }

    const now = new Date();
    const today = new Date(now); today.setHours(0,0,0,0);
    const day = new Date(d); day.setHours(0,0,0,0);
    const diffDays = Math.round((day - today) / (1000*60*60*24));

    let label = `<span class="day-label label-future">${d.getMonth()+1}/${d.getDate()}</span>`;
    if (diffDays === 0) label = `<span class="day-label label-today">ä»Šæ—¥</span>`;
    el.innerHTML = `æœ€çµ‚åŒæœŸ: ${label} <b>${pad2(d.getHours())}:${pad2(d.getMinutes())}</b>`;
  }

  // ========= é€šä¿¡ =========
  async function apiFetch(endpoint, payload = {}) {
    // å…¥åŠ›ãŒç©ºã§ã‚‚ã€ä¿å­˜å€¤ã‹ã‚‰å¾©å…ƒã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const gidEl = document.getElementById('gid');
    const gpwEl = document.getElementById('gpw');

    let gid = gidEl.value.trim();
    let gpw = gpwEl.value.trim();

    if (!gid || !gpw) {
      const sgid = localStorage.getItem(STORAGE_GID) || "";
      const sgpw = localStorage.getItem(STORAGE_GPW) || "";
      if (sgid && sgpw) {
        gid = sgid; gpw = sgpw;
        gidEl.value = gid;
        gpwEl.value = gpw;
      }
    }

    if (!gid || !gpw) throw new Error("è¨­å®šã‹ã‚‰IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const response = await fetch(`${WORKER_URL}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ gid, gpw, ...payload })
    });

    if (!response.ok) throw new Error(await response.text());
    return await response.json();
  }

  // ========= è¨­å®šä¿å­˜ =========
  async function saveInitialData() {
    persistCreds();
    const configPayload = {
      webhook: document.getElementById('slackUrl').value,
      facility: document.getElementById('facility').value,
      startUser: document.getElementById('startUser').value,
      unit_vol: document.querySelector('input[name="unit"]:checked').value,
      unit_time: document.querySelector('input[name="t_unit"]:checked').value,
      default_flow: document.getElementById('flowRate').value,

      at0: document.getElementById('at0_on').checked,
      m_on: document.getElementById('m_on').checked,
      m_val: document.getElementById('m_val').value,
      p_on: document.getElementById('p_on').checked,
      p_val: document.getElementById('p_val').value,
      interval_on: document.getElementById('interval_on').checked,
      interval_val: document.getElementById('interval_val').value,

      L: document.getElementById('L').value,
      W: document.getElementById('W').value,
      D: document.getElementById('D').value,
      manualVol: document.getElementById('manualVol').value,
      currentMode: currentMode
    };

    try {
      await apiFetch("/save-config", { configPayload });
      alert("åˆæœŸå€¤ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
    } catch (e) {
      alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
  }

  // ========= å˜ä½å¤‰æ› =========
  function convertVolUnit(newUnit) {
    const inputs = ['flowRate', 'manualVol'];
    inputs.forEach(id => {
      let val = parseFloat(document.getElementById(id).value);
      if (isNaN(val)) return;
      let m3Val = (lastVolUnit === 'â„“') ? val / 1000 : val;
      document.getElementById(id).value = (newUnit === 'â„“') ? (m3Val * 1000) : m3Val;
    });
    lastVolUnit = newUnit;
    uiCalc();
  }

  function convertTimeUnit(newUnit) {
    if (lastTimeUnit === newUnit) return;
    let val = parseFloat(document.getElementById('flowRate').value);
    if (!isNaN(val)) {
      if (newUnit === 'åˆ†') document.getElementById('flowRate').value = (val / 60).toFixed(2);
      else document.getElementById('flowRate').value = (val * 60).toFixed(1);
    }
    lastTimeUnit = newUnit;
    uiCalc();
  }

  function setMode(m) {
    currentMode = m;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + m).classList.add('active');
    ['mode-size', 'mode-vol', 'mode-time'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('mode-' + m).classList.remove('hidden');
    document.getElementById('flow-input-area').classList.toggle('hidden', m === 'time');
    uiCalc();
  }

  function setSubTimeMode(sm) {
    subTimeMode = sm;
    document.getElementById('sub-rel').classList.toggle('active', sm === 'rel');
    document.getElementById('sub-abs').classList.toggle('active', sm === 'abs');
    document.getElementById('time-rel-area').classList.toggle('hidden', sm === 'abs');
    document.getElementById('time-abs-area').classList.toggle('hidden', sm === 'rel');
    if (sm === 'abs') {
      const now = new Date();
      document.getElementById('absDate').value = now.toISOString().split('T')[0];
      document.getElementById('absHour').value = now.getHours();
      document.getElementById('absMin').value = now.getMinutes();
    }
    uiCalc();
  }

  // ========= è¨ˆç®— =========
  function uiCalc() {
    const vUnit = document.querySelector('input[name="unit"]:checked').value;
    const tUnit = document.querySelector('input[name="t_unit"]:checked').value;
    document.getElementById('flowLabel').innerText = `çµ¦æ°´èƒ½åŠ› (${vUnit}/${tUnit})`;
    document.getElementById('manualVolLabel').innerText = `å¿…è¦æ°´é‡ (${vUnit})`;

    let totalMins = 0;
    let reqM3 = 0;

    const L = parseFloat(document.getElementById('L').value) || 0;
    const W = parseFloat(document.getElementById('W').value) || 0;
    const D = parseFloat(document.getElementById('D').value) || 0;
    const cur = (parseFloat(document.getElementById('currentPer').value) || 0) / 100;
    const sizeM3 = L * W * D * (1 - cur);

    if (currentMode === 'time') {
      if (subTimeMode === 'rel') {
        totalMins = (parseInt(document.getElementById('manualHrs').value) || 0) * 60 + (parseInt(document.getElementById('manualMin').value) || 0);
      } else {
        const datePart = document.getElementById('absDate').value;
        const h = document.getElementById('absHour').value;
        const m = document.getElementById('absMin').value;
        if (datePart) {
          const target = new Date(`${datePart}T${pad2(h)}:${pad2(m)}:00`);
          const diff = (target - new Date()) / 60000;
          totalMins = Math.max(0, diff);
        }
      }
      reqM3 = sizeM3;
    } else {
      const rawFlow = parseFloat(document.getElementById('flowRate').value) || 0.001;
      let flowMinM3 = (vUnit === 'â„“') ? rawFlow / 1000 : rawFlow;
      if (tUnit === 'æ™‚') flowMinM3 /= 60;

      if (currentMode === 'size') {
        reqM3 = sizeM3;
      } else {
        const iv = parseFloat(document.getElementById('manualVol').value) || 0;
        reqM3 = (vUnit === 'â„“') ? iv / 1000 : iv;
      }

      totalMins = reqM3 / flowMinM3;
    }

    const finish = new Date(Date.now() + totalMins * 60000);
    document.getElementById('finishDate').innerText =
      finish.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
    document.getElementById('finishClock').innerText =
      finish.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

    const dh = Math.floor(totalMins / 60);
    const dm = Math.round(totalMins % 60);
    const m3Text = (isFinite(reqM3) ? reqM3 : 0).toFixed(1);
    const lText = Math.round((isFinite(reqM3) ? reqM3 : 0) * 1000).toLocaleString();
    let volDisp = (vUnit === "â„“") ? `${lText}â„“ (${m3Text}ã¥)` : `${m3Text}ã¥ (${lText}â„“)`;

    document.getElementById('detailRes').innerHTML = `å®Œäº†ã¾ã§: ç´„${dh}æ™‚é–“${dm}åˆ†<br>å¿…è¦é‡: ${volDisp} / ${m3Text}t`;
    return { totalMins, reqM3 };
  }

  // ========= åŒæœŸï¼ˆKV/DBã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‹ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼‰ =========
  async function loadDataFromKV() {
    const btn = document.getElementById('syncBtn');
    const gid = document.getElementById('gid').value.trim();
    const gpw = document.getElementById('gpw').value.trim();
    if (!gid || !gpw) { alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const prevText = btn.innerHTML;
    btn.innerHTML = "åŒæœŸä¸­...";
    btn.disabled = true;

    try {
      persistCreds();

      const data = await apiFetch("/load");

      if (data?.config) {
        const c = data.config;
        document.getElementById('slackUrl').value = c.webhook || "";
        document.getElementById('facility').value = c.facility || "";
        document.getElementById('startUser').value = c.startUser || "";
        document.getElementById('flowRate').value = c.default_flow || "18";

        document.getElementById('at0_on').checked = c.at0 !== false;
        document.getElementById('m_on').checked = !!c.m_on;
        document.getElementById('m_val').value = c.m_val || "10";
        document.getElementById('p_on').checked = !!c.p_on;
        document.getElementById('p_val').value = c.p_val || "5";
        document.getElementById('interval_on').checked = !!c.interval_on;
        document.getElementById('interval_val').value = c.interval_val || "10";

        if (c.L) document.getElementById('L').value = c.L;
        if (c.W) document.getElementById('W').value = c.W;
        if (c.D) document.getElementById('D').value = c.D;
        if (c.manualVol) document.getElementById('manualVol').value = c.manualVol;
        document.getElementById('currentPer').value = "0";

        if (c.currentMode) setMode(c.currentMode);

        if (c.currentMode === 'time') {
          document.getElementById('manualHrs').value = "0";
          document.getElementById('manualMin').value = "0";
          const now = new Date();
          document.getElementById('absDate').value = now.toISOString().split('T')[0];
          document.getElementById('absHour').value = now.getHours();
          document.getElementById('absMin').value = now.getMinutes();
        }
      }

      monitorItems = Array.isArray(data?.pools) ? data.pools : [];
      updateMonitorList();

      const now = Date.now();
      localStorage.setItem(STORAGE_LAST_SYNC, String(now));
      updateSyncStatus(now);

      btn.innerHTML = "âœ… åŒæœŸå®Œäº†";
      btn.style.background = "#2e7d32";
      btn.style.color = "#fff";

      setTimeout(() => {
        btn.innerHTML = prevText;
        btn.style.background = "";
        btn.style.color = "";
        btn.disabled = false;
      }, 1500);

      uiCalc();
    } catch (e) {
      alert("åŒæœŸå¤±æ•—: " + e.message);
      btn.innerHTML = prevText;
      btn.disabled = false;
    }
  }

  // ========= ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ =========
  async function doStart() {
    persistCreds();

    const { totalMins, reqM3 } = uiCalc();
    const limitTime = Date.now() + totalMins * 60000;

    const payload = {
      id: Date.now(),
      facility: document.getElementById('facility').value || "æœªè¨­å®šæ–½è¨­",
      startUser: document.getElementById('startUser').value || "æœªè¨­å®šè€…",
      status: 'active',
      limitTime: limitTime,
      totalVolM3: reqM3,
      webhook: document.getElementById('slackUrl').value,
      settings: {
        at0: document.getElementById('at0_on').checked,
        m: document.getElementById('m_on').checked ? parseInt(document.getElementById('m_val').value) : null,
        p: document.getElementById('p_on').checked ? parseInt(document.getElementById('p_val').value) : null,
        interval: document.getElementById('interval_on').checked ? parseInt(document.getElementById('interval_val').value) : null
      }
    };

    try {
      await apiFetch("/save", { payload });
      alert("ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  }

  // ========= ç›£è¦–ä¸€è¦§æç”»ï¼ˆNaN/undefinedè€æ€§ï¼‰ =========
  function updateMonitorList() {
    const listDiv = document.getElementById('monitor-list');
    listDiv.innerHTML = '';

    let activeCount = 0;

    // ç›£è¦–ä¸­ã‚’ä¸Šã€æ¬¡ã«æ–°ã—ã„é †
    monitorItems.sort((a, b) => ((a?.status === 'active') ? -1 : 1) || ((b?.id || 0) - (a?.id || 0)));

    monitorItems.forEach(item => {
      const status = item?.status || "unknown";
      const isMon = status === 'active';
      if (isMon) activeCount++;

      const facility = item?.facility ?? "æœªè¨­å®šæ–½è¨­";
      const startUser = item?.startUser ?? "æœªè¨­å®šè€…";
      const stopUser = item?.stopUser ?? "";

      const targetTimeMs = item?.limitTimeMs ?? item?.limitTime ?? null;
      const stopTimeMs = item?.stopTimeMs ?? item?.stopTime ?? item?.updated_at ?? null;

      const targetDate = safeDate(isMon ? targetTimeMs : stopTimeMs);
      const isOver = (isMon && targetTimeMs && Date.now() > targetTimeMs);

      const timeStr = targetDate ? `${pad2(targetDate.getHours())}:${pad2(targetDate.getMinutes())}` : `--:--`;
      const closedHistoryStr = targetDate ? fmtYMDHM(targetDate) : `----/--/-- --:--`;

      // é€²æ—ï¼ˆæ°´é‡ï¼‰è¨ˆç®—ï¼šcreated_atãŒç„¡ã„/å£Šã‚Œã¦ã‚‹å ´åˆã¯å‡ºã•ãªã„
      let volHtml = "";
      if (isMon && item?.totalVolM3 && targetTimeMs) {
        const startCandidate = item?.created_at ?? item?.createdAt ?? item?.startTime ?? item?.id;
        const startDate = safeDate(startCandidate);
        const startMs = startDate ? startDate.getTime() : null;
        if (startMs && isFinite(startMs) && startMs < targetTimeMs) {
          const totalMs = targetTimeMs - startMs;
          const elapsedMs = Date.now() - startMs;
          const progress = Math.max(0, Math.min(1, elapsedMs / totalMs));
          const total = Number(item.totalVolM3);
          const currentVol = (total * progress);
          const remainingVol = Math.max(0, total - currentVol);

          volHtml = `
            <div style="margin-top:10px; padding:10px; background:#000; color:#fff; border-radius:6px; border:2px solid #ECB22E;">
              <div style="font-size:12px; color:#ccc;">ç¾åœ¨æ°´é‡ / æ®‹ã‚Š</div>
              <div style="font-size:1.6rem; font-weight:900;">
                ${currentVol.toFixed(1)} <span style="font-size:14px;">mÂ³</span> /
                <span style="color:#ff5252;">${remainingVol.toFixed(1)}</span> <span style="font-size:14px;">mÂ³</span>
              </div>
            </div>`;
        }
      }

      const div = document.createElement('div');
      const isOpen = isMon || item?.isEditing || div.classList.contains('open');
      div.className = `monitor-item ${isMon ? '' : 'finished'} ${isOver ? 'danger-alert' : ''} ${isOpen ? 'open' : ''}`;
      div.style.border = isMon ? "3px solid #000" : "1px solid #ccc";
      div.style.marginBottom = "12px";
      div.style.padding = isOpen ? "12px" : "10px 12px";

      div.onclick = (e) => {
        if (isMon || item?.isEditing || e.target.closest('button') || e.target.closest('input')) return;
        div.classList.toggle('open');
        const detail = div.querySelector('.detail-area');
        const simple = div.querySelector('.simple-area');
        if (div.classList.contains('open')) {
          if (detail) detail.style.display = 'block';
          if (simple) simple.style.display = 'none';
        } else {
          if (detail) detail.style.display = 'none';
          if (simple) simple.style.display = 'flex';
        }
      };

      let html = "";
      if (isOver) {
        html += `<div style="background:#d32f2f; color:white; font-size:14px; text-align:center; margin:-12px -12px 10px -12px; padding:5px; font-weight:bold;">âš ï¸ è¶…éã—ã¦ã„ã¾ã™</div>`;
      }

      if (item?.isEditing) {
        html += `
          <div style="background:#fffbe6; padding:10px; border:2px solid #ECB22E; border-radius:8px;">
            <label style="font-weight:bold; font-size:12px;">æ–½è¨­å</label>
            <input id="edit-f-${item.id}" style="width:100%; font-size:18px; padding:8px; margin-bottom:10px;" value="${facility}">
            <label style="font-weight:bold; font-size:12px;">é–‹å§‹æ‹…å½“è€…</label>
            <input id="edit-u-${item.id}" style="width:100%; font-size:18px; padding:8px; margin-bottom:10px;" value="${startUser}">
            ${!isMon ? `<label style="font-weight:bold; font-size:12px;">çµ‚äº†æ‹…å½“è€…</label>
              <input id="edit-su-${item.id}" style="width:100%; font-size:18px; padding:8px;" value="${stopUser}">` : ''}
          </div>`;
      } else {
        // é–‰ã˜è¡¨ç¤ºï¼ˆå¹´ã‚‚å‡ºã™ï¼‰
        html += `
          <div class="simple-area" style="display:${isOpen ? 'none' : 'flex'}; justify-content:space-between; align-items:center;">
            <b style="font-size:18px; color:#000;">${facility}</b>
            <span style="font-size:14px; color:#666; font-weight:bold;">${closedHistoryStr} ${isMon ? 'çµ¦æ°´ä¸­' : 'åœæ­¢'} â–¼</span>
          </div>`;

        // è©³ç´°
        html += `
          <div class="detail-area" style="display:${isOpen ? 'block' : 'none'};">
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <b style="font-size:22px; color:#000;">${facility}</b>
              <span style="font-size:12px; padding:4px 8px; background:${isMon ? '#000' : '#eee'}; color:${isMon ? '#ECB22E' : '#666'}; font-weight:bold; border-radius:4px;">
                ${isMon ? 'çµ¦æ°´ä¸­' : 'åœæ­¢æ¸ˆ â–²'}
              </span>
            </div>

            <div style="margin-top:10px; background:#f0f0f0; padding:12px; border-radius:8px; border:1px solid #000;">
              <div style="font-size:14px; font-weight:bold; color:#444;">${isMon ? 'æº€æ°´äºˆå®šæ™‚åˆ»' : 'åœæ­¢æ™‚åˆ»'}</div>
              <div style="font-size:2.4rem; font-weight:900; color:#000; line-height:1.1;">${timeStr}</div>
              <div style="font-size:14px; color:#666; font-weight:bold;">${targetDate ? (targetDate.getFullYear()+"/"+(targetDate.getMonth()+1)+"/"+targetDate.getDate()) : "----/--/--"}</div>
              ${volHtml}
            </div>

            <div style="font-size:14px; color:#000; margin-top:10px; font-weight:bold;">
              æ‹…å½“: ${startUser}${stopUser ? ' â†’ ' + stopUser : ''}
            </div>
          </div>`;
      }

      if (isMon || item?.isEditing || isOpen) {
        html += `
          <div class="item-btns" style="display:flex; gap:10px; margin-top:15px;">
            ${item?.isEditing
              ? `<button style="flex:1; padding:12px; font-weight:bold; background:#2196F3; color:white; border:none; border-radius:6px;" onclick="saveEdit(${item.id})">ä¿å­˜</button>`
              : `<button style="flex:1; padding:12px; font-weight:bold; background:#eee; color:#000; border:2px solid #000; border-radius:6px;" onclick="toggleEdit(${item.id})">å†…å®¹ä¿®æ­£</button>`
            }
            ${isMon
              ? `<button style="flex:1; padding:12px; font-weight:bold; background:#d32f2f; color:white; border:none; border-radius:6px;" onclick="doStop(${item.id})">çµ¦æ°´åœæ­¢</button>`
              : `<button style="flex:1; padding:12px; font-weight:bold; background:#2e7d32; color:white; border:none; border-radius:6px;" onclick="doResume(${item.id})">ç›£è¦–å†é–‹</button>`
            }
            <button style="width:50px; background:#fff; border:2px solid #ccc; border-radius:6px;" onclick="doDelete(${item.id})">ğŸ—‘ï¸</button>
          </div>`;
      }

      div.innerHTML = html;
      listDiv.appendChild(div);
    });

    const alertEl = document.getElementById('top-alert');
    if (alertEl) alertEl.style.display = activeCount > 0 ? 'block' : 'none';
  }

  function toggleEdit(id) {
    const it = monitorItems.find(i => i.id === id);
    if (!it) return;
    it.isEditing = true;
    updateMonitorList();
  }

  async function saveEdit(id) {
    persistCreds();
    const item = monitorItems.find(i => i.id === id);
    if (!item) return;

    const facility = document.getElementById(`edit-f-${id}`).value;
    const startUser = document.getElementById(`edit-u-${id}`).value;
    const stopUser = item.status === 'completed' ? document.getElementById(`edit-su-${id}`).value : "";

    const body = {
      gid: document.getElementById('gid').value,
      gpw: document.getElementById('gpw').value,
      poolId: id,
      facility,
      startUser,
      stopUser
    };

    await fetch(`${WORKER_URL}/update-item`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    item.facility = facility;
    item.startUser = startUser;
    if (item.status === 'completed') item.stopUser = stopUser;
    item.isEditing = false;
    updateMonitorList();
  }

  async function doStop(id) {
    persistCreds();
    const stopUser = document.getElementById('startUser')?.value || "æœªè¨­å®šè€…";
    if (!confirm("çµ¦æ°´ã‚’åœæ­¢ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

    try {
      await apiFetch("/stop", { poolId: id, stopUser });
      location.reload();
    } catch (e) {
      alert("åœæ­¢ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
  }

  async function doDelete(id) {
    persistCreds();
    if (!confirm("å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
      await apiFetch("/delete", { poolId: id });
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  }

  async function doResume(id) {
    persistCreds();
    if (!confirm("ã“ã®ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆé€šçŸ¥è¨­å®šã‚‚ç¶™ç¶šã•ã‚Œã¾ã™ï¼‰")) return;
    try {
      await apiFetch("/resume", { poolId: id });
      alert("ç›£è¦–ã‚’å†é–‹ã—ã¾ã—ãŸã€‚");
      location.reload();
    } catch (e) {
      alert("å†é–‹ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
  }

  // ========= åˆå›ãƒ­ãƒ¼ãƒ‰ï¼ˆ1ã¤ã«çµ±ä¸€ï¼‰ =========
  window.addEventListener('load', async () => {
    restoreCredsToInputs();

    const last = localStorage.getItem(STORAGE_LAST_SYNC);
    if (last) updateSyncStatus(Number(last));

    // ä¿å­˜ã•ã‚ŒãŸID/PASSãŒã‚ã‚Œã°è‡ªå‹•åŒæœŸï¼ˆç›£è¦–ä¸­ãŒå¸¸ã«è¦‹ãˆã‚‹ï¼‰
    const gid = document.getElementById('gid').value.trim();
    const gpw = document.getElementById('gpw').value.trim();
    if (gid && gpw) {
      try {
        await loadDataFromKV();
      } catch (_) {}
    } else {
      uiCalc();
    }

    // 30ç§’ã”ã¨æ›´æ–°ï¼ˆæç”»ã®ã¿ï¼‰
    setInterval(updateMonitorList, 30000);
  });
</script>
</body>
</html>
